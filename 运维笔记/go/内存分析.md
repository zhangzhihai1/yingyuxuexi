[TOC]

# 1.map

ä»**å†…å­˜çš„è§’åº¦**æ¥åˆ†æ Go ä¸­ `map` çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š

- åˆå§‹åŒ–ä¸€ä¸ª map
- æ’å…¥ key=1,2 å’Œ value=3,4
- ä»£ç æ€ä¹ˆèµ°çš„
- åˆ›å»ºäº†å“ªäº›ç»“æ„ä½“
- å†…å­˜ä¸­æœ€ç»ˆä¿å­˜çš„æ˜¯ä»€ä¹ˆ

æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†æè¿™ä¸ªè¿‡ç¨‹ï¼Œå°½é‡è´´è¿‘åº•å±‚å®ç°ï¼ˆå‚è€ƒ Go æºç ä¸­çš„ `runtime/map.go`ï¼‰ã€‚

---

## ğŸ§ª ç¤ºä¾‹ä»£ç 

```go
package main

func main() {
    m := make(map[int]int)
    m[1] = 3
    m[2] = 4
}
```

æˆ‘ä»¬è¦ç†è§£è¿™æ®µä»£ç åœ¨è¿è¡Œæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥åŠå†…å­˜ä¸­æœ€ç»ˆæ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„ã€‚

---

## ğŸ” ç¬¬ä¸€æ­¥ï¼š`make(map[int]int)` â€”â€” åˆå§‹åŒ– map

### âœ… è°ƒç”¨å‡½æ•°ï¼š
Go ç¼–è¯‘å™¨ä¼šå°† `make(map[int]int)` è½¬æ¢ä¸ºè°ƒç”¨è¿è¡Œæ—¶å‡½æ•°ï¼š

```go
m := runtime.makemap(maptype, hint, nil)
```

å…¶ä¸­ï¼š
- `maptype` æ˜¯ç±»å‹ä¿¡æ¯ï¼ˆint -> intï¼‰
- `hint = 0` è¡¨ç¤ºæ²¡æœ‰æŒ‡å®šåˆå§‹å®¹é‡
- ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ `hmap` ç»“æ„ä½“æŒ‡é’ˆï¼Œä¼  nil è¡¨ç¤ºæ–°å»ºä¸€ä¸ª

---

### âœ… åˆ›å»º `hmap` ç»“æ„ä½“

Go åœ¨å †ä¸Šåˆ†é…äº†ä¸€ä¸ª `hmap` ç»“æ„ä½“ï¼Œå®ƒåŒ…å«å¦‚ä¸‹å­—æ®µï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```go
type hmap struct {
    count     int          // å½“å‰å…ƒç´ ä¸ªæ•°
    B         uint8        // log2(bucketsæ•°é‡)ï¼Œå³ buckets æ•°é‡ = 2^B
    hash0     uint32       // å“ˆå¸Œç§å­
    buckets   unsafe.Pointer // æŒ‡å‘ bucket æ•°ç»„çš„èµ·å§‹åœ°å€
    ...
}
```

æ­¤æ—¶ï¼š
- `count = 0`
- `B = 0` â†’ buckets æ•°é‡ä¸º `2^0 = 1`
- `buckets` ä¼šæŒ‡å‘ä¸€ä¸ªæ–°åˆ†é…çš„ bucket æ•°ç»„ï¼ˆå¤§å°ä¸º 1ï¼‰

---

### âœ… åˆ†é… bucket æ•°ç»„

Go ä¼šæ ¹æ® `B` å€¼åˆ†é…ä¸€ä¸ª bucket æ•°ç»„ï¼š

- å› ä¸ºæˆ‘ä»¬æ²¡æŒ‡å®šå®¹é‡ï¼Œæ‰€ä»¥ `B = 0`ï¼Œåªåˆ†é…ä¸€ä¸ª bucket
- æ¯ä¸ª bucket æ˜¯ä¸€ä¸ª `bmap` ç±»å‹çš„ç»“æ„ä½“ï¼ˆå®šä¹‰åœ¨æºç ä¸­ï¼‰

```go
type bmap struct {
    tophash [8]uint8   // å­˜å‚¨ hash é«˜ä½
    // keys å’Œ values ä¸æ˜¾å¼å£°æ˜ï¼Œè€Œæ˜¯é€šè¿‡åç§»è®¿é—®
    // overflow uintptr // æº¢å‡ºæ¡¶æŒ‡é’ˆ
}
```

> å®é™…ä¸Šï¼Œbucket çš„å¤§å°å–å†³äº key å’Œ value çš„å¤§å°ã€‚å¯¹äº `int` ç±»å‹ï¼Œæ¯ä¸ª bucket å¯ä»¥å­˜å‚¨æœ€å¤š 8 å¯¹ key/valueã€‚

æ­¤æ—¶å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š

```
hmap:
 â””â”€â”€ count = 0
 â””â”€â”€ B = 0
 â””â”€â”€ hash0 = éšæœºå€¼ï¼ˆé˜²å“ˆå¸Œç¢°æ’æ”»å‡»ï¼‰
 â””â”€â”€ buckets â”€â”
              â†“
bucket[0]:
 â””â”€â”€ tophash: [8]byte ï¼ˆæœªåˆå§‹åŒ–ï¼‰
 â””â”€â”€ keys:    [8]int ï¼ˆæœªåˆå§‹åŒ–ï¼‰
 â””â”€â”€ values:  [8]int ï¼ˆæœªåˆå§‹åŒ–ï¼‰
 â””â”€â”€ overflow: nil
```

---

## ğŸ§± ç¬¬äºŒæ­¥ï¼šæ’å…¥ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ `m[1] = 3`

### âœ… è®¡ç®— hashï¼š

Go ä½¿ç”¨ç±»å‹è‡ªå¸¦çš„ hash å‡½æ•°è®¡ç®— key çš„ hash å€¼ï¼š

```go
hash := alg.hash(1, h.hash0)
```

å‡è®¾ hash å€¼ä¸º `0x123456789ABCDEF0`ï¼Œå–é«˜ä½ä¸º `0x12`ï¼Œå¹¶ä¿å­˜åˆ° bucket çš„ `tophash[0]`ã€‚

ç„¶åä½¿ç”¨ hash å€¼å†³å®šè¯¥ key åº”è¯¥æ”¾åœ¨å“ªä¸ª bucket ä¸­ï¼š

```go
bucket_index = hash & (BUCKET_COUNT - 1) = 0x12345678 & (1 - 1) = 0
```

å› ä¸ºå½“å‰åªæœ‰ 1 ä¸ª bucketï¼Œæ‰€ä»¥æ”¾åˆ° bucket[0] ä¸­ã€‚

### âœ… æ’å…¥ key=1 åˆ° bucket[0]

- å°† `key=1` æ”¾å…¥ `keys[0]`
- å°† `value=3` æ”¾å…¥ `values[0]`
- å°† hash çš„é«˜ 8 ä½ï¼ˆå¦‚ `0x12`ï¼‰æ”¾å…¥ `tophash[0]`

æ­¤æ—¶å†…å­˜çŠ¶æ€å¦‚ä¸‹ï¼š

```
hmap:
 â””â”€â”€ count = 1
 â””â”€â”€ B = 0
 â””â”€â”€ buckets â”€â”
              â†“
bucket[0]:
 â””â”€â”€ tophash[0] = 0x12
 â””â”€â”€ keys[0] = 1
 â””â”€â”€ values[0] = 3
 â””â”€â”€ overflow = nil
```

---

## ğŸ§± ç¬¬ä¸‰æ­¥ï¼šæ’å…¥ç¬¬äºŒä¸ªé”®å€¼å¯¹ `m[2] = 4`

åŒæ ·æµç¨‹ï¼š

- è®¡ç®— hash å€¼ï¼ˆå‡è®¾ä¸º `0x23456789ABCDEF01`ï¼‰ï¼Œé«˜ä½ä¸º `0x23`
- ç¡®å®š bucket index = 0ï¼ˆè¿˜æ˜¯ bucket[0]ï¼‰
- bucket[0] è¿˜æœ‰ç©ºé—´ï¼ˆç›®å‰åªç”¨äº†ç¬¬ 0 ä¸ª slotï¼‰ï¼Œå¯ä»¥ç»§ç»­æ’å…¥

ç»“æœå¦‚ä¸‹ï¼š

```
hmap:
 â””â”€â”€ count = 2
 â””â”€â”€ B = 0
 â””â”€â”€ buckets â”€â”
              â†“
bucket[0]:
 â””â”€â”€ tophash[0] = 0x12
 â””â”€â”€ tophash[1] = 0x23
 â””â”€â”€ keys[0] = 1
 â””â”€â”€ keys[1] = 2
 â””â”€â”€ values[0] = 3
 â””â”€â”€ values[1] = 4
 â””â”€â”€ overflow = nil
```

---

## ğŸ§  æ€»ç»“ï¼šæ•´ä¸ªè¿‡ç¨‹å†…å­˜çš„å˜åŒ–

| æ­¥éª¤                | å†…å­˜æ“ä½œ                            |
| ------------------- | ----------------------------------- |
| `make(map[int]int)` | åˆ›å»º `hmap` ç»“æ„ä½“ï¼Œåˆ†é…ä¸€ä¸ª bucket |
| `m[1]=3`            | æ’å…¥åˆ° bucket[0] çš„ç¬¬ä¸€ä¸ªä½ç½®       |
| `m[2]=4`            | æ’å…¥åˆ° bucket[0] çš„ç¬¬äºŒä¸ªä½ç½®       |

---

## ğŸ“¦ æœ€ç»ˆå†…å­˜ç»“æ„å›¾ï¼ˆç®€åŒ–ï¼‰

```
hmap:
 â””â”€â”€ count = 2
 â””â”€â”€ B = 0
 â””â”€â”€ buckets â”€â”€â†’ [bucket0]
 â””â”€â”€ hash0 = éšæœºç§å­

bucket0:
 â””â”€â”€ tophash = [0x12, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
 â””â”€â”€ keys = [1, 2, 0, 0, 0, 0, 0, 0]
 â””â”€â”€ values = [3, 4, 0, 0, 0, 0, 0, 0]
 â””â”€â”€ overflow = nil
```

---

## ğŸ’¡ æ‰©å±•çŸ¥è¯†ï¼šå¦‚æœ bucket æ»¡äº†æ€ä¹ˆåŠï¼Ÿ

å½“ bucket çš„ 8 ä¸ªæ§½éƒ½æ»¡äº†ï¼š

- Go ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æº¢å‡º bucketï¼ˆoverflow bucketï¼‰
- å¹¶é€šè¿‡ `overflow` æŒ‡é’ˆè¿æ¥èµ·æ¥ï¼Œå½¢æˆé“¾è¡¨ç»“æ„

ä¾‹å¦‚ï¼š

```
bucket0:
 â””â”€â”€ ... full ...
 â””â”€â”€ overflow â”€â†’ new_bucket
```

è¿™æ ·å°±å¯ä»¥æ”¯æŒæ›´å¤š key-value å¯¹ã€‚
