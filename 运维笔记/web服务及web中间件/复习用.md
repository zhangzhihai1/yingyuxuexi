# 1.keepalived

```powershell
Keepalived 的虚拟服务是基于 VRRP（虚拟路由冗余协议）实现的一种高可用服务解决方案

MTBF(Mean Time Between Failure),即平均故障间隔时间，表示产品多长时间出现一次问题
MTTR(Mean Time To Restoration)，即平均恢复时间,表示产品从故障状态到稳定状态的维修花费时间。

VRRP允许多个物理路由器（或服务器）共享一个虚拟 IP（VIP），对外表现为一个“虚拟路由器”，从而实现主备热备份。
```

作用（保证lb服务的高可用）

绑定同网卡网段

```powershell
VIP 漂移（高可用性）
通过 VRRP 协议（Virtual Router Redundancy Protocol）实现主备切换
类似“两个机器一起竞选虚拟路由器”，谁是 master 谁就绑定 VIP

配合 LVS 做负载均衡
配置 virtual_server 和 real_server，使用内核的 IPVS 模块实现流量分发
```

配置文件（直接在模版基础上修改）

```powershell
global_defs （必须，可以不动）
router_id LVS_DEVEL # 每个keepalived主机唯一标识，建议使用当前主机名

vrrp_instance（修改）
主备/网卡接口/优先级/虚拟路由id/advert_int 1（vrrp通告时间默认1秒，通知自己活着）
虚拟ip:真实ip

include /path/file子配置
```

```powershell
默认 keepalived的日志记录在LOG_DAEMON中，记录在/var/log/syslog或messages, 也支持自定义日志配置
```

抢占与非抢占

```powershell
默认为抢占模式 preempt
非抢占模式 nopreempt ，即高优先级主机恢复后，并不会抢占低优先级主机的  master 角色，必须将各 Keepalived 服务器 state 配置为 BACKUP
抢占延迟模式 preempt_delay 300，即优先级高的主机恢复后，不会立即抢回VIP，而是延迟一段时间（默认300s）再抢回  VIP
```

多播单播

```powershell
多播（组播）vrrp_mcast_group4：默认工作方式，通过一个固定的 VRRP 多播地址交换心跳与选举包。会造成网络拥塞，可以设置为单播，减少网络流量。
global_defs {
    router_id kpmaster
    # 自定义多播地址（不写则默认 224.0.0.18）
    vrrp_mcast_group4 226.0.0.18
}


单播：同时配置，单播生效，在vrrp_instance下，常用于多播被禁用的环境（比如云服务器、跨 VLAN 场景）
    # 启用单播模式
    unicast_src_ip 192.168.8.11          # 本机IP
    unicast_peer {
        192.168.8.12
        192.168.8.13  # 对端IP（备节点）
    }
```

邮件

```powershell
先配置邮件
notify_master "/etc/keepalived/send_message_by_email.sh master"
notify_backup "/etc/keepalived/send_message_by_email.sh backup"
notify_fault "/etc/keepalived/send_message_by_email.sh fault"
```

脑裂

```powershell
原因：网络故障（网络模型，防火墙之类）/配置不当/节点故障
脑裂保护机制不完善：没有正确配置或启用如 STONITH（Shoot The Other Node In The Head）等脑裂保护机制解决
```



多主

```powershell
就是每台节点都会运行一主一备，这两不为主备，和另一台节点互为主备
没什么实际应用价值，本身keepalived就给负载均衡做高可用，多主对外统一入口还得来个负载均衡
第一层负载均衡->多主高可用负载均衡

后端服务高可用也不需要keepalived，直接用k8se就够了，除非是裸机部署，连服务注册都没有
```

| 组件           | 作用                   | 数据流向                                      |
| -------------- | ---------------------- | --------------------------------------------- |
| 第一层负载均衡 | 统一入口，流量分发     | 接收客户端请求，分发到多主负载均衡VIP         |
| Keepalived     | VRRP，VIP高可用管理    | 只管理 VIP 主备切换，不处理业务数据           |
| Nginx（多主）  | 反向代理，业务请求处理 | 通过本机网卡直接接收VIP流量，处理并转发到后端 |

虚拟服务

```powershell
lvs配置，实际就是四层负载均衡，只不过是高可用lvs
lvs是内核模块，keepalived可以做lvs的“控制面”

sorry_server 备用真实主机，当所有RS失效后，开始启用该后备主机。
real_server 设定后端主机的信息

健康检测
HTTP_GET 以HTTP方式来检查后端主机
TCP_CHECK 以TCP方式来检查后端主机
SMTP_CHECK 以SMTP方式来检查后端主机
DNS_CHECK 以DNS方式来检查后端主机
MISC_CHECK 以MISC方式来检查后端主机
```

其他

```powershell
开启 vrrp_strict（设置为 true）后：
节点只有当自身优先级最高时才保持 Master；如果优先级下降到低于某个备节点，它会主动释放 VIP，让优先级更高的备节点切换成 Master。

自定义资源监控：VRRP script允许用户定义自定义的脚本来监测服务器的运行状态，进而动态调整 VRRP 实例的优先级，以实现更灵活、可靠的高可用性。
（正常情况下三种抢占模式就够了）
```

高性能负载均衡架构

```powershell
keepalived做haproxy高可用
1.haproxy：将流量负载均衡给nginx或后端服务器
nginx：专注web静态资源服务和缓存
2.haproxy做第一层负载均衡，nginx做第二层负载均衡
```

