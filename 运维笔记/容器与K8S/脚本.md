# 1.docker

## 1.1docker在线离线安装

自己经常使用阿里云https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.57e31b11NPlZjv

```powershell
#!/bin/bash

# 设置 Docker 版本变量
DOCKER_VERSION=26.1.4
# 可选的 Docker 版本
#DOCKER_VERSION=26.0.0
#DOCKER_VERSION=24.0.7
#DOCKER_VERSION=24.0.5
#DOCKER_VERSION=23.0.3
#DOCKER_VERSION=20.10.19

# 设置镜像源 URL
URL=https://mirrors.tuna.tsinghua.edu.cn
#URL=https://mirrors.aliyun.com
#URL=https://download.docker.com

# 定义颜色输出函数
color () {
	RES_COL=60                          # 结果信息显示在第60列位置
	MOVE_TO_COL="echo -en \\033[${RES_COL}G"  # 移动光标到第60列的命令
	SETCOLOR_SUCCESS="echo -en \\033[1;32m"   # 设置成功颜色为绿色
	SETCOLOR_FAILURE="echo -en \\033[1;31m"   # 设置失败颜色为红色  
	SETCOLOR_WARNING="echo -en \\033[1;33m"   # 设置警告颜色为黄色
	SETCOLOR_NORMAL="echo -en \E[0m"          # 重置为正常颜色
    
    echo -n "$1" && $MOVE_TO_COL      #调函数传参
    echo -n "["
    
    if [ $2 = "success" -o $2 = "0" ] ;then
        ${SETCOLOR_SUCCESS}
        echo -n $" OK "    
    elif [ $2 = "failure" -o $2 = "1" ] ;then 
        ${SETCOLOR_FAILURE}
        echo -n $"FAILED"
    else
        ${SETCOLOR_WARNING}
        echo -n $"WARNING"
    fi
    
    ${SETCOLOR_NORMAL}
    echo -n "]"
    echo
}

# 准备 Docker 安装包
prepare () {
    if [ ! -e docker-${DOCKER_VERSION}.tgz ];then
        # 下载 Docker 二进制包
        wget ${URL}/docker-ce/linux/static/stable/x86_64/docker-${DOCKER_VERSION}.tgz -O docker-${DOCKER_VERSION}.tgz
        if [ $? -ne 0 ]; then
            color "Docker 安装包下载失败" 1
            exit 1
        fi
    fi
}

# 安装 Docker 二进制文件
install_docker () {
    # 解压 Docker 二进制包
    tar xf docker-${DOCKER_VERSION}.tgz -C /usr/local/
    
    # 复制 Docker 二进制文件到系统路径
    cp /usr/local/docker/* /usr/local/bin/
    
    # 创建 Docker systemd 服务文件
    cat > /lib/systemd/system/docker.service <<-EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target

[Service]
Type=notify
# 默认不使用 systemd 管理 cgroups，因为委托问题仍然存在
# 且 systemd 目前不支持 Docker 容器所需的 cgroup 功能集
ExecStart=/usr/local/bin/dockerd -H unix://var/run/docker.sock
ExecReload=/bin/kill -s HUP \$MAINPID

# 非零限制会导致由于内核中的记账开销而出现性能问题
# 建议使用 cgroups 进行容器本地记账
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity

# 如果您的 systemd 版本支持，请取消注释 TasksMax
# 只有 systemd 226 及以上版本支持此功能
#TasksMax=infinity

TimeoutStartSec=0
# 设置委托为 yes，这样 systemd 不会重置 Docker 容器的 cgroups
Delegate=yes
# 仅杀死 Docker 进程，而不是 cgroup 中的所有进程
KillMode=process
# 如果 Docker 进程意外退出，则重新启动
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s

[Install]
WantedBy=multi-user.target
EOF
    
    # 重新加载 systemd 配置
    systemctl daemon-reload
}

# 配置 Docker 守护进程
config_docker () {
    # 创建 Docker 配置目录
    mkdir -p /etc/docker
    
    # 创建 Docker 配置文件，设置镜像加速器
    tee /etc/docker/daemon.json <<-'EOF'
{
    "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m",
        "max-file": "3"
    },
    "data-root": "/var/lib/docker",
    "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF
}

# 启动 Docker 服务
start_docker (){
    # 启用并启动 Docker 服务
    systemctl enable --now docker
    
    # 检查 Docker 是否安装成功
    if docker version; then
        color "Docker 安装成功" 0
    else
        color "Docker 安装失败" 1
        exit 1
    fi
}

# 配置 Docker 命令自动补全
config_docker_completion () {
    # 下载 Docker 自动补全脚本
    if wget -P /etc/bash_completion.d http://www.wangxiaochun.com:8888/testdir/docker/docker_completion; then
        # 使自动补全立即生效（可选）
        source /etc/bash_completion.d/docker_completion 2>/dev/null || true
        color "Docker 自动补全配置成功" 0
    else
        color "Docker 自动补全配置失败" 1
    fi
}

# 设置脚本执行选项
set -e  # 任何命令失败即退出脚本

# 主执行流程
main () {
    echo "开始安装 Docker ${DOCKER_VERSION}..."
    
    prepare            # 准备安装包
    install_docker     # 安装 Docker
    config_docker      # 配置 Docker
    start_docker       # 启动 Docker 服务
    
    # 可选：配置自动补全
    read -p "是否配置 Docker 命令自动补全？(y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        config_docker_completion
    fi
    
    echo "Docker 安装完成！"
    echo "版本信息："
    docker --version
}

# 检查是否为 root 用户
if [ "$(id -u)" -ne 0 ]; then
    color "请使用 root 用户运行此脚本" 1
    exit 1
fi

# 执行主函数
main "$@"
```