# 1.SkyWalking

https://skywalking.apache.org/downloads/

https://skywalking.apache.org/docs/

APMåº”ç”¨æ€§èƒ½ç›‘æ§

é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰

![image-20250823174129037](image-20250823174129037.png)

```powershell
Trace
è¡¨ç¤ºä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚é“¾è·¯
åŒ…å«ï¼š
spanï¼šä¸€æ¬¡æ“ä½œçš„è¯¦ç»†è®°å½•   å”¯ä¸€æ ‡è¯†/å¼€å§‹æ—¶é—´/ç»“æŸæ—¶é—´
span_idï¼ˆå”¯ä¸€æ ‡è¯† spanï¼‰
parent_span_idï¼ˆçˆ¶è°ƒç”¨çš„ spanï¼‰
operation nameï¼ˆæ“ä½œåç§°ï¼Œä¾‹å¦‚ GET /api/userï¼‰
start_time / end_time
tagsï¼ˆé¢å¤–å±æ€§ï¼Œä¾‹å¦‚ http.status_code=200ï¼‰

traceæ ‘ï¼šè¡¨ç¤ºä¸€æ¬¡å®Œæ•´çš„åˆ†å¸ƒå¼è¯·æ±‚

Annotationï¼ˆspan contextï¼‰ï¼šä¼ é€’ Trace ä¿¡æ¯çš„â€œèº«ä»½è¯â€ï¼Œä¿è¯è·¨æœåŠ¡èƒ½æ‰¾åˆ°å½¼æ­¤
trace_id
span_id
parent_span_id
é‡‡æ ·æ ‡è®°ï¼ˆæ˜¯å¦é‡‡æ ·ã€è°ƒè¯•æ ‡å¿—ï¼‰
```

```powershell
Aâ†’B   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500ms
  Bâ†’C        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 300ms
     C           â”€â”€â”€â”€â”€â”€ 100ms

| Span | æ€»è€—æ—¶ |è‡ªèº«å¤„ç† |ä¸‹æ¸¸è€—æ—¶|
| ---- | ----- | ----- | ----- |
| Aâ†’B  | 500ms | 200ms | 300ms |
| Bâ†’C  | 300ms | 200ms | 100ms |
| C    | 100ms | 100ms | 0     |

TraceID: 12345
â””â”€â”€ Span A (æœåŠ¡ A å…¥ç«™) start=0ms, end=50ms
     â”œâ”€â”€ Span A->B (A è°ƒç”¨ B) start=5ms, end=30ms
     â”‚     â””â”€â”€ Span B å…¥ç«™ start=10ms, end=25ms
     â”‚           â””â”€â”€ Span B->C start=12ms, end=22ms
     â”‚                 â””â”€â”€ Span C å…¥ç«™ start=13ms, end=20ms
     â””â”€â”€ Span A->D (å¦‚æœæœ‰å…¶ä»–è°ƒç”¨)

å¼‚æ­¥è°ƒç”¨ç¤ºæ„ï¼š
Span A å…¥ç«™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (0-50ms)
 â””â”€ å¼‚æ­¥è°ƒç”¨ B è§¦å‘ (span ä¸é˜»å¡)
 
Span B å…¥ç«™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (60-80ms) ç‹¬ç«‹ spanï¼Œéå­span

æ€ä¹ˆåˆ†æ
1.æ‰“å¼€è°ƒç”¨é“¾ï¼ˆTraceï¼‰è¯¦æƒ…
æ‰¾åˆ°è¿™ä¸ªæ¥å£çš„ TraceId
æŸ¥çœ‹ ç«ç„°å›¾ / æ—¶é—´çº¿
å¯ä»¥çœ‹åˆ°æ¯ä¸ª Span çš„è€—æ—¶å’Œé¡ºåº

2.åˆ†æè€—æ—¶åˆ†å¸ƒ
çˆ¶ Span è€—æ—¶ï¼šæ¥å£æ€»è€—æ—¶
å­ Span è€—æ—¶ï¼šè°ƒç”¨æ•°æ®åº“ / è°ƒç”¨å…¶ä»–æœåŠ¡
è‡ªèº«è€—æ—¶ = çˆ¶ Span æ€»è€—æ—¶ - å­ Span æ€»è€—æ—¶

3.å®šä½æ…¢ç‚¹
å¦‚æœå­ Spanè€—æ—¶å å¤§å¤´ â†’ ä¸‹æ¸¸æ…¢
å¦‚æœå­ Spanè€—æ—¶å°‘ â†’  è‡ªèº«å¤„ç†æ…¢
```

## 1.1ç®€è¿°

åŠŸèƒ½

```powershell
1.é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰
è‡ªåŠ¨æ”¶é›†æœåŠ¡é—´è°ƒç”¨é“¾è·¯ï¼ˆæ”¯æŒ HTTPã€gRPCã€æ•°æ®åº“è°ƒç”¨ç­‰ï¼‰ã€‚
å±•ç¤ºå®Œæ•´è°ƒç”¨è·¯å¾„ã€è€—æ—¶åˆ†å¸ƒã€å¼‚å¸¸ä½ç½®ã€‚

2.åº”ç”¨æ€§èƒ½ç›‘æ§ï¼ˆAPM Metricsï¼‰
JVM æŒ‡æ ‡ï¼ˆGCã€çº¿ç¨‹ã€å†…å­˜ã€ç±»åŠ è½½ã€CPU ä½¿ç”¨ç‡ï¼‰ã€‚
æœåŠ¡/å®ä¾‹çº§åˆ«çš„ååé‡ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ï¼ˆTPSã€RTã€Error Rateï¼‰ã€‚

3.æœåŠ¡æ‹“æ‰‘å›¾ï¼ˆTopologyï¼‰
å±•ç¤ºæœåŠ¡é—´çš„è°ƒç”¨å…³ç³»å’Œæµé‡æƒ…å†µï¼Œæ”¯æŒä¸‹é’»åˆ°æ¥å£çº§åˆ«ã€‚

4.å‘Šè­¦ï¼ˆAlarmï¼‰
æŒ‡æ ‡é˜ˆå€¼å‘Šè­¦ï¼Œä¾‹å¦‚æ¥å£ RT è¶…è¿‡é˜ˆå€¼ã€é”™è¯¯ç‡è¿‡é«˜ã€GC é¢‘ç¹ç­‰ã€‚

5.æ—¥å¿—ä¸ Trace å…³è”ï¼ˆLog + Traceï¼‰
å¯ä»¥å°†åº”ç”¨æ—¥å¿—å’Œ Trace ID å…³è”ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚

6.å¤šå­˜å‚¨æ”¯æŒ
é»˜è®¤æ”¯æŒ ElasticSearchã€PostgreSQLã€MySQLã€H2 ç­‰ã€‚
å¤§è§„æ¨¡ç”Ÿäº§æ¨èç”¨ Elasticsearchï¼Œæ–¹ä¾¿æ¨ªå‘æ‰©å±•ã€‚
```

ç»„ä»¶

```powershell
1.Agentï¼ˆæ¢é’ˆï¼‰
éƒ¨ç½²åœ¨åº”ç”¨è¿›ç¨‹ä¸­ï¼Œè´Ÿè´£é‡‡é›†é“¾è·¯å’ŒæŒ‡æ ‡æ•°æ®ã€‚
Java Agent æ˜¯æœ€å¸¸è§çš„ï¼Œé›¶ä¾µå…¥ï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç ã€‚

2.OAPï¼ˆObservability Analysis Platformï¼‰
åç«¯æ ¸å¿ƒï¼Œè´Ÿè´£æ•°æ®æ¥æ”¶ã€åˆ†æã€å­˜å‚¨ã€‚
å†…éƒ¨æ¨¡å—ï¼šReceiverï¼ˆæ¥æ”¶æ¢é’ˆæ•°æ®ï¼‰ã€Analyzerï¼ˆå¤„ç†æŒ‡æ ‡å’ŒTraceï¼‰ã€Storageï¼ˆå­˜å‚¨åˆ° ESï¼‰ã€‚

3.UIï¼ˆWeb ç•Œé¢ï¼‰
æä¾›è°ƒç”¨é“¾è·¯æŸ¥è¯¢ã€æ‹“æ‰‘å›¾ã€æ€§èƒ½æŒ‡æ ‡å¤§ç›˜ã€å‘Šè­¦æŸ¥çœ‹ç­‰åŠŸèƒ½ã€‚

4.å­˜å‚¨ï¼ˆStorageï¼‰
ç”Ÿäº§å¸¸ç”¨ ElasticSearch ä½œä¸ºå­˜å‚¨ã€‚
```

ä¸€äº›åè¯

```powershell
ç«¯ç‚¹ (Endpoint) â†’æœ€ç»†ç²’åº¦ï¼ŒæŒ‡æœåŠ¡å¯¹å¤–æš´éœ²çš„æŸä¸ª API æˆ–æ–¹æ³•ï¼Œæ¯”å¦‚/api/order/createã€‚

Endpoint çš„ä½œç”¨
1.æ€§èƒ½åˆ†æ
å¯ä»¥ç»Ÿè®¡æ¯ä¸ªæ¥å£çš„ RTã€QPSã€é”™è¯¯ç‡ã€‚

2.ç“¶é¢ˆæ’æŸ¥
å¦‚æœæŸä¸ªæ¥å£å“åº”æ…¢ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å…·ä½“æœåŠ¡ + endpointã€‚

3.å‘Šè­¦è§¦å‘
å¯ä»¥å¯¹ endpoint è®¾ç½®å‘Šè­¦è§„åˆ™ï¼Œæ¯”å¦‚ /api/order/create çš„ RT è¶…è¿‡ 2s å°±å‘Šè­¦ã€‚
```

## 1.2Java

```powershell
æ¥å…¥ Java ç¨‹åºæ—¶ï¼Œä¸€èˆ¬é€šè¿‡ å¯åŠ¨å‚æ•° åŠ è½½ SkyWalking Agent
-javaagent:/opt/skywalking/agent/skywalking-agent.jar  jaråŒ…ç›®å½•
-Dskywalking.agent.service_name=my-java-service      åº”ç”¨æœåŠ¡åï¼ˆåŒºåˆ†ä¸åŒå¾®æœåŠ¡ï¼‰ 
-Dskywalking.collector.backend_service=oap-server:11800    OAPåœ°å€
```

å¸¸ç”¨é…ç½®é¡¹ï¼ˆ`agent/config/agent.config` æˆ– JVM -D å‚æ•°ï¼‰

| é…ç½®é¡¹                         | è¯´æ˜                                     | ç¤ºä¾‹                                  |
| ------------------------------ | ---------------------------------------- | ------------------------------------- |
| `agent.service_name`           | åº”ç”¨æœåŠ¡åï¼ˆåŒºåˆ†ä¸åŒå¾®æœåŠ¡ï¼‰             | `order-service`                       |
| `collector.backend_service`    | OAP åœ°å€                                 | `oap:11800`                           |
| `agent.namespace`              | å‘½åç©ºé—´ï¼Œé€‚åˆå¤šç¯å¢ƒåŒºåˆ†                 | `prod`                                |
| `logging.level`                | Agent æ—¥å¿—çº§åˆ«                           | `INFO / DEBUG`                        |
| `plugin.*`                     | æ’ä»¶å¼€å…³ï¼Œä¾‹å¦‚æ˜¯å¦å¼€å¯ Spring/Redis æ’ä»¶ | `plugin.springmvc.trace_handler=true` |
| `trace.sample_rate`            | é‡‡æ ·ç‡ï¼ˆé»˜è®¤ 10000=100%ï¼‰                | `5000` â†’ 50%                          |
| `agent.span_limit_per_segment` | å•ä¸ª Trace Segment ä¸­æœ€å¤§ Span æ•°        | `300`                                 |
| `agent.instance_name`          | å®ä¾‹åï¼ˆåŒºåˆ† Pod/å®ä¾‹ï¼‰                  | `hostname-pod`                        |

SkyWalking Agent ä¼šè‡ªåŠ¨é‡‡é›†ä»¥ä¸‹æŒ‡æ ‡

```powershell
1.JVM æŒ‡æ ‡

2.æœåŠ¡æ€§èƒ½æŒ‡æ ‡
ååé‡ (Calls per minute, CPM/TPS)
å¹³å‡å“åº”æ—¶é—´ (Avg RT)
é”™è¯¯ç‡ (Error %)

3.è°ƒç”¨é“¾è·¯
è·¨æœåŠ¡ HTTP è°ƒç”¨
SpringMVCã€Spring Boot Controller
Dubbo/gRPC/RabbitMQ/Kafka
æ•°æ®åº“æ“ä½œï¼ˆJDBCã€MyBatisã€Hibernateï¼‰
Redisã€Elasticsearch è°ƒç”¨

4.æ‹“æ‰‘å…³ç³»
æœåŠ¡ â†’ æœåŠ¡è°ƒç”¨é“¾
æ¥å£çº§åˆ«è°ƒç”¨é“¾
DB/Cache ç­‰å¤–éƒ¨ä¾èµ–èŠ‚ç‚¹
```

## 1.3å‘Šè­¦è§„åˆ™

æŒ‡æ ‡åŠå¸¸ç”¨å‘Šè­¦è§„åˆ™

~~~powershell
SkyWalking çš„å‘Šè­¦èƒ½åŠ›å…¶å®æ˜¯åŸºäºå®ƒé‡‡é›†åˆ°çš„ **é“¾è·¯è¿½è¸ª + JVM + æŒ‡æ ‡ç›‘æ§** ç»Ÿä¸€ä½“ç³»æ¥çš„ã€‚å¸¸ç”¨çš„å‘Šè­¦æŒ‡æ ‡å¯ä»¥åˆ†ä¸ºå‡ å¤§ç±»ï¼ˆè¯·æ±‚ã€é”™è¯¯ã€æ€§èƒ½ã€JVM/ä¸»æœºæŒ‡æ ‡ï¼‰ã€‚æˆ‘å¸®ä½ æ¢³ç†ä¸€ä¸‹å¸¸è§å¯ç”¨äºå‘Šè­¦çš„ç»´åº¦å’ŒæŒ‡æ ‡ï¼š
## 1ï¸âƒ£ è¯·æ±‚è°ƒç”¨ç›¸å…³ï¼ˆé“¾è·¯çº§æŒ‡æ ‡ï¼‰
* **Service Levelï¼ˆæœåŠ¡çº§ï¼‰**
  * `service_resp_time`ï¼šæœåŠ¡å¹³å‡å“åº”æ—¶é—´
  * `service_sla`ï¼šæœåŠ¡æˆåŠŸç‡ (Success Rate)
  * `service_cpm`ï¼šæ¯åˆ†é’Ÿè°ƒç”¨é‡ï¼ˆCalls per minuteï¼‰
  * service_percentileï¼šp95,p99ç­‰ç­‰
* **Service Instance Levelï¼ˆå®ä¾‹çº§ï¼‰**
  * `service_instance_resp_time`ï¼šå®ä¾‹å¹³å‡å“åº”æ—¶é—´
  * `service_instance_sla`ï¼šå®ä¾‹æˆåŠŸç‡
  * `service_instance_cpm`ï¼šå®ä¾‹è°ƒç”¨é‡
  
* **Endpoint Levelï¼ˆæ¥å£çº§ï¼‰**
  * `endpoint_avg_resp_time`ï¼šå•æ¥å£å¹³å‡å“åº”æ—¶é—´
  * `endpoint_sla`ï¼šæ¥å£æˆåŠŸç‡
  * `endpoint_cpm`ï¼šæ¥å£è°ƒç”¨é‡
ğŸ‘‰ å¸¸è§å‘Šè­¦è§„åˆ™ï¼š
* æŸä¸ªæœåŠ¡å¹³å‡å“åº”æ—¶é—´ > 200ms
* æŸä¸ªæ¥å£ SLA < 95%
* QPS è¿‡ä½/è¿‡é«˜ï¼ˆæµé‡å¼‚å¸¸ï¼‰

## 2ï¸âƒ£ JVM / å®ä¾‹èµ„æºæŒ‡æ ‡
SkyWalking Agent ä¼šé‡‡é›† JVM åŸºæœ¬è¿è¡ŒæŒ‡æ ‡ï¼š
* `instance_jvm_cpu`ï¼šCPU ä½¿ç”¨ç‡
* `instance_jvm_memory_heap`ï¼šå †å†…å­˜ä½¿ç”¨ç‡
* `instance_jvm_memory_nonheap`ï¼šéå †å†…å­˜ä½¿ç”¨ç‡
* `instance_jvm_gc_time`ï¼šGC è€—æ—¶
* `instance_jvm_gc_count`ï¼šGC æ¬¡æ•°
* `instance_jvm_thread_live_count`ï¼šæ´»åŠ¨çº¿ç¨‹æ•°
* `instance_jvm_thread_daemon_count`ï¼šå®ˆæŠ¤çº¿ç¨‹æ•°
* `instance_jvm_class_loaded_count`ï¼šåŠ è½½ç±»æ•°
ğŸ‘‰ å¸¸è§å‘Šè­¦è§„åˆ™ï¼š
* JVM å †å†…å­˜ä½¿ç”¨ç‡ > 80%
* Full GC æ¬¡æ•°åœ¨ 1 åˆ†é’Ÿå†… > 5 æ¬¡
* CPU ä½¿ç”¨ç‡ > 85%

## 3ï¸âƒ£ æ•°æ®åº“ / MQ / ä¾èµ–è°ƒç”¨æŒ‡æ ‡
SkyWalking ä¼šæŠŠä¸‹æ¸¸ä¾èµ–ï¼ˆDBã€Redisã€MQ ç­‰ï¼‰çš„æ€§èƒ½ä¹Ÿç»Ÿè®¡å‡ºæ¥ï¼š
* `database_resp_time`ï¼šæ•°æ®åº“è°ƒç”¨å¹³å‡å“åº”æ—¶é—´
* `database_sla`ï¼šæ•°æ®åº“è°ƒç”¨æˆåŠŸç‡
* `mq_resp_time`ï¼šæ¶ˆæ¯é˜Ÿåˆ—å“åº”æ—¶é—´
* `mq_sla`ï¼šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸç‡
ğŸ‘‰ å¸¸è§å‘Šè­¦è§„åˆ™ï¼š
* DB å“åº”æ—¶é—´ > 300ms
* MQ æˆåŠŸç‡ < 99%

## 4ï¸âƒ£ è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆMetrics Extensionï¼‰
* ä½ å¯ä»¥é€šè¿‡ **Meter API** æˆ– **Prometheus æ¥å…¥** æŠŠè‡ªå®šä¹‰æŒ‡æ ‡é€è¿› SkyWalkingï¼Œç„¶åç”¨ OALï¼ˆObservability Analysis Languageï¼‰ç¼–å†™è§„åˆ™ã€‚
* æ¯”å¦‚ï¼š
  * ä¸šåŠ¡è®¢å•å¤±è´¥ç‡
  * ç¼“å­˜å‘½ä¸­ç‡
  * é˜Ÿåˆ—ç§¯å‹é•¿åº¦
```
SkyWalking å‘Šè­¦æŒ‡æ ‡ä¸»è¦åˆ†ä¸ºä¸‰å¤§å—ï¼š
1. **é“¾è·¯è°ƒç”¨æ€§èƒ½æŒ‡æ ‡**ï¼ˆå“åº”æ—¶é—´ã€æˆåŠŸç‡ã€QPSï¼‰
2. **JVM/å®ä¾‹èµ„æºæŒ‡æ ‡**ï¼ˆCPUã€å†…å­˜ã€GCã€çº¿ç¨‹ã€ç±»åŠ è½½ï¼‰
3. **ä¸‹æ¸¸ä¾èµ–æŒ‡æ ‡**ï¼ˆDBã€Redisã€MQ å“åº”æ—¶é—´ & æˆåŠŸç‡ï¼‰
4. **è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡**ï¼ˆé€šè¿‡ Meter API/Prometheus æ¥å…¥ï¼‰
~~~

åœ¨uiç•Œé¢é…ç½®

åœ¨é…ç½®æ–‡ä»¶é…ç½®ï¼ˆè¦é‡å¯æˆ–é‡è½½ï¼Œä¸å¤ªè¡Œï¼‰

åœ¨ OAPï¼ˆåç«¯ï¼‰éƒ¨ç½²ç›®å½•ä¸‹çš„ `config/alarm-settings.yml` ä¸­å®šä¹‰è§„åˆ™

```powershell
rules: # å®šä¹‰ruleè§„åˆ™
  service_cpm_rule: # å”¯ä¸€çš„è§„åˆ™åç§°,å¿…é¡»ä»¥_ruleç»“å°¾
    # Metrics value need to be long, double or int
    metrics-name: service_cpm # æŒ‡æ ‡åç§°
    op: ">" # æ“ä½œç¬¦,>, >=, <, <=, ==
    threshold: 1 # æŒ‡æ ‡é˜ˆå€¼
    # The length of time to evaluate the metrics
    period: 2 # è¯„ä¼°æŒ‡æ ‡çš„é—´éš”å‘¨æœŸ
    # How many times after the metrics match the condition, will trigger alarm
    count: 1 # åŒ¹é…æˆåŠŸå¤šå°‘æ¬¡å°±ä¼šè§¦å‘å‘Šè­¦
    # How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.
    #silence-period: 3
    silence-period: 2 # è§¦å‘å‘Šè­¦åçš„é™é»˜æ—¶é—´
    message: dubbo-provider service_cpm å¤§äº1äº† # å‘Šè­¦ä¿¡æ¯

dingtalkHooks:
  textTemplate: |-
    {
      "msgtype": "text",
      "text": {
        "content": "Apache SkyWalking Alarm: \n %s."
      }
    }
webhooks:
  - url: https://oapi.dingtalk.com/robot/send?access_token=b317849c09c2c1dcb5b426c343f696fdadb5aaf087b39144721ebdfcaee8cc83
```

# 2.ceph

ç¨³å®šç‰ˆæœ¬ï¼šx.2.zï¼Œä¸­é—´å¿…é¡»æ˜¯2



## 2.1åŠŸèƒ½ä½œç”¨åŠå·¥ä½œåŸç†

```powershell
å—å­˜å‚¨ï¼šæ ¼å¼åŒ–ä¸ºæŒ‡å®šçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä½¿ç”¨
å¯¹è±¡å­˜å‚¨ï¼šOSS,minio

Ceph æ˜¯ä¸€ä¸ª å¼€æºçš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯ é«˜å¯ç”¨ã€å¼ºæ‰©å±•ã€å»ä¸­å¿ƒåŒ–ã€‚å®ƒèƒ½åœ¨æ™®é€š x86 æœåŠ¡å™¨ç»„æˆçš„é›†ç¾¤ä¸Šï¼Œæä¾› å¯¹è±¡å­˜å‚¨ã€å—å­˜å‚¨ã€æ–‡ä»¶ç³»ç»Ÿ ä¸‰ç§å­˜å‚¨æœåŠ¡ã€‚
```

```powershell
å¥½çš„ï¼Œæˆ‘æ¥ç³»ç»Ÿåœ°å¸®ä½ æ¢³ç†ä¸€ä¸‹ **Ceph çš„åŠŸèƒ½ã€ä½œç”¨ä»¥åŠå·¥ä½œåŸç†**ã€‚
# ğŸ”§ Ceph çš„ä¸»è¦åŠŸèƒ½å’Œä½œç”¨
1. **å¯¹è±¡å­˜å‚¨ï¼ˆRADOSGW, S3/Swift å…¼å®¹ï¼‰**
   * æä¾›ç±»ä¼¼ AWS S3 çš„ RESTful API
   * é€‚åˆäº‘å­˜å‚¨ã€å¤§æ•°æ®ã€æ—¥å¿—å­˜å‚¨

2. **å—å­˜å‚¨ï¼ˆRBD, RADOS Block Deviceï¼‰**
   * å¯ä½œä¸ºè™šæ‹Ÿæœº/å®¹å™¨çš„è™šæ‹Ÿç¡¬ç›˜
   * æ”¯æŒå¿«ç…§ã€å…‹éš†ã€åŠ¨æ€æ‰©å±•
   * å¸¸ç”¨äº OpenStackã€Kubernetes çš„æŒä¹…åŒ–å­˜å‚¨

3. **æ–‡ä»¶å­˜å‚¨ï¼ˆCephFSï¼‰**
   * ä¸€ä¸ª POSIX å…¼å®¹çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ
   * å¤šå®¢æˆ·ç«¯å…±äº«è®¿é—®ï¼Œæ”¯æŒç›®å½•ã€æƒé™

4. **é«˜å¯ç”¨ä¸å®¹é”™**
   * è‡ªåŠ¨å‰¯æœ¬ï¼ˆé€šå¸¸ 3 å‰¯æœ¬ï¼‰æˆ–çº åˆ ç ï¼ˆEC, Erasure Codingï¼‰ä¿è¯æ•°æ®å¯é æ€§
   * èŠ‚ç‚¹å®•æœºæ—¶è‡ªåŠ¨æ•°æ®æ¢å¤

5. **é«˜æ‰©å±•æ€§**
   * æ¨ªå‘æ‰©å±•ï¼Œåªè¦åŠ æœºå™¨å³å¯å¢åŠ å®¹é‡å’Œååé‡
   * æ— å•ç‚¹ç“¶é¢ˆï¼Œç†è®ºä¸Šå¯æ‰©å±•åˆ° **PB/EB çº§**
```

## 2.2æ ¸å¿ƒç»„ä»¶

```powershell
1.MON (Monitorï¼Œç›‘è§†å™¨)
ä½œç”¨ï¼š
ç»´æŠ¤é›†ç¾¤çš„å¥åº·çŠ¶æ€ã€‚
å­˜å‚¨é›†ç¾¤çš„ Cluster Mapï¼ˆåŒ…æ‹¬ OSD åˆ—è¡¨ã€çŠ¶æ€ã€CRUSH Map ç­‰ï¼‰ã€‚
æä¾›é›†ç¾¤çš„å…±è¯†ï¼ˆä½¿ç”¨ Paxos åè®®ï¼‰ã€‚
ç‰¹ç‚¹ï¼š
é€šå¸¸éƒ¨ç½²å¥‡æ•°å°ï¼ˆ3 æˆ– 5ï¼‰ä¿è¯ quorumã€‚
ä¸å­˜å‚¨å®é™…æ•°æ®ï¼Œåªå­˜å…ƒæ•°æ®å’ŒçŠ¶æ€ã€‚

2.OSD (Object Storage Daemonï¼Œå¯¹è±¡å­˜å‚¨å®ˆæŠ¤è¿›ç¨‹)
ä½œç”¨ï¼š
å­˜å‚¨å®é™…çš„æ•°æ®å—ï¼ˆå¯¹è±¡ï¼‰ã€‚
è´Ÿè´£æ•°æ®å¤åˆ¶ã€æ¢å¤ã€å›å¡«ã€å†å¹³è¡¡ã€‚
ç‰¹ç‚¹ï¼š
æ¯å—ç£ç›˜å¯¹åº”ä¸€ä¸ª OSDã€‚
é›†ç¾¤ä¸­ OSD æ•°é‡è¶Šå¤šï¼Œæ€§èƒ½è¶Šå¥½ã€‚
é€šè¿‡ CRUSH ç®—æ³•å†³å®šæ•°æ®çš„åˆ†å¸ƒã€‚

3.MDS (Metadata Serverï¼Œå…ƒæ•°æ®æœåŠ¡å™¨)
ä½œç”¨ï¼š
ä¸º CephFS æä¾›æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®æœåŠ¡ã€‚
å¤„ç†ç›®å½•ç»“æ„ã€æƒé™ã€æ–‡ä»¶åç­‰ä¿¡æ¯ã€‚
ç‰¹ç‚¹ï¼š
åªæœ‰åœ¨ä½¿ç”¨ CephFS æ—¶æ‰éœ€è¦ã€‚
å¯éƒ¨ç½²å¤šå°ï¼Œæ”¯æŒæ´»åŠ¨/å¤‡ç”¨æ¨¡å¼ã€‚

4.RGW (Rados Gateway)
ä½œç”¨ï¼š
æä¾›å¯¹è±¡å­˜å‚¨æ¥å£ï¼ˆå…¼å®¹ S3/Swiftï¼‰ã€‚
ç‰¹ç‚¹ï¼š
å¯ç›´æ¥å¯¹æ¥åº”ç”¨ç¨‹åºã€‚
ä¸è´Ÿè´£æ•°æ®å­˜å‚¨ï¼Œåªæ˜¯æ¥å£å±‚ï¼Œæ•°æ®ä»å­˜äº OSDã€‚

5.å®¢æˆ·ç«¯ (Client)
ä½œç”¨ï¼š
æä¾›è®¿é—® Ceph çš„æ–¹å¼ï¼š
RBDï¼ˆå—å­˜å‚¨ï¼‰
CephFSï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰
RGWï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰
ç‰¹ç‚¹ï¼š
å¯ä»¥æ˜¯ Linux ä¸»æœºæŒ‚è½½ CephFSã€‚
å¯ä»¥æ˜¯äº‘åº”ç”¨é€šè¿‡ S3 API è°ƒç”¨ RGWã€‚

6.CRUSH Map
ä½œç”¨ï¼š
å®šä¹‰æ•°æ®å¦‚ä½•åœ¨ OSD ä¸­åˆ†å¸ƒã€‚
ç‰¹ç‚¹ï¼š
æ— éœ€ä¸­å¿ƒåŒ–ç®¡ç†ï¼Œå®¢æˆ·ç«¯æ ¹æ® CRUSH Map å¯ç›´æ¥å®šä½æ•°æ®ã€‚

7.Mgr (Manager)
ä½œç”¨ï¼š
æä¾›é›†ç¾¤çš„ç®¡ç†åŠŸèƒ½å’Œæ€§èƒ½ç›‘æ§ã€‚
ç”Ÿæˆå’Œæä¾›å›¾å½¢åŒ–æˆ– API å¯ç”¨çš„æŒ‡æ ‡ã€‚
æ”¯æŒ Dashboardã€å‘Šè­¦ã€æ’ä»¶æ‰©å±•ï¼ˆæ¯”å¦‚ Prometheus exporterï¼‰ã€‚
ä¸ MON é…åˆæä¾›é›†ç¾¤çŠ¶æ€ï¼Œä½†ä¸æ˜¯æ•°æ®å­˜å‚¨èŠ‚ç‚¹ã€‚
ç‰¹ç‚¹ï¼š
å»ºè®®è‡³å°‘éƒ¨ç½² 2~3 ä¸ª Mgr èŠ‚ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªä¸º activeï¼Œå…¶ä½™ä¸º standbyã€‚
å¯ä¿è¯å½“ active Mgr å®•æœºæ—¶ï¼Œstandby Mgr è‡ªåŠ¨æ¥ç®¡ã€‚
```

## 2.3å­˜å‚¨

å­˜å‚¨æ–‡ä»¶è¿‡ç¨‹

```powershell
1.è®¡ç®—æ–‡ä»¶åˆ°å¯¹è±¡çš„æ˜ å°„ï¼šå‡å¦‚ file ä¸ºå®¢æˆ·ç«¯è¦è¯»å†™çš„æ–‡ä»¶,å¾—åˆ° oid(object id) = ino + onoï¼Œino:inode number (INO), File çš„å…ƒæ•°æ®åºåˆ—å·, File çš„å”¯ä¸€ idã€‚ono:object number (ONO), File åˆ‡åˆ†äº§ç”Ÿçš„æŸä¸ª object çš„åºå·ï¼Œé»˜è®¤ä»¥ 4M åˆ‡åˆ†ä¸€ä¸ªå—å¤§å°ã€‚

2.é€šè¿‡ä¸€è‡´æ€§ HASH è®¡ç®— Object åˆ° PGï¼ŒObject -> PG æ˜ å°„ hash(oid) & mask-> pgid

3.é€šè¿‡ CRUSH ç®—æ³•è®¡ç®— PG åˆ° OSD, PG -> OSD æ˜ å°„: [CRUSH(pgid)->(osd1,osd2,osd3)]

4.ä¸»OSDå°†å¯¹è±¡å†™å…¥åˆ°ç¡¬ç›˜
5.ä¸»OSDæ•°æ®åŒæ­¥ç»™å¤‡ä»½OSDï¼Œå¹¶ç­‰å¾…å¤‡ä»½OSDç¡®è®¤
6.ä¸»OSDè¿”å›å­˜å‚¨ç»“æœ
```

cephå¯¹è±¡æ•°æ®çš„å…ƒæ•°æ®ä¿¡æ¯

```powershell
RADOSä¸­ä¸¤ç§å®ç°ï¼šxattrså’Œomap
xattrs(æ‰©å±•å±æ€§)ï¼šå…ƒæ•°æ®ä½œä¸ºæ‰©å±•å±æ€§
omapï¼šbluestoreä¸rocksdbï¼šåœ¨OSDä¸­åˆ’å‡ºä¸€éƒ¨åˆ†ç©ºé—´æ ¼å¼åŒ–ä¸ºBlueFSç”¨äºä¿å­˜å…ƒæ•°æ®
```

crushç®—æ³•

```powershell
Ceph ä½¿ç”¨ CRUSH ç®—æ³•æ¥å­˜æ”¾å’Œç®¡ç†æ•°æ®ï¼Œå®ƒæ˜¯ Ceph çš„æ™ºèƒ½æ•°æ®åˆ†å‘æœºåˆ¶ã€‚Ceph ä½¿ç”¨ CRUSH ç®—æ³•æ¥å‡†ç¡®è®¡ç®—æ•°æ®åº”è¯¥è¢«ä¿å­˜åˆ°å“ªé‡Œï¼Œä»¥åŠåº”è¯¥ä»å“ªé‡Œè¯»å–ï¼Œå’Œä¿å­˜å…ƒæ•°æ®ä¸åŒçš„æ˜¯ï¼ŒCRUSH æŒ‰éœ€è®¡ç®—å‡ºå…ƒæ•°æ®ï¼Œå› æ­¤å®ƒå°±æ¶ˆé™¤äº†å¯¹ä¸­å¿ƒå¼çš„æœåŠ¡å™¨/ç½‘å…³çš„éœ€æ±‚ï¼Œå®ƒä½¿å¾— Ceph å®¢æˆ·ç«¯èƒ½å¤Ÿè®¡ç®—å‡ºå…ƒæ•°æ®ï¼Œè¯¥è¿‡ç¨‹ä¹Ÿç§°ä¸º CRUSH æŸ¥æ‰¾ï¼Œç„¶åå’Œ OSD ç›´æ¥é€šä¿¡ã€‚
```

## 2.4è§„åˆ’åŠéƒ¨ç½²

Ceph åˆ†å¸ƒå¼å­˜å‚¨é›†ç¾¤è§„åˆ’åŸåˆ™/ç›®æ ‡:

```powershell
è¾ƒä½çš„ TCO (Total Cost of Ownership,æ€»æ‹¥æœ‰æˆæœ¬):
ä½¿ç”¨å»‰ä»·çš„ X86 æœåŠ¡å™¨ã€‚
è¾ƒé«˜çš„ IOPS (Input/Output Operations Per Second,æ¯ç§’å¯å®Œæˆçš„è¯»å†™æ¬¡æ•°):
ä½¿ç”¨ SSD/PCI-E SSD/NVMe ç¡¬ç›˜æé«˜å­˜å‚¨é›†ç¾¤æ•°æ®ä»¥æé«˜è¯»å†™æ€§èƒ½ã€‚
è¾ƒå¤§çš„å­˜å‚¨ç©ºé—´:
ä½¿ç”¨å•å— 2T/4T æˆ–æ›´å¤§å®¹é‡çš„ç£ç›˜ï¼Œæé«˜å•å°æœåŠ¡å™¨çš„æ€»ç©ºé—´ï¼ŒèŠ‚çœæœåŠ¡å™¨æ€»æ•°ï¼Œé™ä½æœºæŸœä½¿ç”¨é‡ã€‚
è¾ƒå¿«çš„ç½‘ç»œåå:
ä½¿ç”¨ 10Gã€40Gã€100G æˆ–æ›´å¿«çš„å…‰çº¤ç½‘ç»œ
æ›´å¥½çš„æ•°æ®å†—ä½™:
æ•°æ®å¯ä»¥ä»¥ä¸‰å‰¯æœ¬æœºåˆ¶åˆ†åˆ«ä¿å­˜åˆ°ä¸åŒçš„ä¸»æœºï¼Œå®•æœº 2 å°ä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ã€‚
```

æœåŠ¡å™¨ç¡¬ä»¶é€‰æ‹©ï¼š

```powershell
monitorã€mgrã€radosgw:
4C 8G~16G(å°å‹ï¼Œä¸“ç”¨è™šæ‹Ÿæœº)ã€8C 16G~32G(ä¸­å‹ï¼Œä¸“ç”¨è™šæ‹Ÿæœº)ã€16C ~32C 32G~64G(å¤§å‹/è¶…å¤§å‹ï¼Œä¸“ç”¨ç‰©ç†æœº)

MDS(ç›¸å¯¹é…ç½®æ›´é«˜ä¸€ä¸ªç­‰çº§)
8C 8G~16G(å°å‹ï¼Œä¸“ç”¨è™šæ‹Ÿæœº)ã€16C 16G~32G(ä¸­å‹ï¼Œä¸“ç”¨è™šæ‹Ÿæœº)ã€32C ~64C 64G~96G(å¤§å‹ã€è¶…å¤§å‹ï¼Œç‰©ç†æœº)

OSD èŠ‚ç‚¹ CPU:
æ¯ä¸ª OSD è¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ª CPU æ ¸å¿ƒæˆ–ä»¥ä¸Šï¼Œæ¯”å¦‚æœåŠ¡å™¨ä¸€å…± 2 é¢— CPU æ¯ä¸ª 12 æ ¸å¿ƒ 24 çº¿ç¨‹ï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ€»è®¡æœ‰ 48 æ ¸å¿ƒ CPUï¼Œè¿™æ ·æœ€å¤šæœ€å¤šå¯ä»¥æ”¾ 48 å—ç£ç›˜ã€‚

OSD èŠ‚ç‚¹å†…å­˜:
OSD ç¡¬ç›˜ç©ºé—´åœ¨ 2T æˆ–ä»¥å†…çš„æ—¶å€™æ¯ä¸ªç¡¬ç›˜ 2G å†…å­˜ï¼Œ4T çš„ç©ºé—´æ¯ä¸ª OSD ç£ç›˜ 4G å†…å­˜ï¼Œ
å³å¤§çº¦æ¯ 1T çš„ç£ç›˜ç©ºé—´(æœ€å°‘)åˆ†é… 1G çš„å†…å­˜ç©ºé—´åšæ•°æ®è¯»å†™ç¼“å­˜ã€‚
(æ€»å†…å­˜/OSD ç£ç›˜æ€»ç©ºé—´)= X > 1G å†…å­˜
æ¯”å¦‚: (æ€»å†…å­˜ 128G/36T ç£ç›˜æ€»ç©ºé—´ )= 3G/æ¯ T > 1G å†…å­˜
```

# 3.æœåŠ¡ç½‘æ ¼

æœåŠ¡ç½‘æ ¼è§£å†³ä»€ä¹ˆé—®é¢˜

```powershell
æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰æ˜¯ä¸€ç§ä¸“é—¨ç”¨æ¥å¤„ç†æœåŠ¡ä¹‹é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚
ç®€å•è¯´ï¼Œå®ƒæ˜¯å¾®æœåŠ¡æ¶æ„ä¸‹çš„ â€œæœåŠ¡é—´é€šä¿¡ç®¡æ§å¹³é¢â€ã€‚

åœ¨ä¼ ç»Ÿå•ä½“åº”ç”¨ä¸­ï¼Œæ¨¡å—é—´çš„è°ƒç”¨å°±æ˜¯æ–¹æ³•è°ƒç”¨ï¼Œä¸éœ€è¦å…³å¿ƒç½‘ç»œã€‚ä½†åœ¨å¾®æœåŠ¡ä¸­ï¼Œæ¯ä¸ªæœåŠ¡æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„ï¼Œé€šä¿¡é€šè¿‡ç½‘ç»œè¿›è¡Œï¼Œä¼šå¸¦æ¥è®¸å¤šé—®é¢˜ï¼š
æœåŠ¡å‘ç°ï¼šæ€ä¹ˆçŸ¥é“è¦è°ƒç”¨çš„æœåŠ¡åœ¨å“ªå°æœºå™¨ï¼Ÿ
è´Ÿè½½å‡è¡¡ï¼šå¤šå®ä¾‹ä¸‹æ€ä¹ˆåˆ†é…è¯·æ±‚ï¼Ÿ
æµé‡ç®¡ç†ï¼šæ€ä¹ˆåšé™æµã€ç†”æ–­ã€é‡è¯•ï¼Ÿ
å®‰å…¨ï¼šæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å¦‚ä½•è®¤è¯ä¸åŠ å¯†ï¼ˆmTLSï¼‰ï¼Ÿ
å¯è§‚æµ‹æ€§ï¼šå¦‚ä½•è·å–è°ƒç”¨é“¾è·¯ã€æŒ‡æ ‡ã€æ—¥å¿—ï¼Ÿ
è¿™äº›åŠŸèƒ½æœ¬æ¥å¯ä»¥å†™åœ¨ä¸šåŠ¡ä»£ç é‡Œï¼ˆæ¯”å¦‚é€šè¿‡ Spring Cloudã€Dubboï¼‰ï¼Œä½†è¿™æ ·å¯¼è‡´ ä¸šåŠ¡å’ŒåŸºç¡€è®¾æ–½é€»è¾‘è€¦åˆï¼Œå¼€å‘äººå‘˜è¦é‡å¤å®ç°ï¼Œç»´æŠ¤å›°éš¾ã€‚

æœåŠ¡ç½‘æ ¼çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼šå°†è¿™äº›åŠŸèƒ½æŠ½ç¦»å‡ºæ¥ï¼Œç”±åŸºç¡€è®¾æ–½è´Ÿè´£ï¼Œä¸šåŠ¡ä»£ç ä¸æ„ŸçŸ¥ã€‚

åªéœ€è¦ä¸šåŠ¡å¼€å‘éµå¾ªç›¸åŒçš„æ¥å£åè®®ï¼Œæ¯”å¦‚rpc,restfulï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆè¯­è¨€çš„ä¸šåŠ¡ä»£ç éƒ½å¯ä»¥ç›¸äº’è°ƒç”¨
```

å®ç°

https://istio.io/latest/docs/setup/getting-started/

```powershell
æœåŠ¡ç½‘æ ¼ä¸€èˆ¬åˆ†ä¸¤å±‚ï¼š
1.æ•°æ®å¹³é¢ï¼ˆData Planeï¼‰ï¼šå®é™…å¤„ç†æµé‡ã€‚
é€šå¸¸ç”± è½»é‡çº§ä»£ç†ï¼ˆSidecar Proxyï¼‰ å®ç°ï¼Œæ¯”å¦‚ Envoyã€‚
æ¯ä¸ªæœåŠ¡å®ä¾‹æ—è¾¹éƒ½ä¼šè¿è¡Œä¸€ä¸ªä»£ç†å®¹å™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è¿›å‡ºæµé‡ã€‚

2.æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ï¼šè´Ÿè´£ç®¡ç†å’Œé…ç½®æ•°æ®å¹³é¢çš„ä»£ç†ã€‚
ä¸‹å‘è·¯ç”±ã€æµé‡è§„åˆ™ã€å®‰å…¨ç­–ç•¥ã€‚
å…¸å‹å®ç°å°±æ˜¯ Istioã€‚

è¿™æ ·ï¼Œä¸šåŠ¡æœåŠ¡ä¹‹é—´å¹¶ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡ä»£ç†é€šä¿¡ï¼Œä»£ç†æ¥ä¿è¯æµé‡æ²»ç†ã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨ã€‚
```

## 3.1Envoy

```powershell
Envoy æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ L4/L7 ä»£ç†ï¼Œå¸¸è¢«ç”¨ä½œ æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ çš„æ•°æ®é¢ä»£ç†ï¼Œä¹Ÿå¯ä»¥å•ç‹¬ä½œä¸º API Gatewayã€è¾¹è½¦ä»£ç†ï¼ˆsidecarï¼‰ã€è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨ã€‚

nginxå·¥ä½œåœ¨ç½‘ç»œè¾¹ç¼˜å‡ºå…¥å£æµé‡ï¼Œè€Œenvoyæ˜¯Service Mesh æ•°æ®é¢çš„å‡ºå…¥å£æµé‡æ²»ç†

éƒ¨ç½²ï¼šè‡ªå·±ç©çš„è¯ç”¨docker-composeæˆ–è€…deploymentç©ä¸€ç©ï¼Œå­¦å®Œistioå°±ç›´æ¥ä¸¢å¼ƒè¿™ç§ç©æ³•å§ï¼Œæ‰‹åŠ¨ç”¨envoyå»æä¸ªæœåŠ¡ç½‘æ ¼æ˜¯åœ°ç‹±çº§åˆ«çš„éš¾åº¦
```



```powershell
   Proxyï¼šè¿æ¥DownStreamå’ŒUPStream
        DownStreamï¼šé€šè¿‡Listeneræ¥å…¥è¯·æ±‚
            å…³é”®é…ç½®ï¼š
                nameã€address
                filter_chains: [{}]
                    ä»£ç†è¿‡æ»¤å™¨é€šå¸¸åœ¨ä¸€ä¸ªListeneråªé…ç½®ä¸€ä¸ªï¼› 
            é’ˆå¯¹HTTP 7å±‚ä»£ç†æ¥è¯´ï¼Œæ¯ä¸ªListeneråˆå¯ä»¥æ‰¿è½½ä¸€åˆ°å¤šä¸ªVirtual Hostï¼Œé€šè¿‡è¯·æ±‚æŠ¥æ–‡ä¸­çš„Hostæ¥è·å–è¯·ç¤ºçš„ç›®æ ‡ä¸»æœº
                Virtual Hostå†…éƒ¨æœ€é‡è¦çš„é…ç½®å³ä¸ºroute
                    /PATH --> Clusterã€Redirectã€Direct Response
            
        UpStreamï¼šé€šè¿‡Clusteræ‰¿è½½ä¸Šæ¸¸ä¸Šå…³çš„é…ç½®
            å…³é”®é…ç½®ï¼š
                name, type, lb_policy
                load_assignments: [{}]

                type: STATIC, STRICT_DNS, LOGICAL_DNS, EDS 

    ä»£ç†ç±»å‹ï¼š
        Front/Edge Proxy: Gateway 
            Ingress Gateway
            Egress Gateway 
        Service to Service Onlyï¼šMesh
            Ingress Listeners 
            Egress Listeners 
            Egress Listeners to External (Optional)
            
1.åº”ç”¨ä¸éœ€è¦çŸ¥é“ IP/ç«¯å£
é€šè¿‡é€»è¾‘æœåŠ¡åå³å¯è°ƒç”¨
2.Envoy æ‹¦æˆªç«¯å£
æ‹¦æˆªåŸå§‹ TCP/HTTP æµé‡ï¼Œè·å–ç›®æ ‡ä¿¡æ¯
3.Cluster + æœåŠ¡å‘ç°
Cluster å†…ç»´æŠ¤æœ€æ–° endpointï¼ˆIP + Portï¼‰
Kubernetes EDS / API Server æä¾›æœåŠ¡å‘ç°
4.ç«¯å£åŠ¨æ€è§£æ
Envoy æ ¹æ® Cluster endpoint è½¬å‘æµé‡ï¼Œå³ä½¿æœåŠ¡ç«¯å£å˜åŒ–ä¹Ÿèƒ½æ­£ç¡®å‘é€
```



### 3.1.1å¸¸ç”¨é…ç½®ï¼ˆè¯»æ‡‚å°±å¥½ï¼‰

è¯·æ±‚æµ‹è¯•

```powershell
#!/bin/bash
#
if [ $# -ne 2 ]
then
    echo "USAGE: $0 <URL> <COUNT>"
    exit 1;
fi

URL=$1
COUNT=$2
c=1
#interval="0.2"

while [[ ${c} -le ${COUNT} ]];
do
  #echo "Sending GET request: ${URL}"
  curl -o /dev/null -w '%{http_code}\n' -s ${URL} &
  (( c++ ))
#  sleep $interval
done

wait
```

#### 3.1.1.1 basic

l7ç®€å•ç¤ºä¾‹ï¼š

```yaml
#é€šè¿‡curl 9901/clustersè·å–ä¸€äº›ä¿¡æ¯
admin:
  profile_path: /tmp/envoy.prof        #ç”¨äºæ€§èƒ½åˆ†æï¼ˆCPU profileï¼‰
  access_log_path: /tmp/admin_access.log  #ç®¡ç†æ¥å£çš„è®¿é—®æ—¥å¿—
  address:
    socket_address:
       address: 0.0.0.0
       port_value: 9901

#åˆ†å±‚è¿è¡Œæ—¶é…ç½®ï¼šä¼˜å…ˆçº§ä¸€èˆ¬æ˜¯ï¼šstatic_layer < disk_layer < admin_layerï¼Œå åŠ ç”Ÿæ•ˆï¼ŒåŒé…ç½®è¦†ç›–
layered_runtime:
  layers:
  - name: static_layer_0
    static_layer:
      health_check:
        min_interval: 5     #å¥åº·æ£€æŸ¥çš„æœ€å°é—´éš”æ—¶é—´
#admin_layer è¡¨ç¤ºå¯ç”¨ Admin API å¯å†™å±‚ï¼Œå¯ä»¥é€šè¿‡ Envoy çš„ Admin æ¥å£ï¼ˆé»˜è®¤ 9901 ç«¯å£ï¼‰æ¥åŠ¨æ€ä¿®æ”¹è¿è¡Œæ—¶å‚æ•°
  - name: admin_layer_0
    admin_layer: {}

#ä½œç”¨ï¼šå®šä¹‰ä¸€ä¸ªç›‘å¬å™¨ï¼ˆå…¥å£ï¼‰ã€‚
#ç›‘å¬ç«¯å£ï¼š0.0.0.0:80 â†’ æ¥æ”¶æ‰€æœ‰ HTTP è¯·æ±‚ã€‚
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    #Envoy æœ€å¸¸ç”¨çš„ç½‘ç»œè¿‡æ»¤å™¨ï¼Œä¸“é—¨ç”¨æ¥å¤„ç† HTTP/1.1ã€HTTP/2ã€‚
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          #Envoy ä¼šæ ¹æ® "@type" æŠŠè¿™æ®µé…ç½®è§£ææˆå¯¹åº”çš„ protobuf å¯¹è±¡
          #æ¯”å¦‚è¯´è¿™é‡Œæ˜¯ç”ŸæˆHttpConnectionManagerå¯¹è±¡
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http    #ç»Ÿè®¡å‰ç¼€ï¼ˆç”¨äº Prometheus æŒ‡æ ‡ï¼‰
          codec_type: AUTO             #è‡ªåŠ¨é€‰æ‹© HTTP/1.1 æˆ– HTTP/2ã€‚
          route_config:                #Route é…ç½®
            name: local_route
            virtual_hosts:
            - name: web_service_1
              domains: ["*.ik8s.io", "ik8s.io"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: local_cluster }
            - name: web_service_2
              domains: ["*.magedu.com",â€œmagedu.com"]
              routes:
              - match: { prefix: "/" }
                redirect:
                  host_redirect: "www.ik8s.io"
          #router filterï¼šå¿…é¡»é…ç½®çš„ HTTP è¿‡æ»¤å™¨ï¼Œç”¨äºè·¯ç”±è¯·æ±‚åˆ° clusterï¼Œæˆ–è€…æ‰§è¡Œ redirect/retry ç­‰æ“ä½œã€‚
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  - name: local_cluster
    connect_timeout: 0.25s          #è¿æ¥åç«¯è¶…æ—¶ 0.25 ç§’
    type: STATIC                    #é™æ€å®šä¹‰åç«¯åœ°å€ï¼ˆä¸æ˜¯ä»æœåŠ¡å‘ç°è·å–ï¼‰
    lb_policy: ROUND_ROBIN          #è½®è¯¢è´Ÿè½½å‡è¡¡
    load_assignment:
      cluster_name: local_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: 172.31.5.11, port_value: 8080 }
        - endpoint:
            address:
              socket_address: { address: 172.31.5.12, port_value: 8080 }
```

tcpç¤ºä¾‹:

```yaml
static_resources:
  listeners:
    name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.tcp_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
          stat_prefix: tcp
          cluster: local_cluster
```

echoï¼šä¸ç”¨é…ç½® Clusterã€Route å°±èƒ½çœ‹åˆ°æ•ˆæœï¼Œç¡®è®¤ Listener æ­£å¸¸å·¥ä½œï¼Œå¸¸ç”¨äºéªŒè¯ Envoy æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨å¹¶ç›‘å¬ç«¯å£

```powershell
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8080
    filter_chains:
    - filters:
      - name: envoy.filters.network.echo      #echo filter
```

ingressï¼šæ‹¦æˆªpodå…¥å£è¯·æ±‚ï¼Œä»¥ä¸‹åªæ‹¦äº†80ç«¯å£ï¼ŒIstio/Linkerd ç­‰ Service Meshï¼Œç”¨ iptables æŠŠ 8080 çš„æµé‡é‡å®šå‘åˆ° Envoy çš„ç›‘å¬ç«¯å£ï¼ˆ15001/15006ï¼‰ã€‚

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: web_service_1
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: local_cluster }
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  - name: local_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: local_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: 127.0.0.1, port_value: 8080 }
```

egressï¼šæ‹¦æˆªæµå‡ºpodçš„æµé‡

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 127.0.0.1, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: egress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: web_service_1
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: web_cluster }
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  - name: web_cluster
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: web_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: 172.31.4.11, port_value: 80 }
        - endpoint:
            address:
              socket_address: { address: 172.31.4.12, port_value: 80 }
```

#### 3.1.1.2xDS

Envoy ä½œä¸ºå‰ç«¯ä»£ç†+xDSåŠ¨æ€é…ç½®ç®¡ç†å®¢æˆ·ç«¯:æ‰€æœ‰ listener/cluster/route éƒ½é€šè¿‡ xDS åŠ¨æ€ä¸‹å‘

```powershell
xDS ç»Ÿä¸€æŠ½è±¡ï¼šå„ç§èµ„æºéƒ½é€šè¿‡å‘ç°æœåŠ¡åŠ¨æ€ä¸‹å‘
LDS
Listener Discovery Service
ä¸‹å‘ Listener é…ç½®ï¼ˆç›‘å¬ç«¯å£ã€è¿‡æ»¤é“¾ã€å…¥ç«™æµé‡è§„åˆ™ï¼‰

RDS
Route Discovery Service
ä¸‹å‘ è·¯ç”±é…ç½®ï¼ˆHTTP è·¯ç”±è§„åˆ™ï¼Œæ¯”å¦‚ /api â†’ clusterAï¼‰

CDS
Cluster Discovery Service
ä¸‹å‘ ä¸Šæ¸¸ Cluster é…ç½®ï¼ˆæœåŠ¡å‘ç°ç»“æœã€è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰

EDS
Endpoint Discovery Service
ä¸‹å‘ Cluster çš„å…·ä½“ Endpointï¼ˆä¾‹å¦‚æŸä¸ªå¾®æœåŠ¡çš„å¤šä¸ª Pod IP:Portï¼‰

SDS
Secret Discovery Service
ä¸‹å‘ è¯ä¹¦ã€å¯†é’¥ï¼ˆTLS è¯ä¹¦è½®æ¢ã€mTLS æ”¯æŒï¼‰

ADS
Aggregated Discovery Service
èšåˆæ¥å£ï¼ŒEnvoy é€šè¿‡ä¸€ä¸ª gRPC æµåŒæ—¶æ¥æ”¶ LDS/CDS/RDS/EDS/SDS ç­‰é…ç½®ï¼Œè€Œä¸æ˜¯åˆ†åˆ«è¿æ¥å¤šä¸ªæ¥å£ã€‚

    dynamic_resources: {
        lds_config:
            é…ç½®æºï¼ˆä¸‰é€‰ä¸€ï¼‰ï¼š
                path: åŸºäºæŒ‡å®šè·¯å¾„ä¸Šçš„æ–‡ä»¶å‘ç°
                api_config_sourceï¼šåŸºäºMSå•ç‹¬è¿›è¡Œå‘ç°
                    ç‰¹æ®Šä¾èµ–ï¼šäº‹å…ˆå®šä¹‰å¥½MSç»„æˆçš„é›†ç¾¤ï¼Œè¯¥é›†ç¾¤é…ç½®ä¸€å®šæ˜¯é™æ€é…ç½®çš„ï¼Œè€Œä¸”ä¸ºäº†å®‰å…¨ï¼Œä¸€èˆ¬åº”è¯¥ä½¿ç”¨tlsåè®®ä¼ è¾“é…ç½®
                adsï¼šåŸºäºMSå‘ç°æ‰€æœ‰ç±»å‹çš„åŠ¨æ€é…ç½®

        cds_config: {}
    } 
    
æ ¸å¿ƒèµ„æºç±»å‹ä¸ºListenerã€RouteConfigurationã€Clusterå’ŒClusterLoadAssignmentå››ä¸ª

Envoy å¯åŠ¨
Envoy æ ¹æ®é™æ€ Cluster xds_cluster è¿æ¥åˆ° xds-server:18000
Envoy å‘ xDS Server æ³¨å†Œè‡ªå·±èŠ‚ç‚¹ä¿¡æ¯ï¼ˆNode IDã€Cluster åï¼‰
xDS Server æ ¹æ®èŠ‚ç‚¹ä¿¡æ¯ä¸‹å‘ Listener/Cluster/Route é…ç½®
Envoy åŠ¨æ€æ›´æ–°è‡ªèº«çš„è·¯ç”±è¡¨å’Œ Cluster endpoints
```

GRPC

```powershell
#å‘Šè¯‰ xDS Server â€œæˆ‘æ˜¯è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘å±äºè¿™ä¸ªé›†ç¾¤â€ï¼Œä¾¿äºä¸‹å‘åŠ¨æ€é…ç½®ã€‚
node:
  id: envoy_front_proxy   #Envoy å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ï¼Œé€šå¸¸ç”¨äº xDS Server è¯†åˆ«èŠ‚ç‚¹
  cluster: webcluster

admin:       #åŠŸèƒ½ï¼šé€šè¿‡ Admin API å¯ä»¥æŸ¥è¯¢ Envoy ç»Ÿè®¡ä¿¡æ¯ã€çƒ­é‡è½½é…ç½®ã€profiling ç­‰
  profile_path: /tmp/envoy.prof
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
       address: 0.0.0.0
       port_value: 9901

dynamic_resources:
  ads_config:         #æŒ‡å®š Envoy ä½¿ç”¨ gRPC æ–¹å¼è¿æ¥ xDS Server è·å–åŠ¨æ€é…ç½®ï¼Œè¿˜å¯ä»¥RESTæ–¹å¼
  #åŸºäºGRPC/RESTç®¡ç†æœåŠ¡å™¨
    api_type: GRPC    
    transport_api_version: V3
    grpc_services: #æŒ‡å®š Envoy è¦è¿æ¥çš„ gRPC Clusterï¼Œè¿™é‡Œæ˜¯ xds_cluster
    - envoy_grpc:
        cluster_name: xds_cluster
    set_node_on_first_message_only: true 
  #éƒ½é€šè¿‡ ADS æ‹‰å–åŠ¨æ€é…ç½®ï¼Œä¸ç”¨ Envoy é™æ€é…ç½® Cluster æˆ– Listener
  cds_config:      #é›†ç¾¤åŠ¨æ€å‘ç°
    resource_api_version: V3
    ads: {}
  lds_config:      #ç›‘å¬å™¨åŠ¨æ€å‘ç°
    resource_api_version: V3
    ads: {}

#dynamic_resources:
#  lds_config:
#    resource_api_version: V3
#    api_config_source:
#      api_type: GRPC
#      transport_api_version: V3
#      grpc_services:
#      - envoy_grpc:
#          cluster_name: xds_cluster
#
#  cds_config:
#    resource_api_version: V3
#    api_config_source:
#      api_type: GRPC
#      transport_api_version: V3
#      grpc_services:
#      - envoy_grpc:
#          cluster_name: xds_cluster

static_resources:
  clusters:
  - name: xds_cluster   #Envoy é™æ€å®šä¹‰çš„ Clusterï¼Œç”¨æ¥è¿æ¥ xDS Server
    connect_timeout: 0.25s
    type: STRICT_DNS
    # The extension_protocol_options field is used to provide extension-specific protocol options for upstream connections. 
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: xds_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: xdsserver
                port_value: 18000
```

åŸºäºæŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å‘ç°ï¼ŒEDSç«¯ç‚¹å‘ç°æ¡ˆä¾‹

```yaml
---eds.yaml----------------------------
version_info: '2'
resources:
- "@type": type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment
  cluster_name: webcluster
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: 172.31.11.11
            port_value: 80
    - endpoint:
        address:
          socket_address:
            address: 172.31.11.12
            port_value: 80
            
---front-envoy.yaml---------
node:
  id: envoy_front_proxy
  cluster: MageEdu_Cluster

admin:
  profile_path: /tmp/envoy.prof
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
       address: 0.0.0.0
       port_value: 9901

static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: web_service_01
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: webcluster }
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  - name: webcluster
    connect_timeout: 0.25s
    type: EDS
    lb_policy: ROUND_ROBIN
    eds_cluster_config:
      service_name: webcluster
      eds_config:
        path: '/etc/envoy/eds.conf.d/eds.yaml'
```

cds,lds

```yaml
---cds.yaml
resources:
- "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
  name: webcluster
  connect_timeout: 1s
  type: STRICT_DNS
  load_assignment:
    cluster_name: webcluster
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address:
              address: webserver01
              port_value: 80
      - endpoint:
          address:
            socket_address:
              address: webserver02
              port_value: 80
---lds.yaml
resources:
- "@type": type.googleapis.com/envoy.config.listener.v3.Listener
  name: listener_http
  address:
    socket_address: { address: 0.0.0.0, port_value: 80 }
  filter_chains:
  - filters:
      name: envoy.http_connection_manager
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
        stat_prefix: ingress_http
        route_config:
          name: local_route
          virtual_hosts:
          - name: local_service
            domains: ["*"]
            routes:
            - match:
                prefix: "/"
              route:
                cluster: webcluster
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              
---front-envoy
node:
  id: envoy_front_proxy
  cluster: MageEdu_Cluster

admin:
  profile_path: /tmp/envoy.prof
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
       address: 0.0.0.0
       port_value: 9901

dynamic_resources:
  lds_config:
    path: /etc/envoy/conf.d/lds.yaml
  cds_config:
    path: /etc/envoy/conf.d/cds.yaml
```

#### 3.1.1.3å¥åº·æ£€æŸ¥

```powershell
å¥åº·æ£€æŸ¥ï¼šç±»æ¯” K8s çš„ livenessProbeï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯ Envoy å¯¹ä¸Šæ¸¸æœåŠ¡çš„å¥åº·æ¢æµ‹ï¼Œè€Œä¸æ˜¯ kubelet å¯¹å®¹å™¨çš„æ¢æµ‹ã€‚
    é›†ç¾¤ä¸Šæœªå®šä¹‰å¥åº·çŠ¶æ€æ£€æµ‹æœºåˆ¶æ—¶ï¼š
        æ¯ä¸ªç«¯ç‚¹ï¼Œåˆå§‹å³ä¸ºå¥åº·ï¼Œä¸”ä¸€ç›´è¢«è§†ä½œå¥åº·
        æ­¤æ—¶è‡³å°‘åº”è¯¥æ‰“å¼€å¼‚å¸¸å€¼æ¢æµ‹
            æ ¹æ®å®¢æˆ·ç«¯ä¸è¢«ä»£ç†ä¸Šæ¸¸ç«¯ç‚¹ä¹‹é—´çš„é€šä¿¡æµé‡æ¥åˆ¤å®šç«¯ç‚¹å¥åº·çŠ¶æ€
                ä¸´æ—¶åœ°åˆ¤å®šä¸ºä¸å¥åº·ï¼Œä¸´æ—¶é©±é€è¯¥ç«¯ç‚¹
                è¿‡åä¼šå†æ¬¡è‡ªåŠ¨æ·»åŠ å›æ¥
                    è‹¥ä»ç„¶ä¸å¥åº·ï¼Œä¼šå†æ¬¡è¢«é©±é€ï¼Œé©±é€æ—¶é•¿ä¼šæˆå€å¢åŠ 
            åˆ¤å®šæ ‡å‡†æœ‰å¤šç±»
            é©±é€æ“ä½œæ˜¯æœ‰æ¡ä»¶çš„
                é©±é€çš„åŠŸèƒ½æ¿€æ´»é€šå¸¸æœ‰å¤„äºå¥åº·çŠ¶æ€çš„ç«¯ç‚¹çš„æ¯”ä¾‹è¦æ±‚
                
å¦‚æœå¥åº·èŠ‚ç‚¹ < 50% â†’ Envoy è¿›å…¥ panic mode
å¿½ç•¥èŠ‚ç‚¹å¥åº·çŠ¶æ€ï¼ŒæŠŠè¯·æ±‚ å‘é€ç»™æ‰€æœ‰èŠ‚ç‚¹ï¼Œå³ä½¿æœ‰èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯ç”¨
ç›®çš„æ˜¯ä¿è¯æœåŠ¡ å°½é‡å¯ç”¨ï¼Œé¿å…å½»åº•å®•æœº
```

å¥åº·æ£€æŸ¥

```powershell
health_checks:
- timeout: 5s                # å•æ¬¡å¥åº·æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡ 5 ç§’æ²¡å“åº”å°±ç®—å¤±è´¥
  interval: 10s              # å¥åº·æ£€æŸ¥çš„é—´éš”ï¼Œæ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
  unhealthy_threshold: 2     # è¿ç»­ 2 æ¬¡å¤±è´¥ï¼Œè®¤ä¸ºè¯¥å®ä¾‹ä¸å¥åº·
  healthy_threshold: 2       # è¿ç»­ 2 æ¬¡æˆåŠŸï¼Œè®¤ä¸ºè¯¥å®ä¾‹æ¢å¤å¥åº·
  http_health_check:
    path: /livez             # ç”¨ HTTP GET /livez ä½œä¸ºæ¢æµ‹è¯·æ±‚
    expected_statuses:
      start: 200             # æœŸæœ›è¿”å›çŠ¶æ€ç åŒºé—´èµ·å§‹å€¼
      end: 399               # æœŸæœ›è¿”å›çŠ¶æ€ç åŒºé—´ç»“æŸå€¼ï¼ˆå«å¤´ä¸å«å°¾ï¼‰
    outlier_detection:
      consecutive_5xx: 3     #è¿ç»­ä¸‰æ¬¡5xx
      base_ejection_time: 10s   #å¼¹å‡º
      max_ejection_percent: 10  #æœ€å¤§å¼¹å‡ºæ¯”ä¾‹


  #tcp_health_check: {}          # TCP æ£€æŸ¥ï¼šåªè¦èƒ½æ¡æ‰‹æˆåŠŸå°±ç®—å¥åº·
  #grpc_health_check:
    #service_name: my.grpc.Service   # gRPC æœåŠ¡å
  #redis_health_check: {}   # å‘ PINGï¼Œçœ‹èƒ½å¦æ­£å¸¸è¿”å› PONG
```

#### 3.1.1.4è´Ÿè½½å‡è¡¡

```powershell
ä¼˜å…ˆçº§
priorityï¼šæ•´å‹ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚
0 â†’ ä¸»èŠ‚ç‚¹ï¼ˆprimaryï¼‰
1ã€2 â†’ åå¤‡èŠ‚ç‚¹ï¼ˆsecondary/backupï¼‰
Envoy ä¼šä¼˜å…ˆæŠŠè¯·æ±‚å‘é€ç»™ æœ€ä½ priority çš„èŠ‚ç‚¹ï¼Œåªæœ‰å½“è¿™äº›èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šé™çº§åˆ°é«˜ priority çš„èŠ‚ç‚¹ã€‚

è´Ÿè½½å‡è¡¡å™¨å­é›†(Subset)
Envoy åœ¨æ™®é€šè´Ÿè½½å‡è¡¡åŸºç¡€ä¸Šçš„æ‰©å±•ï¼Œç”¨äºæ ¹æ® ä¸»æœºçš„å…ƒæ•°æ®ï¼ˆmetadataï¼‰è¿›è¡Œåˆ†ç»„é€‰æ‹©
Envoy å…è®¸ç»™ä¸Šæ¸¸ä¸»æœºè®¾ç½® metadata æ ‡ç­¾ï¼ˆæ¯”å¦‚ç‰ˆæœ¬ã€æœºæˆ¿ã€ç±»å‹ç­‰ï¼‰ã€‚
å­é›†è´Ÿè½½å‡è¡¡å¯ä»¥æŒ‰è¿™äº›æ ‡ç­¾ç­›é€‰å‡ºä¸€ç»„ä¸»æœºï¼ˆsubsetï¼‰ï¼Œå†åœ¨å­é›†å†…åšè´Ÿè½½å‡è¡¡ã€‚
å®ç°æ•ˆæœç±»ä¼¼ æŒ‰æ¡ä»¶è·¯ç”± + æƒé‡è°ƒåº¦ï¼Œæ”¯æŒç°åº¦å‘å¸ƒã€åˆ†åŒºæµé‡ç­‰ã€‚

å­é›† LB = åŠ¨æ€ã€çµæ´»ã€å°‘ cluster
æ™®é€šè·¯ç”± = é™æ€ã€ç®€å•ã€æ¯ä¸ªç‰ˆæœ¬ cluster ç‹¬ç«‹
å¦‚æœç‰ˆæœ¬å°‘ä¸”ä¸é¢‘ç¹å˜åŒ–ï¼Œæ™®é€šè·¯ç”±å³å¯ã€‚
å¦‚æœç‰ˆæœ¬å¤šã€èŠ‚ç‚¹åŠ¨æ€ï¼Œæˆ–è€…å¸Œæœ›ç°åº¦/æŒ‰ region åˆ†æµï¼Œå­é›† LB æ›´åˆé€‚

é…ç½®äº†å­é›†ï¼Œä½†è·¯ç”±å¹¶æœªæŒ‡å®šå…ƒæ•°æ®æˆ–ä¸å­˜åœ¨ä¸æŒ‡å®šå…ƒæ•°æ®åŒ¹é…çš„å­é›†æ—¶ï¼Œåˆ™å­é›†å‡è¡¡å‡è¡¡
å™¨ä¸ºå…¶åº”ç”¨â€œå›é€€ç­–ç•¥â€
â—¼ NO_FALLBACKï¼šè¯·æ±‚å¤±è´¥ï¼Œç±»ä¼¼é›†ç¾¤ä¸­ä¸å­˜åœ¨ä»»ä½•ä¸»æœºï¼›æ­¤ä¸ºé»˜è®¤ç­–ç•¥ï¼›
â—¼ ANY_ENDPOINTï¼šåœ¨æ‰€æœ‰ä¸»æœºé—´è¿›è¡Œè°ƒåº¦ï¼Œä¸å†è€ƒè™‘ä¸»æœºå…ƒæ•°æ®ï¼›
â—¼ DEFAULT_SUBSETï¼šè°ƒåº¦è‡³é»˜è®¤çš„å­é›†ï¼Œè¯¥å­é›†éœ€è¦äº‹å…ˆå®šä¹‰ï¼›

å…¨å±€è´Ÿè½½å‡è¡¡ä¸åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡
    å…¨å±€è´Ÿè½½å‡è¡¡ï¼š
        å°†ç«¯ç‚¹æŒ‰ä½ç½®åˆ†ç»„ï¼Œåœ¨å„ç»„ä¹‹é—´åˆ†é…æµé‡
            åˆ†ç»„æ¡ä»¶ï¼šRegionã€Zoneã€Sub_Zone
        ç»„ä¸Šé™„åŠ çš„å±æ€§ï¼š
            Priorityï¼šä¼˜å…ˆçº§
            Weightï¼šæƒé‡
        å°†å„åç«¯ç«¯ç‚¹ï¼šåŠ¨æ€åˆ†ç»„ï¼Œç§°ä¸ºå­é›†
            è‡ªå®šä¹‰åˆ†ç»„ï¼Œè€Œä¸å†æ˜¯å›ºå®šçš„åŸºäºä½ç½®çš„å®šä¹‰
            æµé‡åœ¨å¤šä¸ªå­é›†ä¹‹é—´åˆ†å¸ƒ
            é€‚ç”¨åœºæ™¯ï¼šServiceä»…è´Ÿè´£å¸®åŠ©å®ŒæˆæœåŠ¡å‘ç°
                v1
                v2
        åŒºåŸŸæ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡

    åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡ï¼š
        è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š
            RANDOMã€ROUND_ROBINã€LEAST_REQUEST
            RING_HASHã€MAGLEV
        åŒºåŸŸæ„ŸçŸ¥çš„è´Ÿè½½å‡è¡¡
```



| ç®—æ³•åç§°     | Envoy é…ç½®å    | ç‰¹ç‚¹                                           | é€‚ç”¨åœºæ™¯                                     |
| ------------ | --------------- | ---------------------------------------------- | -------------------------------------------- |
| åŠ æƒè½®è¯¢     | ROUND_ROBIN     | æŒ‰é¡ºåºè½®æµåˆ†å‘è¯·æ±‚ï¼Œå¯æ ¹æ®æƒé‡è°ƒæ•´             | è¯·æ±‚è€—æ—¶å‡åŒ€ï¼Œç®€å•è´Ÿè½½å‡è¡¡åœºæ™¯               |
| åŠ æƒæœ€å°‘è¯·æ±‚ | LEAST_REQUEST   | ä¼˜å…ˆå‘é€åˆ°å½“å‰æ´»è·ƒè¯·æ±‚æœ€å°‘çš„ä¸»æœºï¼Œå¯ç»“åˆæƒé‡   | è¯·æ±‚è€—æ—¶å·®å¼‚å¤§ï¼Œéœ€è¦åŠ¨æ€è´Ÿè½½å‡è¡¡             |
| ç¯å“ˆå¸Œ       | RING_HASH       | ç±»ä¼¼ä¸€è‡´æ€§å“ˆå¸Œï¼Œå˜åŠ¨ä¸»æœºå½±å“å°                 | ä¼šè¯ä¿æŒã€åˆ†å¸ƒå¼ç¼“å­˜ã€éœ€è¦è¯·æ±‚ç¨³å®šæ˜ å°„çš„åœºæ™¯ |
| ç£æ‚¬æµ®å“ˆå¸Œ   | MAGLEV          | å“ˆå¸Œç¯å›ºå®šå¤§å° 65537ï¼Œç¡®ä¿æ¯ä¸ªä¸»æœºè‡³å°‘æ˜ å°„ä¸€æ¬¡ | ä¼šè¯ä¿æŒã€ç¨³å®šè´Ÿè½½åˆ†é…ï¼Œç¯å“ˆå¸Œå‡çº§ç‰ˆ         |
| éšæœº         | RANDOM          | éšæœºé€‰æ‹©ä¸»æœºï¼Œæœªé…ç½®å¥åº·æ£€æŸ¥æ—¶æ¯”è½®è¯¢æ›´å¥½       | è½»é‡çº§è´Ÿè½½å‡è¡¡ï¼Œå¿«é€Ÿå®ç°                     |
| åŸå§‹ç›®æ ‡     | ORIGINAL_DST_LB | è¯·æ±‚ç›´æ¥è½¬å‘åˆ°åŸå§‹ç›®æ ‡åœ°å€                     | åŸå§‹ç›®æ ‡é›†ç¾¤è°ƒåº¦ï¼Œä»…é™ç‰¹å®šåœºæ™¯               |

åŠ æƒæœ€å°‘è¯·æ±‚

```yaml
  clusters:
  - name: web_cluster_01
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: LEAST_REQUEST
    load_assignment:
      cluster_name: web_cluster_01
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: red
                port_value: 80
          load_balancing_weight: 1
        - endpoint:
            address:
              socket_address:
                address: blue
                port_value: 80
          load_balancing_weight: 3
        - endpoint:
            address:
              socket_address:
                address: green
                port_value: 80
          load_balancing_weight: 5
```

ä½ç½®åŠ æƒ

```yaml
  clusters:
  - name: webcluster1
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: webcluster1
      policy:
        overprovisioning_factor: 140   #è´Ÿè½½è¿‡é‡å› å­ï¼Œå°±æ˜¯è®¤ä¸ºè‡ªå·±èƒ½æ‰¿è½½140%çš„æµé‡ï¼Œå‡ºæ•…éšœåˆ°ä¸€å®šç¨‹åº¦æ—¶æ‰ä¼šæŠŠæµé‡ç»™ä½ä¼˜å…ˆçº§çš„ä¸»æœºï¼Œ10*100=1000,7*140=980ï¼ŒæŸå¤±ä¸‰å°æ‰é™çº§
      endpoints:
      - locality:
          region: cn-north-1               ##åŒºåŸŸ
        priority: 0
        load_balancing_weight: 10
        lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: webservice1, port_value: 80 }
      - locality:
          region: cn-north-2
        priority: 0
        load_balancing_weight: 20
        lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: webservice2, port_value: 80 }
```

ring hash

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: webservice
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: web_cluster_01
                  hash_policy:             ####æŒ‡æ˜è¦hashçš„å†…å®¹
                  # - connection_properties:
                  #     source_ip: true
                  - header:
                      header_name: User-Agent
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router  
  
  clusters:
  - name: web_cluster_01
    connect_timeout: 0.5s
    type: STRICT_DNS
    lb_policy: RING_HASH
    ring_hash_lb_config:
      maximum_ring_size: 1048576   ##æ§½ä½
      minimum_ring_size: 512
    load_assignment:
      cluster_name: web_cluster_01
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: myservice
                port_value: 80
                
#ç¯ = ä¸€ä¸ªè¿ç»­çš„å“ˆå¸Œç©ºé—´ï¼ˆ0 åˆ° N-1ï¼‰ï¼Œå°±åƒä¸€ä¸ªåœ†ç¯ã€‚
#æ¯ä¸ªèŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰ä¼šè¢«æ˜ å°„åˆ°ç¯ä¸Šçš„è‹¥å¹²ç‚¹ï¼ˆè™šæ‹ŸèŠ‚ç‚¹ï¼‰ã€‚
#è¯·æ±‚é€šè¿‡å“ˆå¸Œè®¡ç®—ï¼ˆä¾‹å¦‚ URLã€ç”¨æˆ· IDã€Cookieï¼‰å¾—åˆ°ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åé¡ºæ—¶é’ˆæ‰¾åˆ°ç¯ä¸Šæœ€è¿‘çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯è¯¥è¯·æ±‚è¦å‘é€çš„æœåŠ¡å™¨ã€‚
```

è´Ÿè½½å‡è¡¡å­é›†

```yaml
static_resources:
  listeners:
  - address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    name: listener_http
    filter_chains:
    - filters:
    #ä½¿ç”¨ HTTP Connection Manager å¤„ç†æµé‡ï¼Œè¿›è¡Œè·¯ç”±åŒ¹é…ã€‚
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          codec_type: auto
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains:
              - "*"
              routes:
              - match:
                  prefix: "/"
                  headers:         #è§„åˆ™ 1ï¼šæŒ‰ header x-custom-version
                  - name: x-custom-version 
                    exact_match: pre-release
                    #è¯·æ±‚å¤´é‡Œå¸¦ x-custom-version: pre-release çš„æµé‡ â†’ è½¬åˆ° webcluster1 ä¸­ ç‰ˆæœ¬ 1.2-pre ä¸” stage=dev çš„å­é›†
                route:
                  cluster: webcluster1
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        version: "1.2-pre"
                        stage: "dev"
              - match:
                  prefix: "/"
                  headers:  #è§„åˆ™ 2ï¼šæŒ‰ header x-hardware-test
                  - name: x-hardware-test
                    exact_match: memory
              #è¯·æ±‚å¤´é‡Œå¸¦ x-hardware-test: memory â†’ è½¬åˆ° prod ç¯å¢ƒçš„ bigmem èŠ‚ç‚¹ã€‚
                route:
                  cluster: webcluster1
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        type: "bigmem"
                        stage: "prod"
              - match:      #è§„åˆ™ 3ï¼šé»˜è®¤ (åŠ æƒåˆ†æµ)ï¼šæ²¡æœ‰ç‰¹å®š headerï¼Œå°±æŒ‰æƒé‡åˆ†æµ
                  prefix: "/"
                route:
                  weighted_clusters:
                    clusters:
                    - name: webcluster1
                      weight: 90
                      metadata_match:
                        filter_metadata:
                          envoy.lb:
                            version: "1.0"
                    - name: webcluster1
                      weight: 10
                      metadata_match:
                        filter_metadata:
                          envoy.lb:
                            version: "1.1"
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        stage: "prod"
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  - name: webcluster1
    connect_timeout: 0.5s
    type: STRICT_DNS            #é€šè¿‡ DNS è§£ææˆå‘˜åœ°å€
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: webcluster1
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: e1
                port_value: 80
          metadata:               #ç»™æ¯ä¸€ä¸ªendpointå¸¦ä¸Šmetadata
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.0"
                type: "std"
                xlarge: true
        - endpoint:
            address:
              socket_address:
                address: e2
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.0"
                type: "std"
        - endpoint:
            address:
              socket_address:
                address: e3
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.1"
                type: "std"
        - endpoint:
            address:
              socket_address:
                address: e4
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.1"
                type: "std"
        - endpoint:
            address:
              socket_address:
                address: e5
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.0"
                type: "bigmem"
        - endpoint:
            address:
              socket_address:
                address: e6
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "prod"
                version: "1.1"
                type: "bigmem"
        - endpoint:
            address:
              socket_address:
                address: e7
                port_value: 80
          metadata:
            filter_metadata:
              envoy.lb:
                stage: "dev"
                version: "1.2-pre"
                type: "std"
    lb_subset_config:
      fallback_policy: DEFAULT_SUBSET   #å¦‚æœå­é›†é€‰æ‹©å™¨æ‰¾ä¸åˆ°ï¼Œå°±é»˜è®¤å­é›†
      default_subset:            #é»˜è®¤å­é›†
        stage: "prod"
        version: "1.0"
        type: "std"
      subset_selectors:    #å­é›†é€‰æ‹©å™¨
      - keys: ["stage", "type"]
      - keys: ["stage", "version"]
      - keys: ["version"]
      - keys: ["xlarge", "version"]
      
```

```powershell
å‡è®¾ç”¨æˆ·è¯·æ±‚å¤´å‘½ä¸­ç¬¬ä¸‰æ¡è·¯ç”±ï¼š
è¿™ä¼šç”Ÿæˆä¸¤ä¸ªå€™é€‰å­é›†ï¼š
å­é›†1ï¼šstage=prod, version=1.0
å­é›†2ï¼šstage=prod, version=1.1

Envoy ä¼šï¼š
åœ¨ subset_selectors é‡Œæ‰¾æ˜¯å¦å…è®¸ stage+version â†’ âœ… å­˜åœ¨
å­é›†1 â†’ å‘½ä¸­ e1, e2
å­é›†2 â†’ å‘½ä¸­ e3, e4
æŒ‰æƒé‡ 90:10 æŠŠæµé‡æ‰“åˆ°è¿™ä¸¤ä¸ªå­é›†
```

#### 3.1.1.5ç†”æ–­

```powershell
ç†”æ–­ï¼ˆCircuit Breakerï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ç§ å®¹é”™ä¿æŠ¤æœºåˆ¶ã€‚
å½“ä¸Šæ¸¸æœåŠ¡å‡ºç°å¤§é‡é”™è¯¯ï¼ˆæ¯”å¦‚è¶…æ—¶ã€è¿æ¥å¤±è´¥ã€è¯·æ±‚é”™è¯¯ï¼‰æ—¶ï¼Œç†”æ–­å™¨ä¼šâ€œæ–­å¼€â€ï¼Œè®©è°ƒç”¨æ–¹ ç«‹å³å¤±è´¥è€Œä¸æ˜¯ç»§ç»­ç­‰å¾…ã€‚ç†”æ–­å¯ä»¥é˜²æ­¢é—®é¢˜æ‰©æ•£ï¼Œé¿å…æ•´ä¸ªç³»ç»Ÿé›ªå´©ï¼Œé›ªå´©æ˜¯ä¸Šæ¸¸æœåŠ¡åå‹ä¸‹æ¸¸æœåŠ¡å¯¼è‡´ä¸‹æ¸¸æœåŠ¡ä¹ŸæŒ‚äº†ã€‚

ç†”æ–­å™¨circuit breakerä¸€èˆ¬æœ‰ 3 ç§çŠ¶æ€ï¼š
Closedï¼ˆå…³é—­ï¼‰
æ­£å¸¸çŠ¶æ€ï¼Œè¯·æ±‚æ­£å¸¸è½¬å‘ã€‚
ç»Ÿè®¡å¤±è´¥ç‡ï¼Œå¦‚æœå¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼ï¼Œè¿›å…¥ Open çŠ¶æ€ã€‚
Openï¼ˆæ‰“å¼€ï¼‰
ç†”æ–­çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚ç«‹å³å¤±è´¥ï¼Œä¸å†è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ã€‚
é¿å…æ— æ•ˆçš„é‡è¯•è¯·æ±‚è¿›ä¸€æ­¥å‹å®ä¸‹æ¸¸ã€‚
Half-Openï¼ˆåŠå¼€ï¼‰
ç»è¿‡ä¸€æ®µå†·å´æ—¶é—´ï¼Œç†”æ–­å™¨ä¼šè®©éƒ¨åˆ†è¯·æ±‚è¯•æ¢æ€§åœ°æ”¾è¡Œã€‚
å¦‚æœè¯·æ±‚æˆåŠŸç‡é«˜ï¼Œåˆ‡å› Closedï¼›å¦‚æœç»§ç»­å¤±è´¥ï¼Œä¿æŒ Openã€‚

é¢‘ç¹è§¦å‘ç†”æ–­ä¼šå¯¼è‡´åå‹è°ƒåº¦æœåŠ¡å™¨ï¼Œå¯¼è‡´è°ƒåº¦æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ï¼Œå¦‚æœæ˜¯éå…³é”®æœåŠ¡å¯ä»¥é™çº§ï¼Œå…³é”®æœåŠ¡è¿›è¡Œé™æµï¼ˆå¼¹æ€§æ‰©å®¹é€Ÿåº¦å°äºæµé‡é€Ÿåº¦ï¼‰ï¼Œç”±æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°å¡«è°·ã€‚

è¿æ¥æ± 
   è¿æ¥ç®¡ç†å™¨

å¯ä½¿ç”¨å·¥å…·fortioè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä¾‹å¦‚
fortio load -c 2 -qps 0 -n 20 -loglevel Warning URL
-c å¹¶å‘æ•°  
QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰é™åˆ¶ = 0ï¼Œè¡¨ç¤º ä¸é™åˆ¶é€Ÿç‡ï¼Œå°½å¯èƒ½å¿«åœ°å‘è¯·æ±‚ã€‚
-n 20  è¯·æ±‚æ€»æ•° = 20ã€‚
-loglevel Warning URL  æ—¥å¿—çº§åˆ«ã€‚ç›®æ ‡åœ°å€
é¡¹ç›®åœ°å€ï¼šhttps://github.com/fortio/fortio
```

å…³äºä¸Šä¸‹æ¸¸

```powershell
æœåŠ¡ç½‘æ ¼/ç†”æ–­è§†è§’ (ä»æœåŠ¡è‡ªèº«çœ‹):
æœåŠ¡B è¯´ï¼šâ€œæœåŠ¡C æ˜¯æˆ‘çš„ä¸Šæ¸¸ï¼Œå› ä¸ºæˆ‘è°ƒç”¨å®ƒã€‚â€ï¼ˆè¿™é‡Œçš„â€œä¸Šæ¸¸â€æŒ‡â€œæˆ‘ä¾èµ–çš„æœåŠ¡â€ï¼‰
è¿™ç§å®šä¹‰å¼ºè°ƒä¾èµ–å…³ç³»ï¼šæˆ‘ï¼ˆä¸‹æ¸¸ï¼‰ä¾èµ–ä½ ï¼ˆä¸Šæ¸¸ï¼‰ã€‚
é“¾è·¯è¿½è¸ªè§†è§’ (ä»è¯·æ±‚æµåŠ¨çœ‹):
æœåŠ¡B è¯´ï¼šâ€œæœåŠ¡A æ˜¯æˆ‘çš„ä¸Šæ¸¸ï¼ˆè¯·æ±‚æ¥æºï¼‰ï¼ŒæœåŠ¡C æ˜¯æˆ‘çš„ä¸‹æ¸¸ï¼ˆè¯·æ±‚å»å‘ï¼‰ã€‚â€
è¿™ç§å®šä¹‰å¼ºè°ƒæ•°æ®æµæ–¹å‘ï¼šè¯·æ±‚ä»ä¸Šæ¸¸æ¥ï¼Œå‘ä¸‹æ¸¸å»ã€‚
```

```powershell
  clusters:
  - name: webcluster1
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: webcluster1
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: webservice1
                port_value: 80
    #è¿æ¥çº§åˆ«çš„ç†”æ–­ï¼ˆCircuit Breakersï¼‰ï¼Œè®¾è¿™ä¹ˆå°æ˜¯ä¸ºäº†æµ‹è¯•å‡ºæ•ˆæœ
    #è¿™é‡Œçš„ ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰ ä¸»è¦æ˜¯ è°ƒç”¨æ–¹ä¾§ï¼ˆEnvoy â†’ upstreamï¼‰å¯¹èµ„æºçš„ä¿æŠ¤ï¼Œé™åˆ¶è‡ªå·±å¯¹ä¸‹æ¸¸çš„è°ƒç”¨å‹åŠ›ï¼Œé˜²æ­¢è°ƒç”¨æ–¹å› ä¸ºä¸‹æ¸¸æ…¢æˆ–ä¸å¯ç”¨è€Œè¢«æ‹–å®ã€‚é¿å…è¿æ¥æ•°è¿‡å¤šï¼Œæ’‘çˆ† Envoy çš„çº¿ç¨‹/å†…å­˜ã€‚é¿å…è¯·æ±‚æ— é™æ’é˜Ÿï¼Œå¯¼è‡´è¯·æ±‚å †ç§¯é›ªå´©ã€‚é¿å…ç–¯ç‹‚é‡è¯•ï¼ŒæŠŠè‡ªå·±ä¹ŸææŒ‚
    circuit_breakers:
      thresholds:              #ä¸‹é¢æ˜¯è¿æ¥æ± é…ç½®å’Œç†”æ–­å™¨é…ç½®
        max_connections: 1      #åŒæ—¶æœ€å¤šåªèƒ½å’Œè¿™ä¸ª cluster å»ºç«‹ 1 ä¸ªå¹¶å‘è¿æ¥
        max_pending_requests: 1  #æœ€å¤šå…è®¸æŒ‚èµ· 1 ä¸ªï¼Œè¶…è¿‡å°±æ‹’ç»ã€‚
        max_retries: 3  #æ¯ä¸ªè¯·æ±‚æœ€å¤šå°è¯• 3 æ¬¡é‡è¯•ï¼Œè¶…è¿‡å°±å¤±è´¥ï¼Œä¸ä¼šæ— é™é‡è¯•
    #è¿™ç§å±äºç¡¬æ€§å¹¶å‘æ§åˆ¶ï¼Œé˜²æ­¢çŸ­æ—¶é—´å†…å¤ªå¤šè¯·æ±‚æŠŠæœåŠ¡å‹çˆ†

  - name: webcluster2
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: webcluster2
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: webservice2
                port_value: 80
    #æŠŠä¸å¥åº·çš„ä¸‹æ¸¸å®ä¾‹å‰”é™¤ï¼Œé¿å…ç»§ç»­è·¯ç”±è¿‡å»ã€‚
    outlier_detection:
      interval: "1s"
      consecutive_5xx: "3"
      consecutive_gateway_failure: "3"
      base_ejection_time: "10s"          #è¢«è¸¢å‡ºçš„å®ä¾‹è‡³å°‘ä¼‘æ¯ 10 ç§’ï¼Œå†å°è¯•æ¢å¤
      enforcing_consecutive_gateway_failure: "100"
      max_ejection_percent: "30"   #æœ€å¤šåªèƒ½å‰”é™¤ 30% çš„å®ä¾‹ï¼Œé¿å…å…¨è¸¢å…‰å¯¼è‡´é›ªå´©
      success_rate_minimum_hosts: "2" #è‡³å°‘æœ‰ 2 ä¸ªå®ä¾‹æ—¶ï¼Œæ‰å¯ç”¨åŸºäºæˆåŠŸç‡çš„åˆ¤å®š
```

#### 3.1.1.6httpæµé‡æ²»ç†

![image-20250828122412561](image-20250828122412561.png)

```powershell
è·¯ç”±åŒ¹é…ï¼šç²¾ç¡®åŒ¹é…å†™åœ¨ä¸Šé¢ï¼Œè‡ªä¸Šè€Œä¸‹ï¼Œæœ€åå†+é»˜è®¤åŒ¹é…ã€‚å…ˆæŒ‰ä¸Šä¸‹é¡ºåºåæŒ‰ç²¾ç¡®æ€§
å…ˆåŒ¹é…ç²¾å‡†ï¼Œå†å·¦é€šé…->å³é€šé…->*

è·¯ç”±ç›®æ ‡ä¹‹ä¸€ï¼šè·¯ç”±åˆ°æŒ‡å®šé›†ç¾¤:cluster,cluster_header,weighted_clusters...
è·¯ç”±ç›®æ ‡ä¹‹äºŒï¼šé‡å®šå‘:åè®®é‡å®šå‘/ä¸»æœºé‡å®šå‘/ç«¯å£é‡å®šå‘/è·¯å¾„é‡å®šå‘...
è·¯ç”±ç›®æ ‡ä¹‹ä¸‰ï¼šç›´æ¥å“åº”è¯·æ±‚:
{
"status": "...",
"body": "{...}"
}

ç°åº¦å‘å¸ƒï¼šé‡‘ä¸é›€/è“ç»¿/ABæµ‹è¯•/æµé‡é•œåƒ
ç°åº¦ç­–ç•¥ï¼šâ€œåŸºäºè¯·æ±‚å†…å®¹å‘å¸ƒâ€ï¼ˆcookieæˆ–headerï¼‰å’Œâ€œåŸºäºæµé‡æ¯”ä¾‹å‘å¸ƒâ€ä¸¤ç§ç±»å‹
å®æ–½æ–¹å¼ï¼š
1.åŸºäºè´Ÿè½½å‡è¡¡å™¨è¿›è¡Œç°åº¦å‘å¸ƒ:ä»…æ”¯æŒå¯¹å…¥å£æœåŠ¡è¿›è¡Œç°åº¦ï¼Œæ— æ³•æ”¯æ’‘åç«¯æœåŠ¡éœ€æ±‚
2.åŸºäºKubernetesè¿›è¡Œç°åº¦å‘å¸ƒ:æ ¹æ®æ–°æ—§ç‰ˆæœ¬åº”ç”¨æ‰€åœ¨çš„Podæ•°é‡æ¯”ä¾‹è¿›è¡Œæµé‡åˆ†é…
3.åŸºäºæœåŠ¡ç½‘æ ¼è¿›è¡Œç°åº¦å‘å¸ƒï¼šé€šè¿‡æ§åˆ¶å¹³é¢ï¼Œå°†æµé‡é…ç½®ç­–ç•¥åˆ†å‘è‡³å¯¹ç›®æ ‡æœåŠ¡çš„è¯·æ±‚å‘èµ·æ–¹çš„envoy sidecarä¸Šå³å¯

æµé‡è¿ç§»å’Œæµé‡åˆ†å‰²ï¼Œæ„Ÿè§‰å·®ä¸å¤šçš„æ„æ€ï¼Œå°±æ˜¯é…ç½®ä¸ä¸€æ ·

æµé‡é•œåƒ/æµé‡å¤åˆ¶/å½±å­é•œåƒï¼šç±»ä¼¼äºå…¨é“¾è·¯æµ‹è¯•çš„å½±å­ç¯å¢ƒï¼ˆç”Ÿäº§ç¯å¢ƒéš”åšç¦»æµ‹è¯•ç”Ÿäº§ç¯å¢ƒçš„ç“¶é¢ˆï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯å½±å­é•œåƒï¼Œå°†åŒæ ·çš„è¯·æ±‚å†åšä¸€æ¬¡è½¬å‘åˆ°å½±å­ç¯å¢ƒä¸­ã€‚
```

æµé‡è¿ç§»

```yaml
curl -XPOST 'http://front_envop_ip:admin_port/runtime_modify?routing.traffic_shift.demoapp=90'

---
admin:
  profile_path: /tmp/envoy.prof
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
       address: 0.0.0.0
       port_value: 9901

layered_runtime:
  layers:
  - name: admin
    admin_layer: {}
       
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 80 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: demoapp
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                  #ç”¨æˆ·å†é€šè¿‡ä¸æ–­åœ°é€šè¿‡Envoyçš„adminæ¥å£ä¿®æ”¹runtime_fractionå¯¹è±¡çš„å€¼å®Œæˆæµé‡è¿ç§»
                  runtime_fraction:
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                    runtime_key: routing.traffic_shift.demoapp
                route:
                  cluster: demoappv10
              - match:
                  prefix: "/"
                route:
                  cluster: demoappv11
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
```

æµé‡åˆ†å‰²

```yaml
curl -XPOST 'http://172.31.57.10:9901/runtime_modify?routing.traffic_split.demoapp.demoappv10=0&routing.traffic_split.demoapp.demoappv11=100'
---

          route_config:
            name: local_route
            virtual_hosts:
            - name: demoapp
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  weighted_clusters:
                    clusters:
                    - name: demoappv10
                      weight: 100
                    - name: demoappv11
                      weight: 0
                    total_weight: 100
                    runtime_key_prefix: routing.traffic_split.demoapp
```

æµé‡é•œåƒ:å¯ä»¥ç›¸åŒç‰ˆæœ¬ä¹Ÿå¯ä»¥ä¸åŒç‰ˆæœ¬ï¼Œçœ‹éœ€æ±‚

```powershell
curl -XPOST 'http://172.31.60.10:9901/runtime_modify?routing.request_mirror.demoapp=100'
---
          route_config:
            name: local_route
            virtual_hosts:
            - name: demoapp
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: demoappv10
                  request_mirror_policies:      ##æµé‡é•œåƒ
                  - cluster: demoappv11
                    runtime_fraction:
                      default_value:
                        numerator: 20         ##åˆ†å­
                        denominator: HUNDRED    ###åˆ†æ¯
                      runtime_key: routing.request_mirror.demoapp
```

#### 3.1.1.7æœåŠ¡éŸ§æ€§

```powershell
æ•…éšœæ³¨å…¥ï¼šç®—æ˜¯æ··æ²Œå·¥ç¨‹çš„å­é›†
æ•…éšœæ³¨å…¥çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†æ¨¡æ‹Ÿä¸Šæ¸¸ä¸ç¨³å®šã€ç½‘ç»œå»¶è¿Ÿæˆ–æœåŠ¡é”™è¯¯ï¼Œä»è€Œæµ‹è¯•è°ƒç”¨æ–¹åº”ç”¨çš„ è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ã€é™çº§ç­‰å®¹é”™é€»è¾‘ã€‚
Abort æ³¨å…¥ï¼šEnvoy ä¼šæ‹¦æˆªå¹¶ç›´æ¥è¿”å› 5xxï¼Œä¸ä¼šæŠŠæµé‡çœŸæ­£å‘åˆ° Bã€‚
Delay æ³¨å…¥ï¼šEnvoy ä¼šå…ˆå»¶è¿Ÿä¸€æ®µæ—¶é—´å†è½¬å‘è¯·æ±‚ç»™ Bã€‚

è¶…æ—¶é‡è¯•ï¼šé¿å…è¯·æ±‚æ— é™ç­‰å¾…ï¼Œåœ¨çŸ­æš‚æ•…éšœä¸‹å¢åŠ è¯·æ±‚æˆåŠŸç‡
è¶…æ—¶å¯ä»¥è§¦å‘ é‡è¯•ã€é™çº§ã€ç†”æ–­ï¼Œè®©ç³»ç»Ÿå¿«é€Ÿæ¢å¤æˆ–åˆ‡æ¢å¤‡ç”¨é€»è¾‘ã€‚

è·¨åŸŸï¼šåè®® + åŸŸå + ç«¯å£ï¼Œä¸‰ä¸ªè¦ç´ ä¸­ä»»æ„ä¸€ä¸ªä¸åŒï¼Œå°±ç®—è·¨åŸŸ
http://example.com:80 -> https://example.com:443 æ˜¯è·¨åŸŸï¼ˆåè®®ä¸åŒï¼‰
CORSï¼ˆCross-Origin Resource Sharingï¼‰ï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰ï¼š
å…è®¸å‰ç«¯æµè§ˆå™¨è·¨åŸŸè®¿é—® API
ä¸æµè§ˆå™¨çš„ CORS æœºåˆ¶é…åˆï¼Œå®ç°å®‰å…¨çš„è·¨åŸŸèµ„æºå…±äº«
é…ç½®åœ¨ Envoy ä¸Šï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†ç½‘å…³çº§çš„è·¨åŸŸç­–ç•¥

æ•´ä¸ªè¯·æ±‚é“¾åªè¦æœ‰ä¸€å¤„æ²¡å¼€å¯corsï¼Œå°±=æ²¡å¼€å¯corsï¼Œè·¯ç”±corsä¼šè¦†ç›–è™šæ‹Ÿä¸»æœºcorsé…ç½®ï¼Œéƒ½æ˜¯åŒ…å«å…³ç³»ï¼Œå°±åƒå…¬å¸å¤§é—¨->æ¥¼é—¨->åŠå…¬å®¤
```

```yaml
  listeners:
  - name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 10000
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"          # åŒ¹é…æ‰€æœ‰è¯·æ±‚
                route:
                  cluster: service_backend
                  timeout: 3s          # æ•´ä¸ªè¯·æ±‚è¶…æ—¶ï¼ˆé»˜è®¤ 15sï¼‰
                  idle_timeout: 10s    # ç©ºé—²è¿æ¥è¶…æ—¶
                  retry_policy:
                    retry_on: "5xx,gateway-error,connect-failure,reset" # å“ªäº›æƒ…å†µè§¦å‘é‡è¯•
                    num_retries: 3           # æœ€å¤šé‡è¯• 3 æ¬¡
                    per_try_timeout: 1s      # æ¯æ¬¡é‡è¯•è¶…æ—¶
                    host_selection_retry_max_attempts: 3
          http_filters:
          - name: envoy.filters.http.fault   # æ•…éšœæ³¨å…¥è¿‡æ»¤å™¨
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              delay:                         # æ³¨å…¥å»¶è¿Ÿ
                fixed_delay: 2s              # å›ºå®šå»¶è¿Ÿ 2 ç§’
                percentage:
                  numerator: 50              # 50% è¯·æ±‚å»¶è¿Ÿ
                  denominator: HUNDRED
              abort:                         # æ³¨å…¥é”™è¯¯
                http_status: 503             # è¿”å› 503 é”™è¯¯
                percentage:
                  numerator: 10              # 10% è¯·æ±‚ç›´æ¥å¤±è´¥
                  denominator: HUNDRED
          - name: envoy.filters.http.router  # è·¯ç”±è¿‡æ»¤å™¨ï¼ˆå¿…é¡»æœ‰ï¼‰
          
---
å®¢æˆ·ç«¯ A
   |
   | å‘èµ·è¯·æ±‚
   v
Envoy Sidecar (è°ƒç”¨æ–¹ï¼Œegress)
   |
   |--- æ•…éšœæ³¨å…¥æ£€æŸ¥ ---
   |     â”œâ”€ 10% Abort â†’ ç›´æ¥è¿”å› 503
   |     â””â”€ 50% Delay â†’ ç­‰å¾… 2s å†è½¬å‘
   |
   |--- è½¬å‘è¯·æ±‚åˆ°åç«¯ ---
   v
åç«¯æœåŠ¡ B
   |
   | å¤„ç†è¯·æ±‚
   v
Envoy Sidecar (è¿”å›è·¯å¾„)
   |
   | è¶…æ—¶æ£€æŸ¥ï¼šper_try_timeout=1s, timeout=3s
   | å¦‚æœè¶…æ—¶ï¼Œä¸” retry_on å‘½ä¸­ â†’ é‡è¯•æœ€å¤š 3 æ¬¡
   |
   | è¿”å›å“åº”æˆ–æœ€ç»ˆé”™è¯¯
   v
å®¢æˆ·ç«¯ A
```

CORSï¼šç½‘ç»œå¿…é¡»ä¸€å±‚ä¸€å±‚éƒ½æœ‰cors

```yaml
listeners:
- address:
    socket_address:
      address: 0.0.0.0
      port_value: 80                # Envoy ç›‘å¬ 80 ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚
  filter_chains:
  - filters:
    - name: envoy.http_connection_manager
      typed_config:
        "@type": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
        codec_type: auto
        stat_prefix: ingress_http
        access_log:
          - name: envoy.file_access_log
            typed_config:
              "@type": type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog
              path: "/var/log/access.log"  # è¯·æ±‚æ—¥å¿—å­˜æ”¾ä½ç½®
        route_config:
          name: local_route
          virtual_hosts:
          - name: www
            domains:
            - "*"                        # åŒ¹é…æ‰€æœ‰åŸŸå
            cors:                        # ğŸŒŸ è™šæ‹Ÿä¸»æœºçº§åˆ« CORS é…ç½®
              allow_origin:
              - "*"                        # å…è®¸ä»»æ„æ¥æº
              allow_methods: "GET"         # å…è®¸çš„ HTTP æ–¹æ³•
              filter_enabled:               # æ˜¯å¦å¼€å¯ CORS
                default_value:
                  numerator: 100
                  denominator: HUNDRED     # é»˜è®¤ 100% å¼€å¯
                runtime_key: cors.www.enabled
              shadow_enabled:               # æ˜¯å¦å½±å­æ¨¡å¼ï¼ˆä»…è®°å½•ä¸ç”Ÿæ•ˆï¼‰
                default_value:
                  numerator: 0
                  denominator: HUNDRED
                runtime_key: cors.www.shadow_enabled
            routes:                         # ğŸŒŸ è·¯ç”±é…ç½®
            - match:
                prefix: "/cors/open"
              route:
                cluster: backend_service    # ç»§æ‰¿è™šæ‹Ÿä¸»æœº CORS
            - match:
                prefix: "/cors/disabled"
              route:
                cluster: backend_service
                cors:
                  filter_enabled:           # è·¯ç”±çº§åˆ«å…³é—­ CORS
                    default_value:
                      numerator: 0
                      denominator: HUNDRED
            - match:
                prefix: "/cors/restricted"
              route:
                cluster: backend_service
                cors:                       # è·¯ç”±çº§åˆ«è¦†ç›–è™šæ‹Ÿä¸»æœº
                  allow_origin:
                  - "envoyproxy.io"        # åªå…è®¸ç‰¹å®šæ¥æº
                  allow_methods: "GET"
            - match:
                prefix: "/"
              route:
                cluster: backend_service   # é»˜è®¤è·¯ç”±ï¼Œç»§æ‰¿è™šæ‹Ÿä¸»æœº CORS
        http_filters:
        - name: envoy.cors               # ğŸŒŸ CORS è¿‡æ»¤å™¨
          typed_config: {}               # ä½¿ç”¨é»˜è®¤è¡Œä¸º
                                          # æ ¹æ®è·¯ç”±/è™šæ‹Ÿä¸»æœºé…ç½®å†³å®šæ˜¯å¦åœ¨å“åº”å¤´æ³¨å…¥ Access-Control-Allow-*
        - name: envoy.router             # è·¯ç”±è¿‡æ»¤å™¨ï¼Œè½¬å‘è¯·æ±‚åˆ° cluster
          typed_config: {}
```

#### 3.1.1.8å¯è§‚æµ‹æ€§

```powershell
Envoy statsï¼šEnvoy å†…éƒ¨ä¼šæ”¶é›†å„ç§æŒ‡æ ‡ï¼ŒåŒ…æ‹¬ï¼š
è¯·æ±‚æ•°ã€è¯·æ±‚å»¶è¿Ÿã€å“åº”çŠ¶æ€ç åˆ†å¸ƒ
é›†ç¾¤å¥åº·çŠ¶æ€ã€è¿æ¥æ•°ã€é‡è¯•æ¬¡æ•°ç­‰

Sinkï¼šå°†è¿™äº›æŒ‡æ ‡å‘é€åˆ°å¤–éƒ¨ç›‘æ§ç³»ç»Ÿ,æ¨ç»™exporter,promå†æ‹‰

StatsD Sink å°±æ˜¯ å°† Envoy ç»Ÿè®¡ä¿¡æ¯å‘é€åˆ° StatsD ç³»ç»Ÿ çš„æ¥å£

StatsD Exporterï¼šä¸Šä¸‹æ¸¸è¯·æ±‚æŒ‡æ ‡ï¼Œè¿æ¥æ•°æŒ‡æ ‡ï¼Œä¸­æ–­ï¼Œé‡è¯•ï¼Œå¥åº·ç­‰ï¼ˆå¦‚æœæ˜¯servicemeshï¼ŒåŸºæœ¬æ˜¯sidecar/daemonsetï¼‰
access_logï¼šfilebeatæ”¶é›†ï¼ˆä¸€èˆ¬æ˜¯daemonsetï¼‰

åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªï¼š
é¡¶å±‚ tracing â†’ å¿…é¡»é…ç½®ï¼ˆå¦åˆ™æ²¡ traceï¼‰ã€‚
Filter tracing â†’ å¯é€‰ï¼Œç”¨äºç²¾ç»†åŒ–æ§åˆ¶ã€‚
æ³¨æ„:
åªéœ€è¦è·¨æœåŠ¡è¯·æ±‚é“¾è·¯ â†’ Envoy tracing å°±å¤Ÿäº†ï¼Œä¸ç”¨åŠ  Java agentã€‚
éœ€è¦åº”ç”¨å†…éƒ¨æ–¹æ³•çº§è°ƒç”¨é“¾ â†’ è¿˜éœ€è¦ skywalking-agent.jarã€‚

Envoy å¤„ç†è¿½è¸ªçš„æ­¥éª¤
å½“ Envoy ä½œä¸º sidecar æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œè¿½è¸ªé€»è¾‘æ˜¯è¿™æ ·çš„ï¼š
1ï¸âƒ£ å…¥ç«™è¯·æ±‚ï¼ˆClient â†’ Envoy â†’ Appï¼‰
Envoy æ¥æ”¶è¯·æ±‚ï¼Œæ£€æŸ¥ HTTP Headers ä¸­æ˜¯å¦æœ‰ Trace ä¸Šä¸‹æ–‡ï¼ˆä¸åŒåç«¯ç”¨ä¸åŒ headerï¼Œä¾‹å¦‚ï¼š
Zipkin/Jaeger: x-b3-traceid, x-b3-spanid, x-b3-sampled
W3C Trace Context: traceparent
SkyWalking: sw8
å¦‚æœ æœ‰è¿½è¸ªä¸Šä¸‹æ–‡ï¼šEnvoy å¤ç”¨è¯¥ Trace IDã€‚
å¦‚æœ æ²¡æœ‰ä¸Šä¸‹æ–‡ï¼šEnvoy ä¼š ç”Ÿæˆä¸€ä¸ªæ–°çš„ Trace ID / Span IDï¼Œå¹¶æ‰“ä¸Šé‡‡æ ·æ ‡è®°ã€‚
Envoy æŠŠ header è½¬å‘ç»™åº”ç”¨ï¼ˆApp Aï¼‰ï¼Œè®©åº”ç”¨ä¹Ÿèƒ½æ„ŸçŸ¥ traceï¼ˆå¦‚æœåº”ç”¨æœ‰æ¥å…¥ agentï¼Œä¾‹å¦‚ SkyWalking Agentï¼‰ã€‚
2ï¸âƒ£ å‡ºç«™è¯·æ±‚ï¼ˆApp â†’ Envoy â†’ ä¸‹æ¸¸ Serviceï¼‰
å½“åº”ç”¨è°ƒç”¨ä¸‹æ¸¸æœåŠ¡æ—¶ï¼Œæµé‡å…ˆåˆ° Envoyï¼ˆsidecarï¼‰ã€‚
Envoy æ‹¿åˆ°è¯·æ±‚åï¼Œä¼š æ’å…¥/ä¿®æ”¹ Trace Headersï¼Œä¿è¯ Trace ID/Span ID èƒ½åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¼ é€’ã€‚
Envoy æŠŠè¿™äº› header æ³¨å…¥åˆ°ä¸‹æ¸¸ HTTP/gRPC è¯·æ±‚ä¸­ã€‚
ä¸‹æ¸¸ Envoy æ”¶åˆ°è¯·æ±‚æ—¶å°±èƒ½ç»§ç»­é“¾è·¯ã€‚
3ï¸âƒ£ ä¸ŠæŠ¥ Tracing åç«¯
Envoy åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®ç”Ÿæˆ span ä¿¡æ¯ï¼ˆåŒ…æ‹¬ï¼šå¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€ä¸Šæ¸¸/ä¸‹æ¸¸æœåŠ¡åã€é”™è¯¯ç ç­‰ï¼‰ã€‚
è¿™äº› span ä¼šè¢«å¼‚æ­¥å‘é€åˆ° tracing collectorï¼Œä¾‹å¦‚ï¼š
Jaeger (Zipkin åè®® / gRPC)
Zipkin (HTTP JSON)
SkyWalking (gRPC)
è¿™æ ·ï¼ŒTracing åç«¯å°±èƒ½æ‹¼å‡º A â†’ B â†’ C çš„å®Œæ•´è°ƒç”¨é“¾ã€‚

å¯¹æ¯”ï¼š
å¦‚æœåªé åº”ç”¨ Agentï¼ˆå¦‚ skywalking-agent.jarï¼‰ï¼šé“¾è·¯åªè¦†ç›–åº”ç”¨å†…éƒ¨è°ƒç”¨ã€‚
å¦‚æœé  Envoy sidecarï¼šå³ä½¿åº”ç”¨æ²¡æ¥å…¥ Agentï¼Œä¹Ÿèƒ½æ‹¿åˆ°â€œé»‘ç›’â€è°ƒç”¨é“¾ï¼ˆä»å…¥å£åˆ°å‡ºå£ï¼‰ã€‚
æœ€ä½³å®è·µï¼šåº”ç”¨ Agent + Envoy sidecar ç»“åˆï¼Œèƒ½çœ‹åˆ°æœ€å®Œæ•´çš„é“¾è·¯ï¼ˆåº”ç”¨å†…éƒ¨æ–¹æ³•çº§ + æœåŠ¡è°ƒç”¨çº§ï¼‰ã€‚
```

statsd exporter

```powershell
---envoy
stats_sinks:
- name: envoy.stats_sinks.statsd
  typed_config:
    "@type": type.googleapis.com/envoy.config.metrics.v3.StatsdSink
    address:
      socket_address:
        address: 127.0.0.1   # StatsD Exporter æ‰€åœ¨åœ°å€
        port_value: 9125      # StatsD Exporter é»˜è®¤ UDP ç«¯å£
    prefix: envoy            # æŒ‡æ ‡å‰ç¼€,å¦‚front-envoy
    flush_interval: 500ms    # æŒ‡æ ‡å‘é€é—´éš”
    
---
statsd_exporter \
  --statsd.listen-udp :9125 \
  --web.listen-address :9102 \
  --metric-prefix envoy
  
---prom
scrape_configs:
- job_name: 'envoy_statsd'
  static_configs:
  - targets: ['statsd-exporter:9102']
```

æ”¶é›†è®¿é—®æ—¥å¿—

```yaml
http_filters:
- name: envoy.router
  typed_config: {}

access_log:
- name: envoy.access_loggers.file
  typed_config:
    "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
    path: /var/log/envoy/access.log   # æ—¥å¿—æ–‡ä»¶è·¯å¾„
    log_format:
      text_format_source:
        inline_string: "[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %UPSTREAM_HOST%\n"

---filebeat-configmap
#è‡ªåŠ¨å‘ç°ï¼ˆautodiscoverï¼‰æœºåˆ¶ï¼Œè®© Filebeat èƒ½æ ¹æ® Pod ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨å¼€å§‹/åœæ­¢æ”¶é›†æ—¥å¿—ï¼Œè€Œä¸æ˜¯å†™æ­»è·¯å¾„
filebeat.autodiscover:
  providers:
    - type: kubernetes
      node: ${NODE_NAME}
      hints.enabled: true  # æ”¯æŒé€šè¿‡ annotation æç¤ºæ”¶é›†
      ##å¦‚æœ Pod ä¸Šæœ‰ co.elastic.logs/enabled: "true" è¿™æ ·çš„ annotationï¼ŒFilebeat ä¼šè‡ªåŠ¨é‡‡é›†ã€‚
      templates:
        ##å¦‚æœå®¹å™¨å = envoyï¼Œå°±åº”ç”¨ä¸‹é¢çš„ config
        - condition:
            equals:
              kubernetes.container.name: "envoy"
          config:
            - type: container
              paths:
              #å®¹å™¨æ—¥å¿—æ–‡ä»¶è·¯å¾„ã€‚K8s é»˜è®¤æŠŠ stdout/stderr ä¿å­˜åˆ° /var/log/containers/*.logï¼Œè¿™é‡Œç”¨å®¹å™¨ ID æ¥ç¡®ä¿æ–‡ä»¶å”¯ä¸€ã€‚
                - /var/log/containers/*-${data.kubernetes.container.id}.log
              fields:            #ç»™æ—¥å¿—åŠ ä¸€ä¸ªè‡ªå®šä¹‰å­—æ®µ service: envoyï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡
                service: envoy
              fields_under_root: true

processors:
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      matchers:
        - logs_path:
            logs_path: "/var/log/containers/"

output.elasticsearch:
  hosts: ["http://elasticsearch:9200"]
  index: "k8s-logs-%{[kubernetes.container.name]}-%{+yyyy.MM.dd}"

```

åˆ†å¸ƒå¼è¿½è¸ª:zipkin/jaeger/skywalking

```powershell
tracing:
  provider:
    name: envoy.tracers.zipkin           #é€‰ç”¨ zipkin é©±åŠ¨
    typed_config:
      "@type": type.googleapis.com/envoy.config.trace.v3.ZipkinConfig
      collector_cluster: jaeger
      collector_endpoint: "/api/v2/spans"    ##ä¸ŠæŠ¥æ¥å£
      shared_span_context: false  #æ§åˆ¶ æ˜¯å¦åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­å…±äº«çˆ¶ span
      #ä¸€èˆ¬æ¨è falseï¼Œä¿è¯æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹ span
      collector_endpoint_version: HTTP_JSON #Envoy ä¼šæ ¹æ®è¿™é‡Œçš„è®¾ç½®åºåˆ—åŒ– span å‘é€
 
  clusters:
  - name: zipkin
    connect_timeout: 1s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: zipkin
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: zipkin, port_value: 9411 }
```

```powershell
tracing:
  http:
    name: envoy.tracers.zipkin   # Jaeger å…¼å®¹ Zipkin åè®®
    typed_config:
      "@type": type.googleapis.com/envoy.config.trace.v3.ZipkinConfig
      collector_cluster: jaeger
      collector_endpoint: "/api/v2/spans"
      trace_id_128bit: true

clusters:
- name: jaeger
  connect_timeout: 1s
  type: STRICT_DNS
  lb_policy: ROUND_ROBIN
  load_assignment:
    cluster_name: jaeger
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address: { address: jaeger-collector, port_value: 9411 } # æ³¨æ„ Jaeger 9411 Zipkin æ¥å£
```

```powershell
tracing:
  http:
    name: envoy.tracers.skywalking
    typed_config:
      "@type": type.googleapis.com/envoy.config.trace.v3.SkyWalkingConfig
      grpc_service:
        envoy_grpc:
          cluster_name: skywalking
        timeout: 0.25s

clusters:
- name: skywalking
  connect_timeout: 1s
  type: STRICT_DNS
  lb_policy: ROUND_ROBIN
  http2_protocol_options: {}
  load_assignment:
    cluster_name: skywalking
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            socket_address: { address: skywalking-oap, port_value: 11800 }
```

#### 3.1.1.9ç½‘æ ¼å®‰å…¨

```powershell
æœåŠ¡ç½‘æ ¼çš„å®‰å…¨é£é™©ä¸æ§åˆ¶
é£é™©æ¥æº
ç½‘ç»œå±‚ï¼šæœªç»æˆæƒçš„è®¿é—®ã€æµé‡åŠ«æŒã€ç›‘å¬ã€‚
åº”ç”¨å±‚ï¼šæ¥å£æ»¥ç”¨ã€èº«ä»½ä¼ªé€ ã€è¶Šæƒè®¿é—®ã€‚

å¸¸è§è§£å†³æ–¹æ¡ˆ
1.ç½‘ç»œçº§æ§åˆ¶æœºåˆ¶
    é™åˆ¶ IP/ç«¯å£è®¿é—®ã€‚
    ä½¿ç”¨ mTLS åŠ å¯†æœåŠ¡é—´é€šä¿¡ã€‚
    	TLSï¼šå•å‘åŠ å¯†ï¼Œå®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨è¯ä¹¦
    	mTLSï¼ˆåŒå‘ TLSï¼‰ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½éªŒè¯å¯¹æ–¹è¯ä¹¦ï¼Œå®ç°ç‚¹å¯¹ç‚¹èº«ä»½éªŒè¯ã€‚mTLS å¯ä»¥ä¿è¯æµé‡æœºå¯†æ€§å’Œæ¥æºå¯ä¿¡æ€§

2.åº”ç”¨çº§æ§åˆ¶æœºåˆ¶
OAuth 2.0ã€OpenID Connectï¼šç”¨äºç”¨æˆ·èº«ä»½è®¤è¯å’Œæˆæƒã€‚
JWTï¼ˆJSON Web Tokenï¼‰ï¼šè½»é‡çº§çš„åº”ç”¨é—´èº«ä»½è®¤è¯æ–¹æ¡ˆã€‚
	Authorization: Bearer <jwt_token>
	<header>ï¼ˆç®—æ³•å’Œtokenç±»å‹ï¼‰.<payload>ï¼ˆèº«ä»½ä¿¡æ¯ï¼‰.<signature>ï¼ˆç­¾åï¼‰
	JWKï¼šå…¬é’¥ä¿¡æ¯çš„ JSON æ ¼å¼ï¼Œç”¨äºéªŒè¯ JWT ç­¾åã€‚
	JWSï¼šç­¾ååçš„ JWTï¼Œä¿è¯å†…å®¹æœªç¯¡æ”¹ã€‚

å¯ä»¥ç†è§£ä¸ºï¼šç½‘ç»œçº§å®‰å…¨æ˜¯â€œç®¡é“å®‰å…¨â€ï¼Œåº”ç”¨çº§å®‰å…¨æ˜¯â€œè®¿é—®é—¨ç¦â€ã€‚

SPIFFE/SPIRE/SDS çš„ mTLS
	SPIFFEï¼šä¸ºæœåŠ¡ç”Ÿæˆå”¯ä¸€èº«ä»½æ ‡è¯†ï¼ˆSPIFFE IDï¼‰ã€‚
	SPIREï¼šSPIFFE çš„å®ç°ï¼Œç”¨äºå‘æ”¾å’Œç®¡ç†è¯ä¹¦ã€‚
	SDSï¼ˆSecret Discovery Serviceï¼‰ï¼šEnvoy è·å–è¯ä¹¦å’Œå¯†é’¥çš„æœºåˆ¶ã€‚xDS
åœ¨ Istio ç½‘æ ¼é‡Œï¼ŒIstiodï¼ˆæˆ– Istio Agentï¼‰å®ç° SDS åŠŸèƒ½ã€‚
åœ¨ SPIRE + Envoy åœºæ™¯é‡Œï¼ŒSPIRE Agent å®ç° SDSï¼ŒEnvoy æ‹‰å– SPIFFE è¯ä¹¦ã€‚

ç»Ÿä¸€çš„ CAï¼ˆæ ¹è¯ä¹¦ï¼‰ï¼šå¥½æ¯”ç»™æœåŠ¡å‘å¸¦ç£éªŒè¯çš„å‘˜å·¥ç‰Œ

Envoy æˆæƒ
RBACï¼ˆRole-Based Access Controlï¼‰
	åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ŒEnvoy å¯ä»¥æ ¹æ®è¯·æ±‚æ¥æºã€è·¯å¾„ã€æ–¹æ³•å†³å®šæ˜¯å¦å…è®¸è®¿é—®
å¤–éƒ¨æˆæƒå’Œ ABACï¼ˆAttribute-Based Access Controlï¼‰
	ABACï¼šåŸºäºå±æ€§ï¼ˆå¦‚ç”¨æˆ·ã€IPã€æ—¶é—´ã€æœåŠ¡æ ‡ç­¾ï¼‰åšè®¿é—®æ§åˆ¶ã€‚
	OPAï¼ˆOpen Policy Agentï¼‰ï¼šEnvoy å¯é€šè¿‡ OPA æ¥å¤–éƒ¨å†³ç­–æ˜¯å¦å…è®¸è¯·æ±‚ã€‚
		OPA ç­–ç•¥æœºåˆ¶ï¼šä½¿ç”¨ Rego è¯­è¨€å®šä¹‰è®¿é—®è§„åˆ™ã€‚
		Envoy OPA ç¤ºä¾‹ï¼šEnvoy å°†è¯·æ±‚ä¿¡æ¯å‘é€ç»™ OPAï¼ŒOPA è¿”å›æ˜¯å¦å…è®¸è®¿é—®ã€‚
```

tls/mtlsï¼šä¸€èˆ¬ä½œä¸ºé¡¹ç›®ç½‘å…³æ—¶åšssl/tlsç»ˆæ­¢ï¼Œè€Œå¯¹äºé›¶ä¿¡ä»»ç¯å¢ƒï¼ˆé«˜å®‰å…¨è¦æ±‚ï¼‰åˆ™è¦æœåŠ¡ä¸æœåŠ¡ä¹‹é—´éƒ½å¯ç”¨ï¼Œä¼šæœ‰æ€§èƒ½å¼€é”€ï¼ˆä½†ä¸€èˆ¬å¯æ¥å—ï¼ŒEnvoy + SPIRE ä¸‹å‘è¯ä¹¦å·²ç»æ¯”è¾ƒè½»é‡ï¼‰ï¼ŒæœåŠ¡ç½‘æ ¼æ¨èç”¨ã€‚

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 8443 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: service_backend }
          http_filters:
          - name: envoy.filters.http.router
      # é…ç½® TLS / mTLS
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:   # æœåŠ¡ç«¯è¯ä¹¦å’Œç§é’¥ï¼ˆEnvoyä½œä¸ºæœåŠ¡ç«¯æ—¶ä½¿ç”¨ï¼‰
              - certificate_chain: { filename: "/etc/envoy/certs/server.crt" }
                private_key: { filename: "/etc/envoy/certs/server.key" }
            validation_context: # é…ç½®æ­¤é¡¹å³å¯å¼€å¯ mTLSï¼ˆåŒå‘è®¤è¯ï¼‰
              trusted_ca:
                filename: "/etc/envoy/certs/ca.crt"
              match_subject_alt_names:
                - exact: "client.example.com"   # é™åˆ¶å®¢æˆ·ç«¯è¯ä¹¦ä¸­çš„ SAN å¿…é¡»åŒ¹é…
          require_client_certificate: true       # è¡¨ç¤ºå¯ç”¨ mTLSï¼Œå¿…é¡»éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦

  clusters:
  - name: service_backend
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: service_backend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: backend, port_value: 8080 }
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_certificates:   # å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆEnvoyä½œä¸ºå®¢æˆ·ç«¯æ—¶ä½¿ç”¨ï¼‰
            - certificate_chain: { filename: "/etc/envoy/certs/client.crt" }
              private_key: { filename: "/etc/envoy/certs/client.key" }
          validation_context: # æ ¡éªŒåç«¯æœåŠ¡ç«¯è¯ä¹¦
            trusted_ca:
              filename: "/etc/envoy/certs/ca.crt"
            match_subject_alt_names:
              - exact: "backend.example.com"
```

JWT/JWS/JWK â†’ éªŒè¯çš„æ˜¯ **ç”¨æˆ·/å®¢æˆ·ç«¯çš„èº«ä»½å’Œæƒé™**

```yaml
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 8080 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: service_backend }
          http_filters:
          # 1) JWT éªŒè¯è¿‡æ»¤å™¨
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                my_jwt_provider:                      # å®šä¹‰ä¸€ä¸ª JWT æä¾›æ–¹
                  issuer: "https://auth.example.com/" # JWT çš„ç­¾å‘è€… (iss å­—æ®µ)
                  audiences: ["my-service"]           # å…è®¸è®¿é—®çš„å—ä¼— (aud å­—æ®µ)
                  remote_jwks:    # ä»è¿œç¨‹æ‹‰å– JWK å…¬é’¥ï¼Œé€šå¸¸æ˜¯ IdP æä¾›ï¼Œå¦‚ Keycloak
                    http_uri:
                      uri: "https://auth.example.com/.well-known/jwks.json"
                      cluster: jwt_cluster
                      timeout: 5s
                    cache_duration: 600s              # ç¼“å­˜ JWK å…¬é’¥æ—¶é—´
                  forward: true                       # éªŒè¯æˆåŠŸåï¼Œå°† JWT ç»§ç»­è½¬å‘ç»™åç«¯
              rules:
              - match:
                  prefix: "/"                         # å“ªäº›è·¯ç”±éœ€è¦åš JWT éªŒè¯
                requires:
                  provider_name: "my_jwt_provider"    # æŒ‡å®šä½¿ç”¨å“ªä¸ª provider
          # 2) è·¯ç”±è¿‡æ»¤å™¨
          - name: envoy.filters.http.router

  clusters:
  # åç«¯æœåŠ¡
  - name: service_backend
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: service_backend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: backend, port_value: 9000 }

  # ç”¨äºè·å– JWK å…¬é’¥çš„ cluster
  - name: jwt_cluster
    connect_timeout: 1s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: jwt_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: auth.example.com, port_value: 443 }
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
```

SPIFFE/SPIRE/SDS

```yaml
static_resources:
  listeners:
    - name: listener_0
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8443
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: backend
                      domains: ["*"]
                      routes:
                        - match: { prefix: "/" }
                          route: { cluster: service_backend }
                http_filters:
                  - name: envoy.filters.http.router
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              #æœåŠ¡ç«¯è¯ä¹¦ï¼Œé€šè¿‡ SDS è·å– SPIFFE å·¥ä½œè´Ÿè½½è¯ä¹¦
              common_tls_context:
                tls_certificate_sds_secret_configs:
                  - name: spiffe_cert          ## SDS secret åç§°
                    sds_config:
                      api_config_source:
                        api_type: GRPC
                        grpc_services:
                          - envoy_grpc:
                              cluster_name: sds_server # SPIRE Agent æä¾›çš„ SDS gRPC
                # å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼Œä¿è¯åªå…è®¸åˆæ³• SPIFFE ID çš„å®¢æˆ·ç«¯è®¿é—®
                validation_context_sds_secret_config:
                  name: spiffe_root   # æ ¹è¯ä¹¦
                  sds_config:
                    api_config_source:
                      api_type: GRPC
                      grpc_services:
                        - envoy_grpc:
                            cluster_name: sds_server
                            
  clusters:
    - name: service_backend
      connect_timeout: 0.25s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: service_backend
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: backend-service.default.svc.cluster.local
                      port_value: 8443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
           # å®¢æˆ·ç«¯è¯ä¹¦ï¼Œé€šè¿‡ SDS è·å– SPIFFE å·¥ä½œè´Ÿè½½è¯ä¹¦
          common_tls_context:
            tls_certificate_sds_secret_configs:
              - name: spiffe_cert
                sds_config:
                  api_config_source:
                    api_type: GRPC
                    grpc_services:
                      - envoy_grpc:
                          cluster_name: sds_server
            # éªŒè¯ä¸Šæ¸¸æœåŠ¡è¯ä¹¦ï¼Œä¿è¯è¯·æ±‚åªå‘å‘åˆæ³• SPIFFE ID çš„æœåŠ¡              
            validation_context_sds_secret_config:
              name: spiffe_root
              sds_config:
                api_config_source:
                  api_type: GRPC
                  grpc_services:
                    - envoy_grpc:
                        cluster_name: sds_server
```

[Microservice App]
        â”‚
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Envoy Sidecar â”‚  â†â€”â€” æ‹‰å–è¯ä¹¦ + éªŒè¯å®¢æˆ·ç«¯/æœåŠ¡ç«¯è¯ä¹¦
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SPIRE Agent â”‚  â†â€”â€” æœ¬èŠ‚ç‚¹ Agentï¼Œæä¾› SDS gRPC + è½®æ¢è¯ä¹¦
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SPIRE Server â”‚  â†â€”â€” ç­¾å‘è¯ä¹¦ï¼Œç»´æŠ¤æ³¨å†Œè¡¨
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## 3.2Istio

```powershell
æœåŠ¡ç½‘æ ¼
	æœåŠ¡ç½‘æ ¼åº”ç”¨ç¨‹åºä¸­ç®¡ç†å®ä¾‹ä¹‹é—´çš„ç½‘ç»œæµé‡çš„éƒ¨åˆ†ç§°ä¸ºæ•°æ®å¹³é¢
	æ§åˆ¶å¹³é¢è´Ÿè´£ç”Ÿæˆå’Œéƒ¨ç½²æ§åˆ¶æ•°æ®å¹³é¢è¡Œä¸ºçš„ç›¸å…³é…ç½®
		æ§åˆ¶å¹³é¢é€šå¸¸åŒ…æ‹¬APIæ¥å£ã€å‘½ä»¤è¡Œç•Œé¢å’Œç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçš„å›¾å½¢ç”¨æˆ·ç•Œé¢ç­‰
Istiod
	Istiodå……å½“æ§åˆ¶å¹³é¢ï¼Œå°†é…ç½®åˆ†å‘åˆ°æ‰€æœ‰Sidecarä»£ç†å’Œç½‘å…³
	å®ƒèƒ½å¤Ÿä¸ºæ”¯æŒç½‘æ ¼çš„åº”ç”¨å®ç°æ™ºèƒ½åŒ–çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä¸”ç›¸å…³æµé‡ç»•è¿‡äº†kube-proxyï¼›

ä¸ºä»€ä¹ˆç»•è¿‡kubeproxyï¼š
	kube-proxyï¼šç›‘å¬ Service/Endpoints å¯¹è±¡ â†’ åœ¨èŠ‚ç‚¹ä¸Šå†™ iptables/ipvs è§„åˆ™ â†’ æŠŠè®¿é—® ClusterIP çš„æµé‡åˆ†å‘åˆ° Podã€‚
		Client â†’ NodePort/ClusterIP â†’ kube-proxy â†’ Pod
		Service è‡ªå·±ä¸å¤„ç†æµé‡ï¼ŒçœŸæ­£åšæµé‡è½¬å‘çš„æ˜¯ kube-proxyï¼ˆiptables/ipvsï¼‰æˆ–è€…å¤–éƒ¨ LB
		kube-proxy = Service çš„å†…éƒ¨ä»£ç†ï¼ŒLoadBalancer = Service çš„å¤–éƒ¨ä»£ç†
		
	Ingress Controllerï¼šç›´æ¥é€šè¿‡ Kubernetes API è·å– Endpoints â†’ ä½œä¸ºåº”ç”¨å±‚ä»£ç†ï¼ˆNginx/Envoy/Traefikï¼‰è‡ªå·±åšè´Ÿè½½å‡è¡¡ â†’ ç›´æ¥è½¬å‘åˆ° Pod IPã€‚
		
	Istioï¼šåœ¨ Pod å†…ç”¨ iptables åŠ«æŒæµé‡ â†’ Sidecar Envoy é€šè¿‡ xDS è·å– Endpoints â†’ è‡ªå·±åšæµé‡æ²»ç† & è´Ÿè½½å‡è¡¡ â†’ ç›´æ¥å‘ç»™ Pod IPã€‚
	æ‰€ä»¥æœ¬è´¨ä¸Šï¼škube-proxy æ˜¯å†…æ ¸å±‚ä»£ç†ï¼ŒIngress Controller / Istio æ˜¯ç”¨æˆ·æ€ä»£ç†ï¼ˆEnvoy/Nginxï¼‰ï¼Œè€Œä¸”å®ƒä»¬ç›´æ¥æ‹¿åˆ° Endpointsï¼Œä¸éœ€è¦ kube-proxy å…œä¸€åœˆã€‚
	
LB â†’ Istio Ingress Gateway Pod (Envoy) â†’ Pod å†…éƒ¨ Sidecar Envoy â†’ ä¸šåŠ¡å®¹å™¨
```

WASM

```powershell
WASMï¼šä¸€ç§å¯ç§»æ¤çš„äºŒè¿›åˆ¶æ’ä»¶æœºåˆ¶ã€‚
Istio ä¸­çš„ä½œç”¨ï¼šæ‰©å±• Envoy Proxyï¼Œå…è®¸ä½ åœ¨ä¸æ”¹ Envoy æºç çš„æƒ…å†µä¸‹åŠ è½½è‡ªå®šä¹‰åŠŸèƒ½ã€‚
åº”ç”¨åœºæ™¯ï¼šè®¤è¯æˆæƒã€æµé‡æ²»ç†ã€å¯è§‚æµ‹æ€§ã€ç­–ç•¥æ§åˆ¶ç­‰ã€‚
æ ¸å¿ƒä»·å€¼ï¼šè®©æœåŠ¡ç½‘æ ¼å˜å¾—çµæ´»å¯æ‰©å±•ï¼Œé¿å…â€œä¸€ä¸ª Istio æ‰“å¤©ä¸‹ä½†ä¸èƒ½æ‰©å±•â€çš„é—®é¢˜ã€‚
```

### 3.2.1éƒ¨ç½²

```powershell
https://istio.io/latest/docs/setup/getting-started/

1.istioctl:é€‚åˆå¿«é€Ÿéƒ¨ç½²ã€å®éªŒå’Œæµ‹è¯•ï¼Œæ“ä½œç®€å•ç›´è§‚ï¼Œé€‚åˆå°è§„æ¨¡é›†ç¾¤
	istioå®‰è£…ç›®å½•ç»“æ„ä»‹ç»
		bin/ # äºŒè¿›åˆ¶ç¨‹åºæ–‡ä»¶
		manifests/
			manifests/profiles/ # å†…ç½®çš„é…ç½®æ¡£æ¡ˆ
		samples/ #ç›®å½•ä¸‹çš„ç¤ºä¾‹åº”ç”¨ç¨‹åº
        	samples/addons/ # éƒ¨ç½²å„æ‰©å±•ç»„ä»¶çš„ç¤ºä¾‹æ¸…å•
			samples/bookinfo/ # ç¤ºä¾‹å¾®æœåŠ¡é¡¹ç›®bookinfo
		tools/
2.Istio Operator:é€‚åˆç”Ÿäº§ç¯å¢ƒå’Œå¤§è§„æ¨¡é›†ç¾¤çš„ç®¡ç†ï¼Œæä¾›äº†æ›´é«˜çš„è‡ªåŠ¨åŒ–å’Œç®¡ç†èƒ½åŠ›ï¼Œé€šè¿‡ CRD è¿›è¡Œå£°æ˜å¼é…ç½®ï¼Œæ”¯æŒç‰ˆæœ¬æ§åˆ¶å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
3.helm
```

```powershell
éƒ¨ç½²æ¡£æ¡ˆï¼šprofile
å®é™…ä¸Šå°±æ˜¯æ ¹æ®profileç”Ÿæˆkubernetesèµ„æºæ¸…å•ï¼Œinstallä¼šç›´æ¥applyåˆ°é›†ç¾¤ä¸­
    istioctl apply/install --set profile=<PROFILE> --set ...

    istioctl profile dump <NAME>  > /path/to/profile.yaml

    istioctl apply/install -f /path/to/profile.yaml

    éƒ¨ç½²åœ¨istio-systemåç§°ç©ºé—´ä¸‹
        æ§åˆ¶å¹³é¢çš„åç§°ç©ºé—´ï¼ŒæœåŠ¡ç½‘æ ¼çš„root namespace

    istioctl x uninstall --purgeï¼šå¸è½½æ§åˆ¶å¹³é¢ç»„ä»¶

    è°ƒæ•´ç½‘æ ¼çº§åˆ«æ§åˆ¶å¹³é¢çš„é…ç½®ï¼šæ”¯æŒåŸºäºå·²ç»éƒ¨ç½²è°ƒæ•´é…ç½®
        istioctl apply/install

    éƒ¨ç½²æ¡£æ¡ˆå¯¹åº”å­˜åœ¨KubernetesåŸç”Ÿæ ¼å¼çš„èµ„æºé…ç½®ï¼š
        istioctl manifest generate --set profile=demo | kubectl apply -f -
```

| ç‰¹æ€§         | `istioctl`                   | Istio Operator                          |
| ------------ | ---------------------------- | --------------------------------------- |
| **ç®¡ç†æ–¹å¼** | å‘½ä»¤å¼ï¼ˆimperativeï¼‰         | å£°æ˜å¼ï¼ˆdeclarativeï¼‰                   |
| **ä½¿ç”¨åœºæ™¯** | å¼€å‘æµ‹è¯•ã€å¿«é€Ÿéƒ¨ç½²ã€ä¸´æ—¶è°ƒæ•´ | ç”Ÿäº§ç¯å¢ƒã€å¤§è§„æ¨¡é›†ç¾¤ã€è‡ªåŠ¨åŒ–ç®¡ç†        |
| **çµæ´»æ€§**   | å‘½ä»¤è¡Œå‚æ•°çµæ´»ï¼Œé€‚åˆå¿«é€Ÿå®éªŒ | é€šè¿‡ CR é…ç½®ç»Ÿä¸€ç®¡ç†ï¼Œé€‚åˆç‰ˆæœ¬æ§åˆ¶      |
| **å‡çº§ç»´æŠ¤** | éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤       | Operator è‡ªåŠ¨ä¿è¯ CR ä¸é›†ç¾¤çŠ¶æ€ä¸€è‡´     |
| **å¤æ‚åº¦**   | ç›¸å¯¹ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½         | éœ€è¦ç†è§£ CRD/Operatorï¼Œä½†è‡ªåŠ¨åŒ–ç¨‹åº¦æ›´é«˜ |

### 3.2.2 kialiã€grafana

```powershell
Kiali å°±æ˜¯ Istio çš„ å¯è§†åŒ–æ§åˆ¶å°
grafanaçš„éƒ¨ç½²åŒç†

Gatewayè´Ÿè´£æ¥å…¥è¿™éƒ¨åˆ†æµé‡ï¼ŒVirtualServiceè´Ÿè´£å°†è¿™éƒ¨åˆ†æµé‡å®Œæˆåœ¨ç½‘æ ¼å†…çš„è·¯ç”±
```

```powershell
---gatewayå®é™…å°±æ˜¯å«å¼€æ”¾ä¸€ä¸ªç«¯å£
# Gatewayï¼šç›¸å½“äº Envoy Listenerï¼Œç”¨æ¥æ¥æ”¶å¤–éƒ¨æµé‡,service LB->istio-system
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: kiali-gateway
  namespace: istio-system
spec:
  selector:
    app: istio-ingressgateway      # é€‰æ‹©å“ªä¸ªç½‘å…³ Pod æ¥ç›‘å¬ï¼ˆé»˜è®¤ istio-ingressgatewayï¼‰
  servers:
  - port:
      number: 20001                # æš´éœ²çš„ç«¯å£ï¼Œäº‘å‚å•†LBå¯ä»¥ç›‘å¬30000ä»¥ä¸‹ï¼Œæµ‹è¯•ç”¨K8Sæ¢ç«¯å£
      name: http-kiali
      protocol: HTTP
    hosts:
    - "kiali.test.com"               # åŒ¹é…çš„åŸŸåï¼ˆHost headerï¼‰

---
# VirtualServiceï¼šç›¸å½“äº Envoy Routeï¼Œå®šä¹‰è¯·æ±‚è½¬å‘è§„åˆ™
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: kiali-virtualservice
  namespace: istio-system
spec:
  hosts:
  - "kiali.test.com"                 # åŒ¹é…çš„åŸŸå
  gateways:
  - kiali-gateway                    # ç»‘å®šåˆ°ä¸Šé¢å®šä¹‰çš„ Gateway
  http:
  - match:
    - uri:
        prefix: /                    # åŒ¹é…æ‰€æœ‰è·¯å¾„
    route:
    - destination:
        host: kiali                  # åç«¯æœåŠ¡çš„ Kubernetes Service åç§°
        port:
          number: 20001              # Kiali Service æš´éœ²çš„ç«¯å£

---
# DestinationRuleï¼šç›¸å½“äº Envoy Clusterï¼Œå®šä¹‰è¿æ¥ç­–ç•¥
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: kiali
  namespace: istio-system
spec:
  host: kiali                        # å¯¹åº” VirtualService é‡Œçš„ destination.host
  trafficPolicy:
    tls:
      mode: DISABLE                  # å…³é—­ TLSï¼ˆKiali é»˜è®¤æ˜¯æ˜æ–‡ 20001ï¼‰
```



### 3.2.3æµé‡æ²»ç†

```powershell
Istioä¼šå°†ç½‘æ ¼ä¸­çš„æ¯ä¸ªServiceçš„ç«¯å£åˆ›å»ºä¸ºListenerï¼Œè€Œå…¶åŒ¹é…åˆ°çš„endpointå°†ç»„åˆæˆä¸ºä¸€ä¸ªCluster

Virtual Serviceså’ŒDestination Rulesæ˜¯Istioæµé‡è·¯ç”±åŠŸèƒ½çš„æ ¸å¿ƒç»„ä»¶
	Virtual Servicesç”¨äºåˆ†ç±»æµé‡å¹¶å°†å…¶è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°ï¼ˆDestinationï¼‰
		ä½œç”¨ï¼šæµé‡è·¯ç”±/æµé‡åˆ†é…/æ•…éšœæ³¨å…¥/æµé‡é•œåƒ
	Destination Rulesåˆ™ç”¨äºé…ç½®é‚£ä¸ªæŒ‡å®šDestinationå¦‚ä½•å¤„ç†æµé‡
		1.å®šä¹‰æœåŠ¡ç‰ˆæœ¬ï¼šä¸ºåŒä¸€æœåŠ¡çš„ä¸åŒç‰ˆæœ¬ï¼ˆæˆ–å­é›†ï¼‰è®¾ç½®æµé‡æ§åˆ¶ç­–ç•¥ã€‚
		2.è´Ÿè½½å‡è¡¡ï¼šä¸ºæ¯ä¸ªå­é›†å®šä¹‰ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚
		3.è¿æ¥æ± å’Œè¶…æ—¶ï¼šä¸ºæœåŠ¡é—´çš„è¿æ¥è®¾ç½®æœ€å¤§è¿æ¥æ•°ã€è¶…æ—¶ç­‰ã€‚
    	4.TLS é…ç½®ï¼šä¸ºæœåŠ¡é—´çš„é€šä¿¡è®¾ç½® TLS åŠ å¯†ä¸è®¤è¯æ–¹å¼ã€‚

VirtualService å†³å®šï¼šè¯·æ±‚æ€ä¹ˆåˆ†æµ
DestinationRule å†³å®šï¼šæµé‡åˆ°è¾¾å­é›†åï¼Œæ€ä¹ˆè´Ÿè½½å‡è¡¡ã€æ˜¯å¦å¯ç”¨ mTLSã€è¿æ¥æ± å¤§å°ç­‰

VirtualServiceä¸ºSidecar Envoyå®šä¹‰Listenerï¼ˆä¸»è¦å®šä¹‰æµé‡è·¯ç”±æœºåˆ¶ç­‰ï¼‰
	ä»…åº”ç”¨äºç½‘æ ¼å†…çš„ä¸œè¥¿æµé‡æ—¶ï¼Œåº”çœç•¥gatewayså­—æ®µ,è¡¨ç¤ºä¸œè¥¿å‘æµé‡æ—¶æ¯ä¸ªæœåŠ¡éƒ½æœ‰å…¥å£å’Œå‡ºå£éœ€è¦é…ç½®
DestinationRuleä¸ºSidecar Envoyå®šä¹‰Clusterï¼ˆåŒ…æ‹¬å‘ç°ç«¯ç‚¹ç­‰ï¼‰

æ³¨æ„ï¼šæ²¡æœ‰åŒ¹é…åˆ°vsçš„æµé‡é»˜è®¤èµ°serviceè½®è¯¢ï¼ˆéšå¼é»˜è®¤è·¯ç”±ï¼‰ï¼ŒVirtualService æ˜¯ä¸€ä¸ªâ€œå¢å¼ºâ€å’Œâ€œè¦†ç›–â€å·¥å…·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªâ€œé™åˆ¶â€å·¥å…·

#è·å–é»˜è®¤è·¯ç”±
FRONTEND=$(kubectl get pods -l app=proxy -o jsonpath={.items[0].metadata.name})
istioctl proxy-config routes $FRONTEND --name 8080 -o yaml

Client --> Envoy Sidecar (outboundï¼šegress listener --> route --> cluster --> endpoint ï¼ˆç”±ç›®æ ‡ç”Ÿç”Ÿæˆï¼‰) --> Server Pod Envoy Sidecar (inbound: ingress listener --> route --> local cluster --> localhost(ä¸šåŠ¡å®¹å™¨)ï¼ˆè‡ªç”±æ‰€å±çš„æœåŠ¡ç”Ÿæˆï¼‰)
```

```powershell
Envoy sidecar ä¸ç›´æ¥ä¾èµ– ClusterIP æ¥æŸ¥æ‰¾ Podï¼Œå®ƒæœ‰ä¸¤ç§ä¿¡æ¯æ¥æºï¼š
	Service å’Œ Endpointsï¼š
		Istio ä¼šç›‘å¬ Kubernetes çš„ Service/Endpoint å¯¹è±¡ã€‚
		Pilot æŠŠ Service åç§°ã€ç«¯å£ã€Pod IPã€æ ‡ç­¾ç­‰ä¿¡æ¯æ¨é€ç»™ Envoy sidecarã€‚
		Envoy æ„å»ºè‡ªå·±çš„é›†ç¾¤ï¼ˆClusterï¼‰ï¼Œç”¨äºè·¯ç”±ã€‚
	è™šæ‹ŸæœåŠ¡è·¯ç”±è§„åˆ™ï¼ˆVirtualService/DestinationRuleï¼‰ï¼š
		å®šä¹‰æµé‡è·¯ç”±ç­–ç•¥ï¼Œæ¯”å¦‚ç‰ˆæœ¬ç°åº¦ã€æµé‡æ‹†åˆ†ã€ç†”æ–­ã€é‡è¯•ç­‰ã€‚
		Envoy æ ¹æ®è§„åˆ™å†³å®šæµé‡èµ°å‘å“ªäº› Pod IPã€‚

å› æ­¤ï¼ŒEnvoy ä½¿ç”¨ Kubernetes çš„ Service/Endpoints ä¿¡æ¯åšæœåŠ¡å‘ç°ï¼Œä½†å®é™…é€šä¿¡æ˜¯ Pod IP çº§åˆ«çš„ï¼Œä¸ç»è¿‡ ClusterIP è´Ÿè½½å‡è¡¡ã€‚
```

![img](format,webp.webp)

DestinationRule (å®šä¹‰æœåŠ¡å­é›†å’Œç­–ç•¥)

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
  namespace: default
spec:
  host: reviews  # ç›®æ ‡æœåŠ¡åç§°ï¼ŒK8s Service
  subsets:
  - name: v1      # å®šä¹‰å­é›† v1
    labels:
      version: v1 # åŒ¹é…å¸¦æœ‰ label version=v1 çš„ Pod
    trafficPolicy:   # å¯é€‰ï¼Œå®šä¹‰è¯¥å­é›†çš„æµé‡ç­–ç•¥
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```

VirtualService (å®šä¹‰æµé‡è·¯ç”±è§„åˆ™)

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-virtualservice
  namespace: default
spec:
  hosts:
  - reviews  # åŒ¹é…è®¿é—® reviews æœåŠ¡çš„è¯·æ±‚
  http:
  - route:
    - destination:
        host: reviews   # æŒ‡å‘ DestinationRule çš„ host
        subset: v1      # æµé‡è·¯ç”±åˆ°å­é›† v1
      weight: 80        # 80% æµé‡
    - destination:
        host: reviews
        subset: v2
      weight: 20        # 20% æµé‡

```

### 3.2.4æµé‡æ²»ç†è¿›é˜¶

```powershell
Pilotè´Ÿè´£ç½‘æ ¼ä¸­æ•°æ®å¹³é¢ç›¸å…³çš„é…ç½®ä¿¡æ¯çš„è·å–ã€ç”ŸæˆåŠåˆ†å‘ï¼Œå®ƒé€šè¿‡ç”¨æˆ·é…ç½®åŠæœåŠ¡æ³¨å†Œè¡¨è·å–ç½‘æ ¼é…ç½®ä¿¡æ¯å¹¶å°†å…¶è½¬æ¢ä¸ºxDSæ¥å£çš„æ ‡å‡†æ•°æ®æ ¼å¼ï¼Œè€Œåç»gPRCåˆ†å‘è‡³ç›¸å…³çš„Envoyï¼›
	Service Registryï¼šæœåŠ¡æ³¨å†Œè¡¨ä¸­å­˜å‚¨æœ‰ç›¸å…³å¹³å°ä¸Šæ³¨å†Œçš„å„Serviceçš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚kubernetesçš„
servicesç­‰ï¼›
	Config Storageï¼šé…ç½®å­˜å‚¨ï¼Œä¾‹å¦‚Kubernetesçš„API Serverï¼Œé…ç½®ä¿¡æ¯é€šå¸¸æ˜¯ç”±ç”¨æˆ·æä¾›ï¼Œå¯¹äº
Kubernetesæ¥è¯´ï¼Œå®ƒä»¬ä»¥kubernetes CRDæ ¼å¼æä¾›å¹¶å­˜å‚¨äºAPI Serverä¸­ï¼›
```

![image-20250901131155064](image-20250901131155064.png)

```powershell
pilot-discoveryï¼šå³å›¾ä¸­çš„Discovery Servicesï¼š
	ä»API Serverä¸­è·å–é…ç½®ä¿¡æ¯->å°†æœåŠ¡ä¿¡æ¯å’Œé…ç½®ä¿¡æ¯è½¬åŒ–ä¸ºEnvoyçš„é…ç½®æ ¼å¼ï¼Œå¹¶é€šè¿‡xDS APIå®Œæˆåˆ†å‘

Kubernetes API Serverï¼š
	é…ç½®å­˜å‚¨ç³»ç»Ÿï¼Œè´Ÿè´£å­˜å‚¨ç”¨æˆ·ä»¥kubernetes crdæ ¼å¼ï¼ˆä¾‹å¦‚Gateway,VirtualServiceå’ŒDestinationRuleç­‰ï¼‰æä¾›çš„é…ç½®ä¿¡æ¯
	
pilot-agent
	åŸºäºk8s api serverä¸ºenvoyåˆå§‹åŒ–å‡ºå¯ç”¨çš„boostrapé…ç½®æ–‡ä»¶å¹¶å¯åŠ¨envoyï¼›
	ç›‘æ§å¹¶ç®¡ç†envoyçš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬envoyå‡ºé”™æ—¶é‡å¯envoyï¼Œä»¥åŠenvoyé…ç½®å˜æ›´åå°†å…¶é‡è½½ç­‰
```

#### virtual service

![Istio VirtualService_å­—æ®µ_03](format,webp-1756710904421-13.webp)

```powershell
apiVersion: networking.istio.io/v1alpha3  # Istioèµ„æºç±»å‹APIç‰ˆæœ¬
kind: VirtualService                      # èµ„æºç±»å‹ï¼šè™šæ‹ŸæœåŠ¡ï¼ˆè·¯ç”±è§„åˆ™æ ¸å¿ƒï¼‰
metadata:
  name: demo-virtual-service              # è™šæ‹ŸæœåŠ¡åç§°
spec:
  hosts:
    - "example.com"                       # ç”Ÿæ•ˆçš„åŸŸåï¼ˆå¯åŒ¹é…å¤šä¸ªï¼‰
  gateways:
    - "mesh"                              # ç»‘å®šçš„ç½‘å…³ï¼ˆmeshè¡¨ç¤ºæœåŠ¡ç½‘æ ¼å†…éƒ¨æµé‡ï¼‰
  
  # HTTPè·¯ç”±è§„åˆ™ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
  http:
    - match:                              # åŒ¹é…æ¡ä»¶ï¼ˆå¯å¤šç»„ï¼‰
        - uri:                            # URIåŒ¹é…è§„åˆ™
            prefix: "/api/v1"             # å‰ç¼€åŒ¹é…ï¼ˆå¦‚/api/v1å¼€å¤´çš„è·¯å¾„ï¼‰
        - headers:                        # è¯·æ±‚å¤´åŒ¹é…
            user-agent:
              exact: "Mozilla/5.0"        # ç²¾ç¡®åŒ¹é…User-Agent
      route:                              # è·¯ç”±ç›®æ ‡ï¼ˆå¯æƒé‡åˆ†æµï¼‰
        - destination:                    # ç›®æ ‡æœåŠ¡1ï¼ˆæƒé‡80%ï¼‰
            host: "service-a"             # æœåŠ¡åï¼ˆK8s Serviceæˆ–Istio ServiceEntryï¼‰
            subset: "v1"                  # å­é›†ï¼ˆå¸¸ç”¨äºA/Bæµ‹è¯•æˆ–é‡‘ä¸é›€å‘å¸ƒï¼‰
            port:
              number: 8080                # ç›®æ ‡ç«¯å£
          weight: 80                      # æµé‡æƒé‡
        - destination:                    # ç›®æ ‡æœåŠ¡2ï¼ˆæƒé‡20%ï¼‰
            host: "service-b"
            subset: "v2"
            port:
              number: 9090
          weight: 20
      redirect:                           # é‡å®šå‘é…ç½®
        authority: "redirect.example.com" # ç›®æ ‡host
        uri: "/redirected-path"           # é‡å®šå‘è·¯å¾„
        redirectCode: 301                 # HTTPçŠ¶æ€ç ï¼ˆ301æ°¸ä¹…é‡å®šå‘ï¼‰
      rewrite:                            # è¯·æ±‚æ”¹å†™
        authority: "rewrite.example.com"  # ä¿®æ”¹è¯·æ±‚host
        uri: "/rewritten-path"            # ä¿®æ”¹è¯·æ±‚è·¯å¾„
      timeout: "10s"                      # è¯·æ±‚è¶…æ—¶æ—¶é—´
      retries:                            # é‡è¯•ç­–ç•¥
        attempts: 3                       # æœ€å¤§é‡è¯•æ¬¡æ•°
        perTryTimeout: "2s"               # å•æ¬¡é‡è¯•è¶…æ—¶
        retryOn: "connect-failure"        # è§¦å‘é‡è¯•çš„æ¡ä»¶ï¼ˆå¦‚è¿æ¥å¤±è´¥ï¼‰
      fault:                              # æ•…éšœæ³¨å…¥ï¼ˆæµ‹è¯•ç”¨ï¼‰
        delay:                            # å»¶è¿Ÿæ³¨å…¥
          fixedDelay: "2s"                # å›ºå®šå»¶è¿Ÿæ—¶é—´
          percentage: 50                  # æ³¨å…¥æ¯”ä¾‹ï¼ˆ50%è¯·æ±‚å—å½±å“ï¼‰
        abort:                            # ä¸­æ–­è¯·æ±‚
          httpStatus: 500                 # è¿”å›çš„HTTPçŠ¶æ€ç 
          percentage: 10                  # ä¸­æ–­æ¯”ä¾‹ï¼ˆ10%è¯·æ±‚è¿”å›500é”™è¯¯ï¼‰
      mirror:                             # æµé‡é•œåƒï¼ˆå½±å­æµé‡ï¼‰
        host: "mirror-service"            # é•œåƒç›®æ ‡æœåŠ¡
        mirrorPercent: 100                # é•œåƒæµé‡æ¯”ä¾‹ï¼ˆ100%å…¨é‡é•œåƒï¼‰
      corsPolicy:                         # è·¨åŸŸé…ç½®
        allowOrigin: "*"                  # å…è®¸çš„æºï¼ˆ*è¡¨ç¤ºå…¨éƒ¨ï¼‰
        allowMethods: ["GET", "POST"]     # å…è®¸çš„HTTPæ–¹æ³•
        allowHeaders: ["Content-Type"]    # å…è®¸çš„è¯·æ±‚å¤´
        maxAge: "1h"                      # é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´
      headers:                            # è¯·æ±‚/å“åº”å¤´æ“ä½œ
        request:                          # è¯·æ±‚å¤´ä¿®æ”¹
          set:                            # è®¾ç½®å¤´ï¼ˆè¦†ç›–åŸæœ‰å€¼ï¼‰
            - name: "X-Request-Header"
              value: "request-value"
          add:                            # æ·»åŠ å¤´ï¼ˆä¸è¦†ç›–ï¼‰
            - name: "X-Request-Header-Add"
              value: "add-value"
          remove:                         # åˆ é™¤å¤´
            - "X-Request-Header-Remove"
        response:                         # å“åº”å¤´ä¿®æ”¹ï¼ˆåŒä¸Šï¼‰
          set:
            - name: "X-Response-Header"
              value: "response-value"
          add:
            - name: "X-Response-Header-Add"
              value: "add-value"
          remove:
            - "X-Response-Header-Remove"

  # TLSè·¯ç”±è§„åˆ™ï¼ˆåŠ å¯†æµé‡ï¼‰
  tls:
    - match:                              # åŒ¹é…æ¡ä»¶
        - sourceLabels:                   # æ¥æºæ ‡ç­¾ï¼ˆå¦‚K8s Podæ ‡ç­¾ï¼‰
            env: "prod"                   # åŒ¹é…env=prodçš„å®¢æˆ·ç«¯
        - destination:                    # ç›®æ ‡æœåŠ¡åŒ¹é…
            host: "tls-service"           # æœåŠ¡å
            port: 443                     # ç«¯å£ï¼ˆHTTPSé»˜è®¤ç«¯å£ï¼‰
      route:                              # è·¯ç”±ç›®æ ‡
        - destination:
            host: "tls-destination"       # å®é™…è½¬å‘ç›®æ ‡
            port:
              number: 443

  # TCPè·¯ç”±è§„åˆ™ï¼ˆéHTTPåè®®ï¼‰
  tcp:
    - match:                              # åŒ¹é…æ¡ä»¶
        - sourceLabels:
            env: "prod"
        - destination:
            host: "tcp-service"
            port: 8080                    # TCPç«¯å£
      route:
        - destination:
            host: "tcp-destination"
            port:
              number: 8080

  exportTo:                              # è§„åˆ™å¯è§æ€§ï¼ˆ"."è¡¨ç¤ºä»…å½“å‰å‘½åç©ºé—´ï¼‰
    - "."
```

#### destination rule

![img](format,webp-1756717873474-16.webp)

```powershell
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: example-destinationrule
spec:
  host: example.com # ç›®æ ‡æœåŠ¡ä¸»æœºå
  trafficPolicy: # å…¨å±€æµé‡ç­–ç•¥
    loadBalancer: # è´Ÿè½½å‡è¡¡ç­–ç•¥
      simple: ROUND_ROBIN # ç®€å•è´Ÿè½½å‡è¡¡ï¼ˆROUND_ROBIN/LEAST_CONN/RANDOM/PASSTHROUGHï¼‰
    connectionPool: # è¿æ¥æ± é…ç½®
      tcp: # TCP è¿æ¥æ± 
        maxConnections: 100 # æœ€å¤§è¿æ¥æ•°
        connectTimeout: 30s # è¿æ¥è¶…æ—¶æ—¶é—´
        tcpKeepalive: # TCP ä¿æ´»é…ç½®
          probes: 3 # ä¿æ´»æ¢æµ‹æ¬¡æ•°
          time: 10s # ä¿æ´»æ¢æµ‹é—´éš”
          interval: 5s # ä¿æ´»æ¢æµ‹é—´éš”
      http: # HTTP è¿æ¥æ± 
        http1MaxPendingRequests: 100 # HTTP/1.1 æœ€å¤§å¾…å¤„ç†è¯·æ±‚
        http2MaxRequests: 100 # HTTP/2 æœ€å¤§è¯·æ±‚æ•°
        maxRequestsPerConnection: 100 # æ¯è¿æ¥æœ€å¤§è¯·æ±‚æ•°
        maxRetries: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
        idleTimeout: 30s # ç©ºé—²è¶…æ—¶æ—¶é—´
        h2UpgradePolicy: UPGRADE # HTTP/2 å‡çº§ç­–ç•¥ï¼ˆUPGRADE/DO_NOT_UPGRADE/DEFAULTï¼‰
    outlierDetection: # å¼‚å¸¸æ£€æµ‹ç­–ç•¥
      splitExternalLocalOriginErrors: true # åˆ†ç¦»å¤–éƒ¨/æœ¬åœ°é”™è¯¯
      consecutiveLocalOriginFailures: 3 # è¿ç»­æœ¬åœ°é”™è¯¯æ¬¡æ•°
      consecutiveGatewayErrors: 3 # è¿ç»­ç½‘å…³é”™è¯¯æ¬¡æ•°
      consecutive5xxErrors: 3 # è¿ç»­ 5xx é”™è¯¯æ¬¡æ•°
      interval: 30s # æ£€æµ‹é—´éš”
      baseEjectionTime: 30s # åŸºç¡€é©±é€æ—¶é—´
      maxEjectionPercent: 50 # æœ€å¤§é©±é€ç™¾åˆ†æ¯”
      minHealthPercent: 50 # æœ€å°å¥åº·ç™¾åˆ†æ¯”
    tls: # TLS å®‰å…¨ç­–ç•¥
      mode: SIMPLE # TLS æ¨¡å¼ï¼ˆDISABLE/SIMPLE/MUTUAL/ISTIO_MUTUALï¼‰
      clientCertificate: /path/to/client.crt # å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„
      privateKey: /path/to/client.key # ç§é’¥è·¯å¾„
      caCertificate: /path/to/ca.crt # CA è¯ä¹¦è·¯å¾„
      subjectAltNames: # ä¸»æœºååˆ«å
      - example.com
      sni: example.com # SNIï¼ˆæœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼‰
  subsets: # æœåŠ¡å­é›†ï¼ˆSubsetï¼‰
  - name: v1 # å­é›†åç§°
    labels: # å­é›†æ ‡ç­¾
      version: v1
    trafficPolicy: # å­é›†æµé‡ç­–ç•¥
      loadBalancer: # å­é›†è´Ÿè½½å‡è¡¡ç­–ç•¥
        consistentHash: # ä¸€è‡´æ€§å“ˆå¸Œï¼ˆéœ€æŒ‡å®šå“ˆå¸Œå­—æ®µï¼‰
          httpCookie: # åŸºäº HTTP Cookie çš„å“ˆå¸Œ
            name: session # Cookie åç§°
            path: / # Cookie è·¯å¾„
            ttl: 300s # Cookie æœ‰æ•ˆæ—¶é•¿
      connectionPool: # å­é›†è¿æ¥æ± é…ç½®ï¼ˆåŒå…¨å±€ï¼Œå¯è¦†ç›–ï¼‰
      outlierDetection: # å­é›†å¼‚å¸¸æ£€æµ‹é…ç½®ï¼ˆåŒå…¨å±€ï¼Œå¯è¦†ç›–ï¼‰
      tls: # å­é›† TLS é…ç½®ï¼ˆåŒå…¨å±€ï¼Œå¯è¦†ç›–ï¼‰
  exportTo: # å¯¼å‡ºç­–ç•¥
  - "." # å½“å‰å‘½åç©ºé—´
```

#### gateway

![image-20231214135959821](202312141359925.png)

```powershell
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: comprehensive-gateway
  namespace: istio-system # Gatewayèµ„æºåº”å®šä¹‰åœ¨ç›®æ ‡ingressgateway Podè¿è¡Œçš„åç§°ç©ºé—´
spec:
  selector:
    istio: ingressgateway # è¿™æ˜¯æœ€å¸¸è§çš„æ ‡ç­¾ï¼Œè¯·æ ¹æ®æ‚¨çš„å®é™…éƒ¨ç½²è¿›è¡Œè°ƒæ•´
  servers:
    - # Server é…ç½®å— 1: å¤„ç† HTTPS æµé‡
      port:
        # Port é…ç½®å—
        number: 443 # ç«¯å£å· (å¿…éœ€)
        protocol: HTTPS # åè®® (å¿…éœ€)ï¼Œå…¶ä»–å¸¸è§å€¼ï¼šHTTP, HTTP2, GRPC, TCP, TLS, MONGO
        name: https-web # ç«¯å£åç§° (å¯é€‰)
      hosts:
        # hosts å­—æ®µï¼šæ­¤æœåŠ¡å™¨æ‰€è´Ÿè´£çš„ä¸»æœºåã€‚
        # åªæ¥å— FQDNï¼ˆå®Œå…¨é™å®šåŸŸåï¼‰æˆ–é€šé…ç¬¦å‰ç¼€æ ¼å¼ã€‚
        - "www.example.com" # å…·ä½“çš„FQDN
        - "*.example.com"   # ä½¿ç”¨é€šé…ç¬¦*åŒ¹é…å­åŸŸ
        # - "example.com"   # å¦ä¸€ä¸ªFQDNç¤ºä¾‹
      tls:
        # TLSOptions é…ç½®å—
        httpsRedirect: true # httpRedirect: æ˜¯å¦å°†HTTPæµé‡é‡å®šå‘åˆ°HTTPSï¼ˆtrue/falseï¼‰
        mode: SIMPLE # TLS æ¨¡å¼ (å¿…éœ€)ã€‚å¯é€‰å€¼ï¼šPASSTHROUGH | SIMPLE | MUTUAL | AUTO_PASSTHROUGH | ISTIO_MUTUAL
        credentialName: example-com-cert # credentialName: æŒ‡å‘ä¸€ä¸ªå·²å­˜åœ¨çš„TLS Secretçš„åç§°ï¼ˆå¸¸ç”¨äºSIMPLE/MUTUALæ¨¡å¼ï¼Œåœ¨K8sä¸­é€šè¿‡Secretå­˜å‚¨è¯ä¹¦ï¼‰
        # ä»¥ä¸‹serverCertificate/privateKey/caCertificatesé€šå¸¸ä¸credentialNameäºŒé€‰ä¸€ï¼Œç”¨äºç›´æ¥å†…è”æˆ–æŒ‡å®šæ–‡ä»¶è·¯å¾„ã€‚
        serverCertificate: /etc/istio/nginx-server-certs/tls.crt # æœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶è·¯å¾„
        privateKey: /etc/istio/nginx-server-certs/tls.key # æœåŠ¡å™¨ç§é’¥æ–‡ä»¶è·¯å¾„
        caCertificates: /etc/istio/nginx-ca-certs/example.com.crt # CAè¯ä¹¦é“¾æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ï¼‰
        subjectAltNames: # subjectAltNames: éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ä¸­çš„SANåˆ—è¡¨
          - "example.com"
          - "*.example.com"
        verifyCertificateSpki: # verifyCertificateSpki: é€šè¿‡SPKIå“ˆå¸ŒéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
          - "SPKI_HASH_1..."
          - "SPKI_HASH_2..."
        verifyCertificateHash: # verifyCertificateHash: é€šè¿‡è¯ä¹¦å“ˆå¸ŒéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
          - "HASH_1..."
          - "HASH_2..."
        minProtocolVersion: TLSV1_2 # minProtocolVersion: æœ€ä½æ”¯æŒçš„TLSåè®®ç‰ˆæœ¬
        maxProtocolVersion: TLSV1_3 # maxProtocolVersion: æœ€é«˜æ”¯æŒçš„TLSåè®®ç‰ˆæœ¬
        cipherSuites: # cipherSuites: æŒ‡å®šæ”¯æŒçš„åŠ å¯†å¥—ä»¶åˆ—è¡¨
          - "ECDHE-ECDSA-AES128-GCM-SHA256"
          - "ECDHE-RSA-AES256-GCM-SHA384"
      # defaultEndpoint: æ­¤æœåŠ¡å™¨çš„é»˜è®¤ç«¯ç‚¹ï¼ˆæ ¼å¼é€šå¸¸ä¸ºIP:Portï¼‰ï¼Œé€šå¸¸ç”±Istioè‡ªåŠ¨ç®¡ç†ï¼Œåœ¨Gateway CRä¸­ä¸å¸¸æ˜¾å¼é…ç½®ã€‚

    - # Server é…ç½®å— 2: å¤„ç† HTTP æµé‡å¹¶é‡å®šå‘
      port:
        number: 80
        protocol: HTTP
        name: http-redirect
      hosts:
        - "*" # ä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰åŸŸå
      tls:
        httpsRedirect: true # å°†æ­¤HTTPç«¯å£çš„æµé‡å…¨éƒ¨é‡å®šå‘åˆ°HTTPS(443ç«¯å£)

    - # Server é…ç½®å— 3: ä½¿ç”¨ Mutual TLS (mTLS)
      port:
        number: 9443
        protocol: HTTPS
        name: https-mtls
      hosts:
        - "secure-api.example.com"
      tls:
        mode: MUTUAL # åŒå‘TLSè®¤è¯
        credentialName: secure-api-mtls-cert # åŒ…å«æœåŠ¡å™¨è¯ä¹¦å’Œç§é’¥çš„Secret
        caCertificates: /etc/istio/secure-api-ca-certs/ca.crt # ç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„CA

    - # Server é…ç½®å— 4: TLS é€ä¼ æ¨¡å¼ç¤ºä¾‹
      port:
        number: 9000
        protocol: TLS # åè®®ä¸ºTLS
        name: tls-passthrough
      hosts:
        - "tls-service.example.com"
      tls:
        mode: PASSTHROUGH # é€ä¼ æ¨¡å¼ï¼ŒGatewayä¸è§£å¯†TLSæµé‡ï¼Œç›´æ¥è½¬å‘ç»™åç«¯æœåŠ¡

```

`credentialName` é€šå¸¸æŒ‡å‘ä¸€ä¸ª Kubernetes Secretï¼ˆç±»å‹ä¸º `kubernetes.io/tls`ï¼‰ï¼Œè¯¥ Secret åŒ…å« `tls.crt` å’Œ `tls.key`ã€‚è¿™æ˜¯ä¸€ç§æ›´å¸¸è§çš„äº‘åŸç”Ÿåšæ³•ã€‚

### 3.2.5æµé‡æ‹¦æˆªæœºåˆ¶

Istio çš„æµé‡æ‹¦æˆªæœºåˆ¶æ ¸å¿ƒæ˜¯ä½¿ç”¨ä¸€ä¸ªç‰¹æƒåˆå§‹åŒ–å®¹å™¨ `istio-init` æ¥é…ç½® `iptables` è§„åˆ™ï¼Œå®ç°æµé‡çš„é€æ˜åŠ«æŒã€‚å®ƒå°†Podå†…å‡ ä¹æ‰€æœ‰TCPæµé‡é‡å®šå‘åˆ°Envoy Sidecarä»£ç†çš„15001ï¼ˆå‡ºç«™ï¼‰å’Œ15006ï¼ˆå…¥ç«™ï¼‰ç«¯å£ã€‚è¿™ç§æ–¹å¼å¯¹åº”ç”¨å®Œå…¨æ— ä¾µå…¥ï¼Œæ˜¯Istioå®ç°é«˜çº§æµé‡æ²»ç†çš„åŸºç¡€ã€‚å½“ç„¶ï¼Œå®ƒä¹Ÿæ”¯æŒåƒeBPFè¿™æ ·çš„æ›´å…ˆè¿›çš„æ‹¦æˆªæ¨¡å¼ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆã€‚

```powershell
IPTABLES æ‹¦æˆªæ¨¡å¼
é‡å®šå‘ï¼ˆREDIRECTï¼‰ï¼šä¼šä¿®æ”¹æ•°æ®åŒ…çš„ç›®æ ‡IPå’Œç«¯å£ã€‚ç®€å•ç²—æš´ï¼Œå…¼å®¹æ€§å¥½ï¼Œæ˜¯é»˜è®¤æ¨¡å¼ã€‚
é€æ˜ä»£ç†ï¼ˆTPROXYï¼‰ï¼šä¼šä¿ç•™æ•°æ®åŒ…çš„åŸå§‹ç›®æ ‡IPå’Œç«¯å£ã€‚æ›´é«˜çº§ï¼Œèƒ½å¤„ç†æ›´å¤æ‚çš„ç½‘ç»œåœºæ™¯ï¼Œä½†éœ€è¦ç‰¹æ®Šæƒé™ã€‚

# æŸ¥çœ‹æŸä¸ªPodçš„Sidecaré…ç½®æ‘˜è¦ï¼ŒåŒ…æ‹¬æ‹¦æˆªä¿¡æ¯
istioctl proxy-config bootstrap <sleep-pod-name> | grep -i "intercept"
# æˆ–è€…æŸ¥çœ‹ç›‘å¬å™¨ï¼Œä½ ä¼šçœ‹åˆ°Envoyåœ¨15001å’Œ15006ç«¯å£çš„ç›‘å¬å™¨
istioctl proxy-config listener <sleep-pod-name>

curl ip:15000/clusters

iptables å°†æµé‡åŠ«æŒåˆ° Envoy->envoyæ ¹æ®istioä¸‹å‘çš„vså’Œdré…ç½®å¤„ç†æµé‡->app->envoy->å¤–éƒ¨
```

```powershell
ç‰¹æ®Šç«¯å£
    15000/tcp       ç®¡ç†ç«¯å£
    15001/tcp       å‡ºç«™ç«¯å£
    15004/http      debugç«¯å£
    15006/tcp       å…¥ç«™ç«¯å£
    15008/h2        hbone mtlséš§é“ç«¯å£
    15009/h2c       hboneå®‰å…¨ç½‘ç»œç«¯å£
    15020/http      å†…ç½®åˆå¹¶æŒ‡æ ‡æ•°æ®çš„ç«¯å£
    15021/http      å¥åº·æ£€æµ‹
    15053/dns       dnsç«¯å£ï¼Œé»˜è®¤æœªå¯ç”¨
    15090/http      å†…ç½®æ™®ç½—ç±³ä¿®æ–¯ç«¯å£
æ§åˆ¶å¹³é¢ç«¯å£
    443/https
    15010/grpc      xdsã€caæœåŠ¡
    15012/grpc      xdsã€ca
    15014/http      æ§åˆ¶å¹³é¢ç›‘æ§
    15017/https     è½¬å‘443
```

captureMode

| ç‰¹æ€§             | **IPTABLES (é»˜è®¤)**                                          | **EBPF**                                                     | **NONE**                                                 |
| :--------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------------------------------- |
| **å·¥ä½œåŸç†**     | ä½¿ç”¨ Linux å†…æ ¸çš„ `iptables` è§„åˆ™**é‡å†™**æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€ã€‚  | ä½¿ç”¨ eBPF ç¨‹åº**åŠ¨æ€è·Ÿè¸ª**å†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œç›´æ¥å¤„ç†ç½‘ç»œæ•°æ®åŒ…ã€‚ | **ä¸è¿›è¡Œä»»ä½•æ•è·**ã€‚æµé‡ç›´æ¥ç»•è¿‡ Sidecarã€‚               |
| **æ€§èƒ½å¼€é”€**     | **è¾ƒé«˜**ã€‚æ¯ä¸ªæ•°æ®åŒ…éƒ½éœ€è¦ç»è¿‡ç”¨æˆ·æ€ï¼ˆEnvoyï¼‰å¤„ç†ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§ã€‚ | **è¾ƒä½**ã€‚eBPF ç¨‹åºåœ¨å†…æ ¸ç©ºé—´ç›´æ¥è¿è¡Œï¼Œå‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®åŒ…å¤åˆ¶ã€‚ | **æ— **ã€‚é›¶é¢å¤–å¼€é”€ã€‚                                     |
| **çµæ´»æ€§/åŠŸèƒ½**  | åŠŸèƒ½å¼ºå¤§ä¸”ç¨³å®šï¼Œæ”¯æŒæ‰€æœ‰ç‰¹æ€§ã€‚                               | **éå¸¸çµæ´»**ã€‚å¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„è¿‡æ»¤å’Œè·¯ç”±ï¼Œè€Œæ— éœ€å°†æµé‡å…¨éƒ¨é‡å®šå‘åˆ°ç”¨æˆ·æ€ã€‚ | **æ— **ã€‚Sidecar ä¸å‚ä¸æµé‡å¤„ç†ã€‚                         |
| **å¤æ‚åº¦**       | ä¸­ç­‰ã€‚æˆç†Ÿç¨³å®šï¼Œæ˜“äºç†è§£ã€‚                                   | **é«˜**ã€‚éœ€è¦è¾ƒæ–°çš„å†…æ ¸ç‰ˆæœ¬ï¼Œä¸”æœ¬èº«æ˜¯ä¸€é¡¹å¤æ‚çš„æŠ€æœ¯ã€‚         | **ä½**ã€‚æœ€ç®€å•ã€‚                                         |
| **å†…æ ¸è¦æ±‚**     | ä½ã€‚ç»å¤§å¤šæ•° Linux å‘è¡Œç‰ˆéƒ½æ”¯æŒã€‚                            | **é«˜**ã€‚éœ€è¦ **Linux 4.18+** åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¹¶å¼€å¯ç›¸å…³ç¼–è¯‘é€‰é¡¹ã€‚ | æ— è¦æ±‚ã€‚                                                 |
| **å…¸å‹åº”ç”¨åœºæ™¯** | **é€šç”¨é»˜è®¤é€‰æ‹©**ï¼Œé€‚ç”¨äºç»å¤§å¤šæ•°ç¯å¢ƒå’Œç”¨ä¾‹ã€‚                 | **é«˜æ€§èƒ½éœ€æ±‚åœºæ™¯**ï¼Œéœ€è¦æè‡´æ€§èƒ½å’Œå¯¹æµé‡æœ‰æ›´åº•å±‚æ§åˆ¶çš„éœ€æ±‚ã€‚ | **ç‰¹å®šç«¯å£æ’é™¤**ï¼Œ**æ€§èƒ½å…³é”®å‹åº”ç”¨**ï¼Œæˆ–ä¸ä¼ ç»ŸæœåŠ¡å…±å­˜ã€‚ |

### 3.2.6sidecar

```powershell
istio é…ç½®åˆ†å‘æœºåˆ¶ï¼šä¸æ˜¯ç®€å•çš„â€œå…¨é‡æ‹·è´â€
	Istiod æ˜¯å¤§è„‘ï¼šIstiod æ˜¯æ§åˆ¶å¹³é¢ï¼Œå®ƒæŒæ¡æ‰€æœ‰é…ç½®ï¼ˆVS, DR, Gateway ç­‰ï¼‰ã€‚
		æŒ‰éœ€è®¡ç®—ä¸èšåˆï¼šIstiod ä¸ä¼šç›´æ¥ä¸‹å‘ YAML æ–‡ä»¶ã€‚å®ƒä¼šæ ¹æ®æ•´ä¸ªç½‘æ ¼çš„çŠ¶æ€ï¼Œè®¡ç®—å¹¶ç”Ÿæˆä¸€ä»½é’ˆå¯¹æ¯ä¸ª Sidecar çš„ã€æœ€ç²¾ç®€çš„ Envoy é…ç½®ï¼ˆé€šå¸¸æ˜¯ xDS åè®®ä¸­çš„ CDS, EDS, RDS, LDS ç­‰ï¼‰ã€‚
		åªä¸‹å‘ç›¸å…³é…ç½®ï¼šè™½ç„¶æ¯ä¸ª Sidecar ä¼šæ”¶åˆ°å¾ˆå¤šé…ç½®ï¼Œä½†å…¶ä¸­å¤§éƒ¨åˆ†æ˜¯æœåŠ¡å‘ç°ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œé›†ç¾¤å†…æ‰€æœ‰æœåŠ¡çš„ç«¯ç‚¹ä¿¡æ¯ï¼‰ã€‚å…·ä½“çš„ VS å’Œ DR è§„åˆ™åªæœ‰åœ¨åŒ¹é…åˆ°è¯¥ Sidecar å¯èƒ½è®¿é—®çš„æœåŠ¡æ—¶æ‰ä¼šè¢«ç”Ÿæ•ˆæˆ–åŒ…å«ã€‚

æ³¨æ„ï¼šéšç€æ—¶é—´çš„æ¨ç§»ï¼ŒæœåŠ¡å¯èƒ½ä¼šè·Ÿå…¶ä»–ä¸ç›¸å…³çš„æœåŠ¡é€šä¿¡ï¼Œå‡ºç°é…ç½®è†¨èƒ€
```

```powershell
ç»å¤§å¤šæ•°æƒ…å†µæ˜¯æ— éœ€é…ç½®sidecarçš„

Sidecar èµ„æºçš„ä½œç”¨ï¼ˆé»˜è®¤è¡Œä¸º vs. é…ç½®åï¼‰
1. é»˜è®¤è¡Œä¸ºï¼ˆæ—  Sidecar é…ç½®ï¼‰ï¼š
	Istio çš„æ§åˆ¶å¹³é¢ï¼ˆIstiodï¼‰ä¼šé»˜è®¤å°†æ•´ä¸ªæœåŠ¡ç½‘æ ¼å†…æ‰€æœ‰æœåŠ¡çš„è·¯ç”±ä¿¡æ¯ä¸‹å‘ç»™æ¯ä¸€ä¸ª Envoy Sidecarã€‚
		ä¼˜ç‚¹ï¼šä»»ä½•æœåŠ¡éƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ä»»ä½•å…¶ä»–æœåŠ¡ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼Œå¼€ç®±å³ç”¨ã€‚
		ç¼ºç‚¹ï¼šéšç€æœåŠ¡æ•°é‡çš„å¢é•¿ï¼Œæ¯ä¸ª Sidecar çš„é…ç½®ä¼šå˜å¾—éå¸¸åºå¤§ï¼ˆå¯èƒ½åŒ…å«æˆåƒä¸Šä¸‡æ¡è·¯ç”±å’Œé›†ç¾¤ä¿¡æ¯ï¼‰ï¼Œå¯¼è‡´ï¼šå†…å­˜å ç”¨é«˜ï¼šæ¯ä¸ª Envoy å®ä¾‹éœ€è¦ç¼“å­˜æ‰€æœ‰æœåŠ¡çš„ä¿¡æ¯ã€‚å¯åŠ¨å’Œé…ç½®æ¨é€å˜æ…¢ï¼šå½±å“æ€§èƒ½ã€‚

ä½•æ—¶éœ€è¦é…ç½® Sidecarï¼Ÿ
	å¤§å‹é›†ç¾¤çš„æ€§èƒ½ä¼˜åŒ–ï¼šå½“é›†ç¾¤æœ‰æ•°ç™¾æˆ–æ•°åƒä¸ªæœåŠ¡æ—¶ï¼Œä¸ºäº†å‡å°‘å•ä¸ªSidecarçš„å†…å­˜å ç”¨å’Œé…ç½®å¤æ‚åº¦ã€‚
	å‘½åç©ºé—´éš”ç¦»ï¼šæ‚¨å¸Œæœ›å°†ä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„æœåŠ¡ä¸ç½‘æ ¼çš„å…¶ä»–éƒ¨åˆ†éš”ç¦»ï¼Œåªå…è®¸å®ƒè®¿é—®ç‰¹å®šçš„å¤–éƒ¨æœåŠ¡æˆ–å°‘æ•°å‡ ä¸ªå†…éƒ¨æœåŠ¡ã€‚
	å®‰å…¨åŠ å›ºï¼šéµå¾ªâ€œæœ€å°æƒé™åŸåˆ™â€ï¼Œæ˜ç¡®æŒ‡å®šä¸€ä¸ª Pod å¯ä»¥è®¿é—®å“ªäº›æœåŠ¡ï¼Œç¦æ­¢è®¿é—®å…¶ä»–æ‰€æœ‰æœåŠ¡ã€‚
```

å£°æ˜å¼å’Œæœ€ç»ˆä¸€è‡´æ€§

```powershell
è¿‡ç¨‹æ˜¯â€œæ›´æ–°â€è€Œéâ€œåˆ é™¤â€     
1.Istiod æ£€æµ‹åˆ°å˜åŒ–ï¼šIstiod ç›‘æ§ç€æ‰€æœ‰ Istio è‡ªå®šä¹‰èµ„æºï¼ˆåŒ…æ‹¬ Sidecarï¼‰çš„å˜åŒ–ã€‚

2.é‡æ–°è®¡ç®—é…ç½®ï¼šIstiod è¯†åˆ«å‡ºè¿™ä¸ª Sidecar èµ„æºå…³è”åˆ°å“ªäº›å·¥ä½œè´Ÿè½½ï¼ˆé€šè¿‡ workloadSelectorï¼‰ï¼Œç„¶åç«‹å³å¼€å§‹ä¸ºè¿™äº›å·¥ä½œè´Ÿè½½é‡æ–°ç”Ÿæˆä¸€ä»½æ–°çš„ã€è£å‰ªè¿‡çš„ XDS é…ç½®ã€‚

3.ä¸»åŠ¨æ¨é€æ›´æ–°ï¼šIstiod é€šè¿‡ gRPC æµè¿æ¥ä¸»åŠ¨å°†æ–°çš„ã€ç²¾ç®€åçš„é…ç½®æ¨é€ç»™ç›®æ ‡ Pod çš„ Sidecar ä»£ç†ã€‚

4.Sidecar çƒ­é‡è½½ï¼šEnvoy Sidecar æ¥æ”¶æ–°é…ç½®ï¼Œå¹¶æ‰§è¡Œçƒ­é‡è½½ï¼ˆHot Restartï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šä¼˜é›…åœ°ä½¿ç”¨æ–°é…ç½®ï¼Œé€æ¸æ›¿æ¢æ‰è€çš„è¿æ¥å’Œç›‘å¬å™¨ï¼Œé€šå¸¸ä¸ä¼šä¸­æ–­ç°æœ‰çš„æ­£åœ¨å¤„ç†çš„è¿æ¥ã€‚

5.å†…å­˜å›æ”¶ï¼šåœ¨æ–°é…ç½®å®Œå…¨ç”Ÿæ•ˆåï¼Œæ—§é…ç½®ä¸­é‚£äº›ä¸å†éœ€è¦çš„éƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œå…¶ä»–æœåŠ¡çš„é›†ç¾¤ä¿¡æ¯ã€è·¯ç”±è§„åˆ™ï¼‰æ‰€å ç”¨çš„å†…å­˜å°±ä¼šè¢« Envoy ä»£ç†åƒåœ¾å›æ”¶ã€‚
```

![image-20230912170704681](202312161335394.png)

å®é™…é…ç½®é€šå¸¸åªéœ€é…ç½® `workloadSelector` å’Œ `egress.hosts`ã€‚

```powershell
# apiVersion: networking.istio.io/v1beta1
# kind: Sidecar
# metadata:
#   name: example-sidecar
#   namespace: my-namespace # Sidecarèµ„æºæœ€å¥½å®šä¹‰åœ¨åº”ç”¨æ‰€åœ¨çš„å‘½åç©ºé—´

apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: example-sidecar
  namespace: my-namespace
spec:
  # workloadSelector å­—æ®µï¼šç”¨äºé€‰æ‹©åº”ç”¨æ­¤é…ç½®çš„ç‰¹å®šå·¥ä½œè´Ÿè½½ï¼ˆPodï¼‰ã€‚
  # å¦‚æœçœç•¥ï¼Œåˆ™é…ç½®å°†åº”ç”¨äºå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚
  workloadSelector:
    labels:
      app: reviews # é€‰æ‹©å…·æœ‰æ ‡ç­¾ app=reviews çš„Pod
      version: v1  # å¯ä»¥æŒ‡å®šå¤šä¸ªæ ‡ç­¾æ¥å®ç°æ›´ç²¾ç»†çš„é€‰æ‹©
  # ingress å­—æ®µï¼šé…ç½®å·¥ä½œè´Ÿè½½çš„å…¥ç«™ï¼ˆInboundï¼‰æµé‡ä¾¦å¬å™¨ã€‚
  # ç”¨äºè‡ªå®šä¹‰Sidecarå¦‚ä½•å¤„ç†è¿›å…¥Podçš„æµé‡ã€‚æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªListenerã€‚
  ingress:
    - # port å­—æ®µï¼šæŒ‡å®š ingress ä¾¦å¬å™¨ç›‘å¬çš„ç«¯å£
      port:
        number: 9080 # ç«¯å£å·
        protocol: HTTP # åè®®ç±»å‹ (HTTP, HTTPS, TCP, TLSç­‰)
        name: http-ingress # ç«¯å£åç§° (å¯é€‰)
      # bind å­—æ®µï¼šæŒ‡å®šä¾¦å¬å™¨ç»‘å®šçš„IPåœ°å€ã€‚é€šå¸¸ä½¿ç”¨æœ¬åœ°å›ç¯åœ°å€ä»¥é™åˆ¶åªæ¥æ”¶æ¥è‡ªPodå†…éƒ¨çš„æµé‡ã€‚
      bind: 127.0.0.1
      # captureMode å­—æ®µï¼šæŒ‡å®šå¦‚ä½•ä¸ºæ­¤ä¾¦å¬å™¨æ•è·æµé‡ã€‚
      # DEFAULT: ä½¿ç”¨é»˜è®¤æ•è·æ¨¡å¼ï¼ˆé€šå¸¸ä¸ºIPTABLESï¼‰
      # IPTABLES: ä½¿ç”¨iptablesé‡å®šå‘æµé‡
      # NONE: ä¸æ•è·æµé‡ï¼ˆé€šå¸¸ä¸æ˜¾å¼ç»‘å®šåœ°å€ä¸€èµ·ä½¿ç”¨ï¼‰
      captureMode: IPTABLES
      # defaultEndpoint å­—æ®µï¼šæŒ‡å®šå…¥ç«™æµé‡çš„é»˜è®¤ç›®æ ‡åœ°å€ã€‚
      # æ ¼å¼ä¸º <IP_address>:<Port>ï¼Œé€šå¸¸æŒ‡å‘æœ¬åœ°åº”ç”¨å®ä¾‹çš„ç›‘å¬åœ°å€ã€‚
      defaultEndpoint: 127.0.0.1:8080

  # egress å­—æ®µï¼šé…ç½®å·¥ä½œè´Ÿè½½çš„å‡ºç«™ï¼ˆOutboundï¼‰æµé‡ä¾¦å¬å™¨ã€‚
  # ç”¨äºé™åˆ¶å’Œè‡ªå®šä¹‰Sidecarå¯ä»¥å‘é€æµé‡åˆ°å“ªäº›ä¸»æœºã€‚æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªListenerã€‚
  egress:
    - # port å­—æ®µï¼šæŒ‡å®š egress ä¾¦å¬å™¨ä½¿ç”¨çš„ç«¯å£
      port:
        number: 80
        protocol: HTTP
        name: http-egress
      # bind å­—æ®µï¼šæŒ‡å®šå‡ºç«™ä¾¦å¬å™¨ç»‘å®šçš„IPåœ°å€ã€‚é€šå¸¸ä¸º 0.0.0.0 ä»¥ç›‘å¬æ‰€æœ‰å‡ºå£ã€‚
      bind: 0.0.0.0
      # captureMode å­—æ®µï¼šæŒ‡å®šå¦‚ä½•ä¸ºæ­¤ä¾¦å¬å™¨æ•è·æµé‡ã€‚
      captureMode: DEFAULT
      # hosts å­—æ®µï¼šè¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼ï¼ï¼ï¼ï¼ï¼ï¼æŒ‡å®šæ­¤å‡ºç«™ä¾¦å¬å™¨å¯ä»¥è®¿é—®çš„æœåŠ¡ä¸»æœºã€‚
      # æ ¼å¼ä¸º "namespace/dnsName" æˆ– "namespace/*" æˆ– "*/dnsName"ã€‚
      # æ”¯æŒé€šé…ç¬¦(*)ã€‚è¿™æ˜¯é™åˆ¶Sidecarâ€œå¯è§æ€§â€çš„å…³é”®ã€‚
      hosts:
        - "my-namespace/product-service.my-namespace.svc.cluster.local" # ç²¾ç¡®åŒ¹é…FQDN
        - "my-namespace/*" # å…è®¸è®¿é—®åŒå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰æœåŠ¡
        - "istio-system/*" # å…è®¸è®¿é—®istio-systemå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰æœåŠ¡ï¼ˆå¦‚Istiodï¼‰
        - "*/mysql.external.svc.cluster.local" # å…è®¸è®¿é—®ä»»ä½•å‘½åç©ºé—´ä¸‹çš„ç‰¹å®šå¤–éƒ¨æœåŠ¡(é€šè¿‡ServiceEntryå®šä¹‰)
        - "*/*.example.com" # å…è®¸è®¿é—®æ‰€æœ‰å‘½åç©ºé—´ä¸‹çš„å¤–éƒ¨.example.comåŸŸï¼ˆé€šé…ç¬¦åŒ¹é…ï¼‰

  # outboundTrafficPolicy å­—æ®µï¼šé…ç½®å‡ºç«™æµé‡çš„å…¨å±€å¤„ç†æ¨¡å¼ã€‚
  # è¿™ä¸ºé‚£äº›æœªè¢« `egress.hosts` æ˜ç¡®è¦†ç›–çš„æµé‡æä¾›äº†ä¸€ä¸ªå…œåº•ç­–ç•¥ã€‚
  outboundTrafficPolicy:
    # mode å­—æ®µï¼šç­–ç•¥æ¨¡å¼ã€‚
    # ALLOW_ANY: å…è®¸æµé‡å‘å¾€ä»»ä½•æœªåœ¨`egress.hosts`ä¸­å£°æ˜çš„å¤–éƒ¨æœåŠ¡ã€‚ï¼ˆé»˜è®¤æ¨¡å¼ï¼Œå®½æ¾ï¼‰
    # REGISTRY_ONLY: åªå…è®¸æµé‡å‘å¾€åœ¨ç½‘æ ¼æ³¨å†Œè¡¨ä¸­æ˜ç¡®å£°æ˜çš„æœåŠ¡ï¼ˆå¦‚K8s Service, ServiceEntryï¼‰ã€‚
    #                 å‘å¾€æœªå£°æ˜æœåŠ¡çš„æµé‡å°†è¢«Sidecaré˜»æ–­ã€‚ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼Œæ¨èç”¨äºå®‰å…¨ï¼‰
    mode: REGISTRY_ONLY

# æ³¨æ„ï¼š
# 1. æ­¤ç¤ºä¾‹ä¸ºäº†æ¼”ç¤ºï¼ŒåŒ…å«äº†æ‰€æœ‰å¯èƒ½å­—æ®µã€‚å®é™…é…ç½®é€šå¸¸åªéœ€é…ç½® `workloadSelector` å’Œ `egress.hosts`ã€‚
# 2. `ingress` åˆ—è¡¨é€šå¸¸ä¸éœ€è¦é…ç½®ï¼Œé™¤éæœ‰éå¸¸ç‰¹æ®Šçš„å…¥ç«™æµé‡å¤„ç†éœ€æ±‚ã€‚
# 3. `egress.hosts` çš„é…ç½®æ˜¯æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨åŠ å›ºçš„å…³é”®ï¼Œå®ƒå†³å®šäº†Sidecaré…ç½®çš„å¤§å°å’Œ workload çš„è®¿é—®æƒé™ã€‚
# 4. `outboundTrafficPolicy.mode: REGISTRY_ONLY` ä¸æ˜ç¡®çš„ `egress.hosts` åˆ—è¡¨ç»“åˆï¼Œå¯ä»¥å®ç°æœ€å°æƒé™åŸåˆ™ã€‚
```

### 3.2.7istioå¤–éƒ¨æµé‡æ²»ç†ï¼ˆç½‘æ ¼å¤–éƒ¨ï¼‰

```powershell
å°†k8sé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼Œå¼•å…¥åˆ°é›†ç¾¤å†…ï¼Œå½“åšç½‘æ ¼æ²»ç†
é€‚ç”¨äºä¸šåŠ¡è¿ç§»åˆ°æœåŠ¡ç½‘æ ¼çš„ä¸­é—´é˜¶æ®µï¼Œæ­¤æ—¶å¯èƒ½éƒ¨åˆ†æœåŠ¡å·²ç»è¿ç§»åˆ°ç½‘æ ¼ï¼Œä¸€éƒ¨åˆ†è¿˜æ˜¯vmã€ç‰©ç†æœºåœ¨è¿è¡Œï¼Œå°±éœ€è¦å¯¹å¤–éƒ¨çš„è¿™éƒ¨åˆ†åšæµé‡æ²»ç†

sidecar egressä¾¦å¬å™¨åœ¨allow_anyç­–ç•¥ä¸‹ï¼Œåœ¨ç½‘æ ¼ä¸­è¯·æ±‚æœªå®šä¹‰çš„å¤–éƒ¨æµé‡ï¼Œä½¿ç”¨çš„æ˜¯tcpé€ä¼ ï¼Œæ— æ³•åšç½‘ç»œæ²»ç†ï¼Œä½†æœ‰æ—¶åˆéœ€è¦æ²»ç†å¤–éƒ¨æœåŠ¡ï¼Œåˆ™éœ€è¦ä½¿ç”¨ServiceEntryèµ„æºï¼Œå°†å¤–éƒ¨èµ„æºæ³¨å†Œåˆ°istioä¸­ï¼Œå®ç°æ‰‹åŠ¨æ·»åŠ å¤–éƒ¨æœåŠ¡åˆ°ç½‘æ ¼ä¸­
TCPé€ä¼ å°±æ˜¯æŒ‡ï¼šIstio çš„ Sidecarï¼ˆEnvoyä»£ç†ï¼‰ä¸è§£å¯†ã€ä¸æŸ¥çœ‹ã€ä¸å¹²é¢„åŸå§‹çš„TCPæ•°æ®åŒ…çš„å†…å®¹ï¼Œä»…ä»…ä½œä¸ºä¸€ä¸ªç®€å•çš„ç½‘ç»œè·¯ç”±å™¨ï¼Œå°†æ•°æ®åŒ…åŸå°ä¸åŠ¨åœ°ä»å®¢æˆ·ç«¯è½¬å‘åˆ°åç«¯æœåŠ¡ã€‚

ServiceEntryèµ„æºå‘istioçš„æœåŠ¡æ³¨å†Œè¡¨æ·»åŠ 1ä¸ªServiceEntryåï¼ˆç›¸å½“äºsvcï¼‰ï¼Œç½‘æ ¼ä¸­çš„envoyå¯å°†æµé‡å‘ç»™æ³¨å†Œçš„è¿™ä¸ªsvcï¼Œä¹Ÿå¯åšç›¸å…³æ²»ç†ï¼ˆé…åˆvsã€drï¼‰

ç½‘æ ¼å¤–éƒ¨æœåŠ¡ï¼šè¿è¡Œåœ¨k8sä¸­ï¼Œä½†éistioç½‘æ ¼ç®¡ç†çš„å‘½åç©ºé—´ä¸­çš„podï¼Œæˆ–ç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºå’Œè™šæ‹Ÿæœºçš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡åœ¨ServiceEntryä¸­ç§°ä¸ºï¼šmesh_external
ç½‘å…³å†…ä½†æœªæ³¨å†ŒæœåŠ¡ï¼šæ²¡æœ‰svcçš„podç­‰ï¼Œåœ¨ServiceEntryä¸­ç§°ä¸ºï¼šmesh_internal
```

```powershell
WorkloadEntryï¼šå°†ä¸€ä¸ªå…·ä½“çš„ç«¯ç‚¹ï¼ˆVMçš„IPï¼‰æ³¨å†Œåˆ°ç½‘æ ¼ä¸­ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå¯è·¯ç”±çš„åç«¯ã€‚

ServiceEntryï¼šå°†ä¸€ä¸ªæœåŠ¡ï¼ˆä¸»æœºåã€ç«¯å£ã€åè®®ï¼‰æ·»åŠ åˆ°Istioçš„å†…éƒ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­ï¼Œè®©ç½‘æ ¼å†…çš„å…¶ä»–æœåŠ¡èƒ½å¤Ÿå‘ç°å¹¶ç†è§£è¿™ä¸ªæœåŠ¡ã€‚ï¼ˆä¹Ÿå¯ä»¥é…ç½®ç«¯ç‚¹ï¼‰

WorkloadGroupï¼šæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œç”¨äºå®šä¹‰ä¸€ç»„å…±äº«å…±åŒå±æ€§ï¼ˆå¦‚æ ‡ç­¾ã€ç«¯å£ã€å¥åº·æ£€æŸ¥è®¾ç½®ï¼‰çš„éPodå·¥ä½œè´Ÿè½½ï¼ˆå¦‚è™šæ‹Ÿæœºï¼‰ã€‚å®ƒæœ¬èº«ä¸ä»£è¡¨ä¸€ä¸ªå…·ä½“å®ä¾‹ï¼Œè€Œæ˜¯ç”¨äºè‡ªåŠ¨ç”Ÿæˆ WorkloadEntry çš„è“å›¾ã€‚ï¼ˆè‡ªåŠ¨ç”Ÿæˆè¿‡ç¨‹éœ€è¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„ istio-agent ç»„ä»¶æ¥é©±åŠ¨ï¼Œæ‰‹åŠ¨åˆ›å»ºçš„è¯å°±æ˜¯è¦†ç›–æ¨¡ç‰ˆé…ç½®ï¼Œæ¨¡ç‰ˆç›¸å½“äºé»˜è®¤é…ç½®ï¼‰

destination rule
```

![image-20230913142909761](202312161425917.png)

```powershell
# apiVersion: v1
# kind: Service
# metadata:
#   name: catalog-service
#   namespace: my-namespace
---
apiVersion: v1
kind: Service
metadata:
  name: catalog-service
  namespace: my-namespace
spec:
  ports:
  - name: http        # ç«¯å£åç§°ï¼Œå¿…é¡»ä¸WorkloadEntryä¸­çš„ç«¯å£æ˜ å°„é”®åå¯¹åº”
    port: 80          # Serviceæœ¬èº«çš„è™šæ‹Ÿç«¯å£ï¼Œé›†ç¾¤å†…å…¶ä»–æœåŠ¡é€šè¿‡ catalog-service:80 è®¿é—®
    targetPort: http  # æŒ‡å‘WorkloadEntryä¸­å®šä¹‰çš„ç«¯å£é”®å 'http' (å¯¹åº”VMä¸Šçš„8080ç«¯å£)
  - name: grpc        # ç¬¬äºŒä¸ªç«¯å£
    port: 9090
    targetPort: grpc
  selector:
    # ã€æ ¸å¿ƒã€‘è¿™ä¸ªé€‰æ‹©å™¨ç”¨äºé€‰æ‹©Podï¼Œä½†ä¹Ÿä¼šè‡ªåŠ¨é€‰æ‹©å…·æœ‰ç›¸åŒæ ‡ç­¾çš„WorkloadEntryï¼
    app: catalog
    version: v1
  type: ClusterIP     # é€šå¸¸æ˜¯ClusterIPï¼Œå› ä¸ºè®¿é—®æ¥è‡ªé›†ç¾¤å†…éƒ¨

---
# apiVersion: networking.istio.io/v1beta1
# kind: ServiceEntry
# metadata:
#   name: catalog-serviceentry
#   namespace: my-namespace
---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: catalog-serviceentry
  namespace: my-namespace
spec:
  hosts:
    # æ­¤ServiceEntryæ‰€ä»£è¡¨çš„æœåŠ¡çš„ä¸»æœºåã€‚
    # å…¶ä»–æœåŠ¡å¯ä»¥é€šè¿‡è¿™ä¸ªä¸»æœºåè®¿é—®catalogæœåŠ¡ã€‚
    - catalog-service.my-namespace.svc.cluster.local # æ ‡å‡†K8sæœåŠ¡DNS
    - catalog.mydomain.com # å¯èƒ½çš„å¤–éƒ¨åŸŸåï¼ˆå¯é€‰ï¼‰
  addresses: # ï¼ˆå¯é€‰ï¼‰å¯ä»¥ç»‘å®šåˆ°ç‰¹å®šIPæ®µ
    - 192.168.12.0/24
  ports:
    - number: 80    # ç«¯å£å·ï¼Œå¯¹åº”Serviceçš„port
      name: http    # ç«¯å£åç§°ï¼Œå¯¹åº”Serviceçš„ports.name
      protocol: HTTP # åè®®ç±»å‹ã€‚æ˜ç¡®åè®®åï¼ŒIstioæ‰èƒ½æä¾›é«˜çº§HTTPåŠŸèƒ½ï¼ˆå¦‚è·¯ç”±ã€é‡è¯•ï¼‰
    - number: 9090
      name: grpc
      protocol: GRPC # æˆ–HTTP2
  location: MESH_INTERNAL # æŒ‡å®šæ­¤æœåŠ¡æ˜¯ç½‘æ ¼çš„ä¸€éƒ¨åˆ†ï¼ˆå°½ç®¡åœ¨VMä¸Šè¿è¡Œï¼‰
  resolution: STATIC # è§£ææ¨¡å¼ä¸ºSTATICï¼Œå› ä¸ºæˆ‘ä»¬å°†é€šè¿‡WorkloadEntryæä¾›å…·ä½“çš„ç«¯ç‚¹
  # æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æŒ‡å®šendpointsï¼Œç«¯ç‚¹ç”±Serviceé€šè¿‡selectorä»WorkloadEntryä¸­è‡ªåŠ¨è·å–
```

![image-20230913170449053](202312161558162.png)

```powershell
# apiVersion: networking.istio.io/v1alpha3
# kind: WorkloadGroup
# metadata:
#   name: catalog-workloadgroup
#   namespace: my-namespace
---
apiVersion: networking.istio.io/v1alpha3
kind: WorkloadGroup
metadata:
  name: catalog-workloadgroup
  namespace: my-namespace
  labels:
    # åº”ç”¨äºä»æ­¤æ¨¡æ¿åˆ›å»ºçš„æ‰€æœ‰WorkloadEntryçš„é»˜è®¤æ ‡ç­¾
    app: catalog
    tier: backend
  annotations:
    # å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ ä¸€äº›æ³¨è§£ï¼Œä¾‹å¦‚é…ç½®è¯´æ˜æˆ–è‡ªå®šä¹‰å…ƒæ•°æ®
    description: "WorkloadGroup for the catalog service VM instances"
    owner: "team-a"
spec:
  # template å­—æ®µï¼šå®šä¹‰äº†ç”±æ­¤WorkloadGroupåˆ›å»ºçš„æ–°WorkloadEntryçš„è“å›¾
  template:
    # ä»¥ä¸‹å­—æ®µä¼šä½œä¸ºæ–°åˆ›å»ºçš„WorkloadEntryçš„spec
    address: 192.168.12.100 # ã€å¿…éœ€ã€‘è™šæ‹Ÿæœºæˆ–å¤–éƒ¨å·¥ä½œè´Ÿè½½çš„åœ°å€
    ports:
      # ã€å¿…éœ€ã€‘å·¥ä½œè´Ÿè½½å…¬å¼€çš„ç«¯å£æ˜ å°„ã€‚é”®åæ˜¯ç«¯å£åç§°ï¼Œå€¼ä¸Serviceç«¯å£å¯¹åº”ã€‚
      http: 8080 # ä¾‹å¦‚ï¼ŒServiceä¸­åä¸º'http'çš„ç«¯å£åº”æ˜ å°„åˆ°å·¥ä½œè´Ÿè½½çš„8080ç«¯å£
      grpc: 9090
    labels:
      # æ ‡è¯†å·¥ä½œè´Ÿè½½å®ä¾‹çš„æ ‡ç­¾ã€‚è¿™äº›æ ‡ç­¾å¯ç”¨äºServiceçš„é€‰æ‹©å™¨ä»¥åŠDestinationRuleä¸­çš„å­é›†é€‰æ‹©ã€‚
      app: catalog
      version: v1 # ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¯ç”¨äºé‡‘ä¸é›€å‘å¸ƒ
      instance-id: vm-zone-a-01 # å®ä¾‹æ ‡è¯†ç¬¦
    network: cloud-vpc-1 # ã€å¯é€‰ã€‘å·¥ä½œè´Ÿè½½æ‰€åœ¨çš„ç½‘ç»œåç§°ã€‚ç”¨äºè·¨ç½‘ç»œé€šä¿¡çš„é…ç½®ã€‚
    locality:
      # ã€å¯é€‰ã€‘å·¥ä½œè´Ÿè½½çš„åŒºåŸŸä¿¡æ¯ï¼Œç”¨äºåœ°åŸŸæ„ŸçŸ¥è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚
      region: us-west-1
      zone: us-west-1a
    weight: 100 # ã€å¯é€‰ã€‘å·¥ä½œè´Ÿè½½çš„æƒé‡ï¼Œç”¨äºè´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆé»˜è®¤1ï¼‰
    serviceAccount: catalog-service-account # ã€å¯é€‰ã€‘ä¸æ­¤å·¥ä½œè´Ÿè½½å…³è”çš„æœåŠ¡å¸æˆ·ã€‚ç”¨äºmTLSç­‰å®‰å…¨èº«ä»½ã€‚
  # probe å­—æ®µï¼šç”¨äºæŒ‡å¯¼Istioå¦‚ä½•å¯¹ç”±æ­¤ç»„åˆ›å»ºçš„å·¥ä½œè´Ÿè½½æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚
  # è¿™ç”¨äºç”Ÿæˆå¼‚æ­¥å¥åº·æ£€æŸ¥ä¿¡æ¯ï¼Œè¾…åŠ©Envoyçš„è´Ÿè½½å‡è¡¡å†³ç­–ã€‚
  probe:
    # initialDelaySeconds: å®¹å™¨å¯åŠ¨åç­‰å¾…å¤šå°‘ç§’æ‰å¯åŠ¨æ¢é’ˆï¼ˆé»˜è®¤0ï¼‰
    initialDelaySeconds: 5
    # timeoutSeconds: æ¢é’ˆæ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤1ï¼‰
    timeoutSeconds: 2
    # periodSeconds: æ‰§è¡Œæ¢é’ˆçš„æ—¶é—´é—´éš”ï¼ˆé»˜è®¤10ï¼‰
    periodSeconds: 10
    # successThreshold: æ¢é’ˆå¤±è´¥åï¼Œæœ€å°‘è¿ç»­æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸï¼ˆé»˜è®¤1ï¼‰
    successThreshold: 1
    # failureThreshold: æ¢é’ˆå¤±è´¥åï¼Œæœ€å°‘è¿ç»­å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ï¼ˆé»˜è®¤2ï¼‰
    failureThreshold: 3
    # å®šä¹‰å¥åº·æ£€æŸ¥çš„å…·ä½“æ–¹å¼ã€‚åªèƒ½ä½¿ç”¨ä¸€ç§ï¼šhttpGet, tcpSocket, æˆ– execã€‚
    httpGet:
      # path: è®¿é—®HTTPæœåŠ¡å™¨çš„è·¯å¾„
      path: /health/ready
      # port: å¥åº·æ£€æŸ¥ç«¯å£çš„åç§°æˆ–æ•°å­—ã€‚è¿™é‡Œæ˜¯ç«¯å£åç§°ï¼Œå¯¹åº”ä¸Šé¢portsä¸­çš„'http'
      port: http
      # host: è¿æ¥ä½¿ç”¨çš„ä¸»æœºåï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºPod IPï¼‰
      host: catalog.mydomain.com
      # scheme: ç”¨äºè¿æ¥çš„æ–¹æ¡ˆï¼ˆHTTP æˆ– HTTPSï¼Œé»˜è®¤HTTPï¼‰
      scheme: HTTPS
      # httpHeaders: è¯·æ±‚ä¸­è®¾ç½®çš„è‡ªå®šä¹‰HTTPå¤´
      httpHeaders:
        - name: Custom-Header
          value: ProbeValue
        - name: Authorization
          value: Bearer s3cr3t
    # å¦‚æœä½¿ç”¨TCPæ£€æŸ¥ï¼Œåˆ™é…ç½®æ­¤é¡¹ï¼ˆä¸httpGetäºŒé€‰ä¸€ï¼‰
    # tcpSocket:
    # port: 8080 # ç«¯å£å·æˆ–åç§°
    # å¦‚æœä½¿ç”¨å‘½ä»¤æ£€æŸ¥ï¼Œåˆ™é…ç½®æ­¤é¡¹ï¼ˆä¸httpGetã€tcpSocketä¸‰é€‰ä¸€ï¼‰
    # exec:
    # command:
    # - curl
    # - -f
    # - http://localhost:8080/health

---
# æ ¹æ®ä¸Šè¿°WorkloadGroupæ¨¡æ¿ï¼Œæ‰‹åŠ¨æˆ–è‡ªåŠ¨åˆ›å»ºçš„WorkloadEntryç¤ºä¾‹ï¼Œè¯¥èµ„æºæ²¡æœ‰probeå­—æ®µ
# apiVersion: networking.istio.io/v1alpha3
# kind: WorkloadEntry
# metadata:
#   name: catalog-vm-1
#   namespace: my-namespace
---
apiVersion: networking.istio.io.v1alpha3
kind: WorkloadEntry
metadata:
  name: catalog-vm-1
  namespace: my-namespace
  labels:
    app: catalog
    version: v1
    instance-id: vm-zone-a-01 # å…·ä½“å®ä¾‹çš„æ ‡è¯†
spec:
  address: 192.168.12.101 # ã€å¿…éœ€ã€‘è¿™å°ç‰¹å®šè™šæ‹Ÿæœºçš„å®é™…IP
  ports:
    http: 8080 # æ˜ å°„åˆ°Serviceçš„'http'ç«¯å£
    grpc: 9090 # æ˜ å°„åˆ°Serviceçš„'grpc'ç«¯å£
  labels:
    app: catalog
    version: v1
    instance-id: vm-zone-a-01 # ä¸metadata.labelsä¸­çš„ä¸€è‡´ï¼Œä¹Ÿå¯ç”¨äºé€‰æ‹©
  network: cloud-vpc-1
  locality:
    region: us-west-1
    zone: us-west-1a
  weight: 90 # è¿™å°å®ä¾‹çš„ç‰¹å®šæƒé‡
  serviceAccount: catalog-service-account
# æ³¨æ„ï¼šWorkloadEntryæœ¬èº«ä¸åŒ…å«probeé…ç½®ã€‚å¥åº·æ£€æŸ¥ç”±WorkloadGroupå®šä¹‰æˆ–ç›´æ¥åœ¨Sidecarä¸­é…ç½®ã€‚
```

### 3.2.8envoyfilterèµ„æº

```powershell
ç›´æ¥é…ç½®ç½‘æ ¼ä¸­envoyçš„filterï¼Œä½¿ç”¨envoyåŸç”Ÿè¯­æ³•ï¼Œä»¥è¡¥ä¸/åˆå¹¶å¼åˆï¼Œé…ç½®åˆ°sidecar envoyä¸Š
istioå¹¶æ²¡æœ‰å®Œå…¨å®ç°envoyçš„å…¨éƒ¨åŠŸèƒ½ï¼Œæ‰€ä»¥æœ‰äº›é¢å¤–çš„åŠŸèƒ½ï¼Œéœ€è¦ç”¨envoyfilterèµ„æºï¼Œé…ç½®envoyçš„å„ç§è¿‡æ»¤å™¨
envoyfilterèµ„æºæä¾›è‡ªå®šä¹‰sidecar envoyçš„é…ç½®æ¥å£ï¼Œæ”¯æŒä¿®æ”¹ã€æ·»åŠ å­—æ®µï¼Œå¢åŠ ä¾¦å¬å™¨ã€é›†ç¾¤ç­‰

æœªå®ç°åŠŸèƒ½ï¼š
è·¨åŸŸé›†ç¾¤ç½‘ç»œæ„å»ºï¼šenvoyfilter + se + gw
æ‰©å±•è®¤è¯
é™é€Ÿ
è®¿é—®æ—¥å¿—ç­‰

åº”è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½ç ´åç½‘æ ¼ç¨³å®šæ€§ï¼ï¼ï¼å¯èƒ½ä¼šäº§ç”Ÿå†²çª
```

```powershell
kubectl get envoyfilter -n istio-system
```



### 3.2.9istioå¯è§‚æµ‹æ€§

https://www.cnblogs.com/suyanhj/articles/17926673.html

istioå°†envoyçš„å¯è§‚æµ‹æ€§åŠŸèƒ½è¿›ä¸€æ­¥ç®€åŒ–ï¼Œå¯ä»¥å®ç°ç½‘æ ¼åˆ°ç½‘æ ¼ä¹‹é—´æŒ‡æ ‡é‡‡é›†ï¼Œæš´éœ²ç­‰ï¼Œä½†ç½‘æ ¼å†…ä¸šåŠ¡åº”ç”¨å†…éƒ¨è‡ªèº«çš„æ•°æ®æ˜¯é‡‡é›†ä¸äº†çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨ä¸šåŠ¡ç¨‹åºä¸­åšè¿›ä¸€æ­¥å¤„ç†

```powershell
Istio è´Ÿè´£ç”ŸæˆæœåŠ¡é—´çš„è¿½è¸ªä¸Šä¸‹æ–‡ï¼ˆTrace Contextï¼‰å¹¶ä¼ æ’­ï¼Œä¸ºæ•´ä¸ªè°ƒç”¨é“¾æä¾›åŸºç¡€ã€‚
åº”ç”¨ç¨‹åºåˆ©ç”¨æ¥æ”¶åˆ°çš„ä¸Šä¸‹æ–‡ï¼Œåˆ›å»ºæ›´ç»†ç²’åº¦çš„å†…éƒ¨Spanï¼Œå¹¶å°†å…¶ä¸ŠæŠ¥åˆ°åŒä¸€ä¸ªè¿½è¸ªåç«¯ï¼ˆå¦‚Jaegerï¼‰ã€‚
```

**istioæ”¯æŒï¼š**

- æŒ‡æ ‡ï¼šæœåŠ¡é—´é€šä¿¡æŒ‡æ ‡ã€envoy statsæŒ‡æ ‡ï¼ˆå†…ç½®ï¼‰ã€æ§åˆ¶å¹³é¢æŒ‡æ ‡
- æ—¥å¿—ï¼šè®¿é—®æ—¥å¿—ï¼Œenvoyè‡ªèº«æ—¥å¿—
- é“¾è·¯è¿½è¸ªï¼šenvoyé—´ä¼ æ’­æœºåˆ¶

**ä¸šåŠ¡åº”ç”¨éœ€è¦æ”¯æŒï¼š**

- æŒ‡æ ‡ï¼šä¸šåŠ¡åº”ç”¨è‡ªèº«æŒ‡æ ‡æš´éœ²ï¼ˆjmxï¼‰
- æ—¥å¿—ï¼šè‡ªèº«æ—¥å¿—
- é“¾è·¯è¿½è¸ªï¼šå…¼å®¹è¿½è¸ªç³»ç»Ÿçš„åŸ‹ç‚¹

**æŒ‡æ ‡**

æŒ‡æ ‡åŒ…æ‹¬ï¼š

- ä»£ç†æŒ‡æ ‡ï¼šæ•°æ®å¹³é¢æŒ‡æ ‡ï¼ˆenvoy proxyï¼‰ 15020
- æœåŠ¡æŒ‡æ ‡ï¼šå››ä¸ªé»„é‡‘æŒ‡æ ‡ï¼ˆå»¶è¿Ÿæµé‡é”™è¯¯é¥±å’Œåº¦ï¼‰   (envoy stats)
- æ§åˆ¶å¹³é¢æŒ‡æ ‡ï¼šistiodè‡ªèº«çš„æŒ‡æ ‡ï¼Œæ™®ç½—ç±³ä¿®æ–¯æ‹‰å–æš´éœ²ç«¯å£ä¸º15014/tcp

envoyç»Ÿè®¡æ•°æ®åˆ†ç±»ï¼š

- upstreamï¼šç¦»å¼€å½“å‰envoyå®ä¾‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬é›†ç¾¤ç®¡å¥åº·ã€æ–­è·¯å™¨ã€tlsç­‰
- downstreamï¼šä¼ å…¥å½“å‰envoyå®ä¾‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¾¦å¬å™¨ã€httpè¿æ¥ç®¡ç†å™¨ã€tcpä»£ç†è¿‡æ»¤å™¨ç­‰
- envoy serverï¼šenvoyæœåŠ¡å®ä¾‹è‡ªèº«ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿è¡Œæ—¶é—´ã€åˆ†é…å†…å­˜ç­‰

```powershell
kubectl exec podå -- curl localhost:15000/stats/prometheus

istioctl pc bootstrap podå |jq .bootstrap.statsConfig
pc æ˜¯ proxy-config çš„ç¼©å†™ã€‚bootstrap æ˜¯å­å‘½ä»¤ï¼Œç”¨äºè·å– Envoy çš„å¯åŠ¨é…ç½®ã€‚è¿™æ˜¯ Envoy æœ€æ ¸å¿ƒçš„é…ç½®ä¹‹ä¸€ï¼Œç”± Istiod ç”Ÿæˆå¹¶ä¸‹å‘ç»™æ¯ä¸ª Sidecarã€‚
```



#### 3.2.9.0é…ç½®æ¡ˆä¾‹

```powershell
Telemetry èµ„æºçš„æ ¸å¿ƒè®¾è®¡ç›®çš„å°±æ˜¯ä¸ºå®ç° Istio å¯è§‚æµ‹æ€§åŠŸèƒ½çš„ç»†ç²’åº¦æ§åˆ¶
ä¸ºé‡è¦æœåŠ¡æé«˜é‡‡æ ·ç‡
ç²¾ç»†åœ°æ§åˆ¶ metrics, tracing, access logging çš„å„ä¸ªæ–¹é¢ã€‚

Pod æ³¨è§£ (æœ€é«˜ä¼˜å…ˆçº§ï¼Œæœ€ç»†ç²’åº¦) - e.g., proxy.istio.io/config
Telemetry èµ„æº (ä¸­ç­‰ä¼˜å…ˆçº§ï¼Œå£°æ˜å¼æ§åˆ¶) 
å…¨å±€é»˜è®¤é…ç½® (æœ€ä½ä¼˜å…ˆçº§) - é€šè¿‡ IstioOperator æˆ– istio ConfigMap è®¾ç½®

spec:
  metrics | tracing | accessLogging: # ã€1. é€‰æ‹©é¥æµ‹ç±»å‹ã€‘
    - providers: [ - name: ... ]     # ã€2. æŒ‡å®šç›®çš„åœ°ï¼ˆæœ¬é—®é¢˜çš„æ ¸å¿ƒï¼‰ã€‘
      ... # ã€3. å®šä¹‰ç”Ÿæˆè§„åˆ™ã€‘
      overrides: ...                 # ã€4. ç²¾ç»†æ§åˆ¶æ•°æ®å†…å®¹ï¼ˆæŒ‡æ ‡æ ‡ç­¾ç­‰ï¼‰ã€‘
      randomSamplingPercentage: ...  # ã€5. ç²¾ç»†æ§åˆ¶æ•°æ®é‡ï¼ˆé‡‡æ ·ç‡ï¼‰ã€‘
      filter: ...                    # ã€6. ç²¾ç»†æ§åˆ¶æ•°æ®è¿‡æ»¤ï¼ˆæ—¥å¿—è¿‡æ»¤ï¼‰ã€‘
      customTags: ...                # ã€7. ç²¾ç»†æ§åˆ¶æ•°æ®å†…å®¹ï¼ˆè¿½è¸ªæ ‡ç­¾ï¼‰ã€‘
      

```

