## promtheus operator监控

1.节点ip冲突：在节点关机的情况下将其驱逐后又在节点开机的情况下将其添加入k8s集群，导致有两个ip相同的节点

2.拉不了镜像：走代理或者自己制作镜像

3.promethues operator没监控到controller manager和scheduler：k8s控制组件都是二进制部署，kubelet能监控到是因为本质上是node监控，可以通过kubernetes_sd_config发现，apiserver能监控到是因为它本身就有个入口endpoints，而这两个只是在监听/请求apiserver。解决：让 metrics 暴露在可被外部访问的地址（如 `0.0.0.0`），创建 `Service` + Endpoints

```powershell
新建了一个 Endpoints，和 Service 同名、同 namespace
这样 Service 和 Endpoints 就关联上了。

排错重点关注整个链路
Prometheus Operator 通过 Service 找到 Endpoints → 从 Endpoints 里解析出真实的 IP:Port → 下发到 Prometheus → 开始采集。

其他链路
pod
PodMonitor → 选 Pod → Pod.status.podIP + 容器端口 → 下发到 Prometheus
node
Prometheus Operator → kubernetes_sd_configs (role: node) → Node.status.addresses → 下发到 Prometheus

role: ingress → 发现 Ingress backend
role: endpointslice → 直接发现 EndpointSlice

Prometheus scrape_configs.static_configs → 直接写死 IP:Port → 下发到 Prometheus
```

4.时区更改

5.权限问题：nginx：root运行主进程，nginx运行nginx。注意：多阶段构建会导致复制过去的文件并没有nginx的权限，单阶段编译时就给了权限，直接以官方nginx为基础，vts编译进内核

```powershell
总结:多阶段构建很多时候并不是很好，特别是文件目录很多的程序
```

6.prometheus新资源监控不到：operator默认给promethe的权限太低了

```powershell
链路什么都没有问题，
[root@master1 external-solution]# kubectl auth can-i get endpoints -n test --as system:serviceaccount:monitoring:prometheus-k8s
no

yaml与yaml之间：读endpoints
访问能正常访问，就是发现不了endpoints
```

7.request_time采集不上：要不promql要不就是nginx配置问题，还有一点就是本地请求太快可能记录不到

8.钉钉模版语法错误：logs -f

9.alertmanagerConfig版本问题：默认装v1alpha1版本，不支持自定义告警模版
10.告警消息未分组：一般是标签问题，标签未获取到，所以promql必须先看看能不能获取标签

11.ui上，配置上都没问题，起个pod也能访问dingtalkwebhook，怀疑是alertmanager没有权限访问其他pod导致的，结果egress是可以访问所有的。最后发现是因为operator不会自动发现alertmanagerconfig资源（真得看看官方文档了）

```powershell
vim alertmanager-alertmanager.yaml
  alertmanagerConfigSelector: # 匹配 AlertmanagerConfig 的标签
    matchLabels:
      app.kubernetes.io/part-of: kube-prometheus
```

12.一般servicemonitor，rule,alert等资源都和被监控对象放在同一个命名空间，之前的权限问题可能就没问题了
