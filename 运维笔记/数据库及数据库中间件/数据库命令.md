[TOC]

# 1.mysql

## 1.1mysql工具使用

```powershell
配置文件
/etc/my.cnf
/etc/my.cnf.d/

mysql -e "source /root/test.sql"
```

```powershell
mysql -V

登录
mysql --user=root --host=m52.magedu.rocky86 --port=3306
-uroot -p123456 -P3306
指定数据库
mysql information_schema

mysqladmin status
```

## 1.2权限管理

```sql
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER
ON mydb.*
TO 'myuser'@'192.168.1.100'     #% 或者 192.168.1.%
IDENTIFIED BY 'MyS3cureP@ss!';   #如果已经有密码则不会更改
grant * on *.* to 'root'@'%' identified by '';

```

## 1.3管理数据库

```powershell
字符集
show CHARACTER SET;
查看数据库列表
SHOW DATABASES;
查看创建语句，包含默认字符集
show create database testdb1;
查看表结构
desc student;
查看表状态
show table status
查看表索引
show index from student\G
优化表空间，使用时会锁表
OPTIMIZE TABLE tb_name;
查看版本
select version();
查看相关文件
show variables like '%datadir%';
```

```powershell
看死锁
SHOW ENGINE INNODB STATUS\G
#查看正在进行中的事务
SELECT * FROM information_schema.INNODB_TRX;
#查看锁
SELECT * FROM information_schema.INNODB_LOCKS;
#MySQL8.0.13 及以后使用此语句查看锁
SELECT * FROM performance_schema.data_locks;
#查看锁等待
SELECT * FROM information_schema.INNODB_LOCK_WAITS;
#MySQL8.0.13及以后使用此语句查看锁等待
SELECT * FROM performance_schema.data_lock_waits;
```

## 1.4常用文件及目录

```powershell
创建两个数据库，本质上是在硬盘上创建了两个目录
/var/lib/mysql/testdb1 
/var/lib/mysql/testdb2

/etc/my.cnf
/etc/my.cnf.d/

查看相关文件-redo log
/var/lib/mysql/ib_logfile*
```

## 1.5Data Defination Language

CREATE/ALTER/DROP

```powershell
CREATE TABLE student (
id int UNSIGNED AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(20) NOT NULL,
age tinyint UNSIGNED,
#height DECIMAL(5,2),
gender ENUM('M','F') default 'M'
)ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4;

ALTER DATABASE testdb2 character set utf8mb4 COLLATE
判断
DROP DATABASE IF EXISTS testdb2;

#修改表名
MariaDB [db1]> ALTER TABLE student RENAME stu;

#修改字段类型
MariaDB [db1]> ALTER TABLE stu MODIFY phone int;

#修改字段名称和类型
MariaDB [db1]> ALTER TABLE stu CHANGE COLUMN phone mobile char(11);

#删除字段
MariaDB [db1]> ALTER TABLE stu DROP COLUMN mobile;

#修改表字符集
MariaDB [db1]> ALTER TABLE stu character SET utf8;
#同时修改数据类型和字符集，只修改字符集，类型也不能少
MariaDB [db1]> ALTER TABLE stu CHANGE name name char(30) character set utf8;

#设置字段默认值
MariaDB [db1]> alter table stu alter column gender set default 'M';

#添加字段和修改字段
MariaDB [db1]> ALTER TABLE stu ADD is_del bool DEFAULT false;
```

## 1.6DML

```powershell
INSERT INTO stu VALUES(12,'xiaoli',19,'F',0);

INSERT INTO stu (name,age)VALUES('test1',20),('test2',21),
('test3',22);

update stu SET age=21, gender='M' WHERE ( id=15 OR name IS NULL );

delete from stu where ( name IS NULL or id=14 ); #物理删除
```

## 1.7DQL

```powershell
#分组统计
MariaDB [db1]> select sum(age),gender from stu group by gender;

#分组统计
MariaDB [db1]> select sum(age),gender from stu group by gender;

#分组带where条件
MariaDB [db1]> select count(*),max(id),avg(age),gender from stu where age is not null group by gender;

#分组后过滤
MariaDB [db1]> select count(*) as total,max(id),avg(age),gender from stu where 
age is not null group by gender having total=3;

#用分组结果排序
MariaDB [db1]> select sum(age) sum_age,avg(age) avg_age,gender from stu where age is not null group by gender order by sum_age asc;

#去重
MariaDB [db1]> select distinct age from stu order by age desc;

#第一页，每页3条记录
MariaDB [db1]> select id ,name from stu limit 0,3;
```

![image-20250709143549384](image-20250709143549384.png)

```powershell
子查询
select name,age from stu where age<(select avg(age) from teacher);

联合查询
select id,name from stu union select id,name from teacher;
```

## 1.8sql优化

```go
explain select * from student where name="wangwu"\G;
```

## 1.9mysqlbinlog

```go
mysqlbinlog --start-position=678 --stop-position=752 /mysql/log/binlog.000001 -v

mysqlbinlog --start-datetime="2018-01-30 20:30:10" --stop-datetime="2018-01-30 20:35:22" /mysql/log/binlog.000001 -v

mysql> show master logs;
mysql> show binary logs;

SHOW MASTER STATUS

mysql> flush logs;
mysql> show binary logs;
```

## 1.10mysqldump
