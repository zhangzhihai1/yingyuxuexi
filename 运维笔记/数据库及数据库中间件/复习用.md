# 1.mysql

```powershell

```



# 2.redis

## 一些基本概念

基础理论

```powershell
cap
CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。
CP - 满足一致性，分区容忍性的系统，通常性能不是特别高。 放弃可用性，追求强一致性和分区容错性
AP - 满足可用性，分区容忍性的系统，通常可能对一致性要求低一些。最终一致性

Base理论是三要素的缩写：基本可用（Basically Available）、软状态（Soft-state）、最终一致性（Eventually Consistency）。基本可用：失败时支持加载默认显示的内容（缓存），软状态：如粉丝数，这种数据中间状态不影响整体可用性
```

应用场景

```powershell
缓存：缓存RDBMS中数据,比如网站的查询结果、商品信息、微博、新闻、消息
Session 共享：实现Web集群中的多服务器间的session共享
计数器：商品访问排行榜、浏览数、粉丝数、关注、点赞、评论等和次数相关的数值统计场景
社交：朋友圈、共同好友、可能认识他们等
地理位置: 基于地理信息系统GIS（Geographic Information System)实现摇一摇、附近的人、外卖等功能
消息队列：ELK等日志系统缓存、业务的订阅/发布系统
```

缓存穿透,缓存击穿和缓存雪崩

```powershell
1.缓存穿透 Cache Penetration：缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求
解决方法：接口层增加校验，如用户鉴权校验，id做基础校验，id<=0的直接拦截

2.缓存击穿 Cache breakdown：缓存击穿是指缓存中没有但数据库中有的数据，且并发量大
解决方法：设置热点数据永远不过期。

3.缓存雪崩 Thunder Hurd Problem：缓存雪崩是指缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。
解决方法：缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生
如果缓存数据库是分布式部署，将热点数据均匀分布在不同搞得缓存数据库中
设置热点数据永远不过期
```

## 配置管理

config 命令用于查看当前redis配置、以及不重启redis服务实现动态更改redis配置等

**注意：不是所有配置都可以动态修改,且此方式无法持久保存**

/etc/redis/redis.conf

```powershell
#安全优化
rename-command flushall ""
rename-command flushdb ""
rename-command keys* ""
rename-command shutdown ""
```

客户端及常见工具

```powershell
apps/redis/bin目录下:redis-benchmark/redis-check-aof/redis-check-rdb/redis-cli/redis-sentinel/redis-server

Another-Redis-Desktop-Manager 客户端连接工具
```

## 常见命令

```powershell
INFO
SELECT   #切换数据库
keys *  慎用
FLUSHDB  清空
SLOWLOG GET [n] #查看慢日志的最近n条记录，默认为10
SHUTDOWN

常见数据类型：string，list，set，hash
```

## redis持久化

```powershell
RDB(Redis DataBase)：是基于某个时间点的快照，注意RDB只保留当前最新版本的一个快照
save执行过程会使用主进程进行快照，并生成临时文件temp-<主进程PID>.rdb文件
bgsave会fork子进程
save 3600 1 300

AOF可以指定不同的保存策略,默认为每秒钟执行一次 fsync,按照操作的顺序地将变更命令追加至指定的AOF日志文件尾部
在第一次开启AOF功能时,会自动备份所有数据到AOF文件中,后续只会记录数据的更新指令
aof-rewrite，对aof文件进行整理,将空闲空间回收,从而可以减少恢复数据时间
缺点：即使有些操作是重复的也会全部记录，AOF 的文件大小一般要大于 RDB 格式的文件
BGREWRITEAOF
```

## 主从哨兵与cluster

主从

```powershell
当master出现故障后,可以自动提升一个slave节点变成新的Mster,因此Redis Slave 需要设置和master相同的连接密码
当配置Redis复制功能时，强烈建议打开主服务器的持久化功能

Redis Server 默认为 master节点，如果要配置为从节点,需要指定master服务器的IP,端口及连接密码
从节点执行 REPLICAOF MASTER_IP PORT 指令可以启用主从同步复制功能
INFO replication  查看本机
REPLICAOF NO ONE  

避免复制风暴：采用级联复制
```

哨兵

```powershell
redis哨兵基于redis主从
Sentinel实际上是一个特殊的redis服务器,有些redis指令支持,但很多指令并不支持.默认监听在26379/tcp端口.哨兵服务可以和Redis服务器分开部署在不同主机，但为了节约成本一般会部署在一起
```

redis cluster

```powershell
使用哨兵 Sentinel 只能解决Redis高可用问题，实现Redis的自动故障转移,但仍然无法解决Redis Master 单节点的性能瓶颈问题
集群搭建还要考虑单机redis是否已经不能满足业务的并发量，在redis sentinel同样能够满足高可用，且并发并未饱和的前提下，搭建集群反而是画蛇添足了。
```

```powershell
redis-cli -a 123456 --cluster create 10.0.0.8:6379   10.0.0.18:6379   10.0.0.28:6379   10.0.0.38:6379   10.0.0.48:6379   10.0.0.58:6379 --cluster-replicas 1

#观察以上命令结果，可以看到3组master/slave
master:10.0.0.8---slave:10.0.0.38
master:10.0.0.18---slave:10.0.0.48
master:10.0.0.28---slave:10.0.0.58
```

其他

```powershell
集群扩缩容   --cluster
集群偏斜   某个节点数据偏多,内存消耗更大,或者接受用户请求访问更多   查找 bigkey
```

