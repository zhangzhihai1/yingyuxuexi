# 1.ansible

## 1.1ansible简洁及模块

```powershell
学习样本可以是：kubeasz项目
帮助ansible -h
专用格式：ansible <目标主机> -m 模块 -a 模块参数     默认command模块
命令方式：在命令行执行ansible的方式叫"Ad-Hoc",肯定还有其他执行方式。
/usr/bin/ansible
/usr/bin/ansible-doc # ansible模块帮助命令
/usr/bin/ansible-playbook # ansible 任务管理工具
```

配置文件

```powershell
/etc/ansible/ansible.cfg
[defaults]
inventory = /etc/ansible/hosts,/a/b/hosts                 主机清单
roles_path = /a/b/roles:/opt/ansible/roles                 角色
/etc/ansible/hosts         主机清单
/etc/ansible/roles/        存放角色的文件
[配置段]
属性  = 值

生成全格式配置文件ansible-config init -t all --disabled > ansible_all.cfg

Ansible 查找 ansible.cfg 的优先级：
ANSIBLE_CONFIG 环境变量指定的路径
当前工作目录下的 ansible.cfg
用户家目录 ~/.ansible.cfg
系统默认 /etc/ansible/ansible.cfg
```

ansible

```powershell
ansible-doc
-l 显示所有模块
ansible-doc 模块（如command） -s 显示简单的帮助信息
chdir:             # 执行命令前，先切换工作路径


ansible
-u 指定用户如putong            ssh-copy-id putong@10.0.0.12

ansible-console       让我们以可交互终端形式执行命令
执行用户@主机组 (主机数量)[f:并发数]$ 模块 执行命令

ansible-galaxy    https://galaxy.ansible.com  大量模版role，username.role_name
delete 删除 import 导入 info 查看信息 init 本地初始化 install 安装
list 罗列 login 登录 remove 移除 search 搜索 setup 启动
ansible-galaxy install username.role_name     下载到/etc/ansible/roles/功能角色名下
ansible-galaxy install --roles-path . username.role_name
ansible-galaxy install username.role_name,v1.0.0
写yaml，指定不同下载路径，可以同时下载多个role，   也可以定制
ansible-galaxy install -r requirements.yml

ansible-inventory --vars --export --graph  列出主机清单
```

命令执行过程（扩展）

```powershell

```

主机清单

```powershell
远程执行命令，先ssh免密
ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ''
ssh-copy-id root@localhost
[组名]          不允许有-
主机
10.0.0.x      可以指定python版本

[组名:子组]

匹配所有：all
正则匹配：*(通配符)
逻辑或：:(并集)，一般用于主机组
逻辑与：:&(交集)，一般用于主机组
逻辑非：:!(补集)，一般用于主机组
```

常用模块（shell没有幂等性，做个条件判断就完事了）

日常命令及系统管理

```powershell
ping：				ansible ip/*(all)/组 -m ping -o/vv/vvv
command最简单的命令：	ansible localhost -a "chdir=/home ls -a"
shell：				ansible 10.0.0.12 -m shell -a 'export HAHA=NIHAO; ...'
hostname：			ansible 10.0.0.16 -m hostname -a "name=ansible-node2"

user操作用户模块：		ansible 10.0.0.16 -m user -a "name=webapp system=yes groups=root,bin uid=10086 comment='webapp' shell=/sbin/nologin home=/tmp/webapp state=present password=123456"               remove

group：				ansible 10.0.0.16 -m group -a "name=webap system=yes gid=10088"                  state=absent删除

cron：				ansible 10.0.0.16 -m cron -a 'name="custom job" minute=*/1 hour=* day=* month=* weekday=* job="/usr/sbin/ntpdate time1.aliyun.com"'
					 ansible 10.0.0.16 -m cron -a 'disabled=yes name="custom job" job="/usr/sbin/ntpdate time1.aliyun.com"'         禁用，no为启用

setup收集目标主机信息：	ansible 10.0.0.16 -m setup   详细主机属性信息
    ansible 10.0.0.16 -m setup -a "filter=*ens*"  网卡

selinux：selinux 机制进行管理
mount：管理远程主机的挂载
sysctl模块：修改远程主机上的内核参数
```

文件管理

```powershell
copy(本地到远程)：		ansible 10.0.0.16 -m copy -a "src=/tmp/script.sh dest=/tmp/tpircs.sh backup=yes"       源文件是目录的话，则必须携带/后缀

fetch(远程到本地)：		ansible 10.0.0.16 -m fetch -a "src=/tmp/tpircs.sh dest=/tmp"          只支持拉单个文件

file：				   ansible 10.0.0.16 -m file -a "path=/file/file.txt owner=daemon mode=666"

Get_url：将文件从http、https或ftp下载到被管理机节点上
archive：用于打包压缩保存在被管理节点
unarchive：			   ansible 10.0.0.16 -m unarchive -a 'src=/root/passwd.tar.gz dest=/data/passwd'     本机压缩包解压至远程

Lineinfile：替换
Replace：替换
```

软件模块

```powershell
yum/apt：				ansible 10.0.0.16 -m apt -a "name=nginx,mariadb-server,redis-server state=present"         
						 ansible 10.0.0.12 -m yum -a 'name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/6.0/rhel/8/x86_64/zabbix-agent-6.0.0-1.el8.x86_64.rpm state=present validate_certs=no disable_gpg_check=yes'

apt_repository：配置远程客户端主机上的软件源信息
apt_key：apt 仓库的key 的配置管理
yum_repository

service：				 ansible 10.0.0.16 -m service -a 'name=nginx enabled=yes state=started '      restarted/reloaded/stopped
```

信息模块

```powershell
debug：msg相当于echo:          # 打印自定义消息
       var看变量是否存在:       # 调试变量名称，与msg互斥  
       verbosity:             # 显示更详细信息
```

## 1.2playbook

```powershell
语法检查
ansible-playbook 01-ubuntu-install-httpd.yaml --syntax-check
文件执行
ansible-playbook 01-ubuntu-install-httpd.yaml -v
ansible-playbook -l 10.0.0.12  指定执行

配置文件变了，任务yaml没变，再次执行的时候，不会执行里面的指令，需要notify和handlers

ansible-playbook --list-tags 05-playbook-nginx-mulhandler.yml
ansible-playbook --tags copyconfig 06-playbook-nginx-tags.yml 只执行copyconfig任务，一个标签对应可以多个任务（执行）


```

基本样式

```powershell
- hosts: 10.0.0.13                     跟ansible后面的写法一模一样
  remote_user: root
  vars_files:
  - vars.yaml				变量文件
  vars:                     定义变量
  - head: www
  - hostid: node
  - tail: ansible.top
  tasks:
  - name: hello world                  任务名
    command: echo "hello world"        模块(-m):操作/属性=值(-a)
    tags:    对不同对象打标签，比如这里可以根据标签名只执行这一个任务，常用于主机/任务
      - hello world
    when: ansible_os_family == "RedHat"   如：(条件 and 条件) or (条件 and 条件)
    
  - name: extra vars
    shell: getend passwd | grep nginx-test || /bin/true   相当于ignore_errors
    ignore_errors: True
  
  - name: set hostname
    hostname: name={{ head }}.{{ hostid }}.{{ tail }}  使用变量
    register: os_info         任务执行的所有信息都保存在这里
  - name: print debug message
    debug: msg=" {{ os.info }} "
 
  - name: copy config
    template: src=./templates/nginx-define.conf.j2   dest=/etc/nginx/conf.d/nginx-define.conf       使用template替换copy
    notify:      注意:notify是任务下的，执行任务必执行notify
    - restart nginx 
    - check nginx  
  handlers: # 定义触发器任务列表
  - name: restart nginx # 定义具体触发动作
    service: name=nginx status=restarted # 触发动作的详情
  - name: check nginx
    shell: netstat -tnulp | grep nginx > /tmp/nginx.test    
```

示例

```powershell
多台部署nginx并配置可访问，安装，将本台机器写好的配置文件分发到各nginx，直接问AI要一整套
部署mysql环境，清理mysql环境
```

变量

```powershell
主机清单
公共(组)变量：
[web_group:vars]
hostname=www

普通变量：10.0.0.16 hostid=master nginx_port=81

ansible -e '变量1 变量2'

直接在playbook.yml定义
```

模版

```powershell
作用：动态生成配置文件或脚本
nginx-define.conf.j2

{% for vhost in  nginx_vhosts %}
server {
    如果定义了port就传入，如果没有就没这一行
    {%if listen_port is defined %}    
    listen {{ listen_port }};
    {% endif %}
    {%if server_name is defined %}
    server_name {{ server_name }};
	{% endif %}
	
    location / {
        proxy_pass http://{{ backend_host }}:{{ backend_port }};
    }
}
{% endfor %}

- name: 生成 nginx 配置文件
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  vars:
    nginx_vhosts:
      - vhost1:
        listen_port: 81
        name: "vhost1.sswang.com"
      - vhost2:
        listen_port: 82
      - vhost3:
        server_name: "vhost3.sswang.com"
#    listen_port: 80
#    server_name: example.com
#    backend_host: 10.0.0.5
#    backend_port: 8080
```

迭代管理

```powershell
- hosts: web
  remote_user: root
  tasks:
    - name: copy file
      copy: src={{ item }} dest=/tmp/{{ item }}
      with_items:          相当于for循环
        - file1
        - file2
        - file3
  tasks:
    - name: add some group
      user: name={{ item }} state=present
      with_items:
        - group1
        - group2
        - group3
    - name: add some users
      user: name={{ item.name }} group={{ item.group}} state=present
      with_items:
      - { name: 'user1', group: 'group1' }
      - { name: 'user2', group: 'group2' }
      - { name: 'user3', group: 'group3' }
```

## 1.3Role

```powershell
ansible-galaxy命令操作的对象，就是roles。
本质上就是对playbook的解耦
劣势：场景限制，维护成本，学习成本

目录结构
role角色目录结构及其作用
/path/to/roles/ 项目角色目录
    role1/ 子角色目录
        files/
            xxx.yaml 任务剧本 - 实现拆分后的子任务的playbook文件
            main.yaml 整合文件 - 通过include语句将本目录下所有剧本文件进行整合
        conf/
        templates/ 模板目录 - template模块依赖的模板文件,结构同上
        tasks/ 任务目录 - role的核心元素，有所有任务playbook文件组成
            xxx.yaml 任务剧本 - 实现拆分后的子任务的playbook文件
            main.yaml 整合文件 
        handlers/ 关联目录 - 存放各种触发器任务文件，结构同上
        vars/ 变量目录 - 存放各种变量文件，结构同上
        meta/ 数据目录 - 设定角色的特殊设定及其依赖关系，结构同上
        default/ 默认目录 - 一些基础的配置文件，比如默认变量、默认配置等内容，结构同上 
```

项目结构

```powershell
/data/ansible/role/nginx_pro/roles/role_nginx/{tasks,templates,nginx_conf,vars,handlers}
```

变量

```powershell
roles/role_nginx/vars/main.yaml
server_name: ansible_nodename
pre_name: www.
tail_name: .com
```

触发器

```powershell
roles/role_nginx/handlers/main.yaml
- name: restart nginx 
  service: name=nginx state=restarted
```

任务

```powershell
完善configs任务的通知功能  roles/role_nginx/tasks/configs.yaml
- name: copy subconfig
  template: src=templates/nginx-define.conf.j2 dest=/etc/nginx/conf.d/nginx-define.conf
  notify: restart nginx
```

子任务整合

```powershell
vim roles/role_nginx/tasks/main.yaml
- include_tasks: groups.yaml
- include_tasks: users.yaml
- include_tasks: packages.yaml
- include_tasks: configs.yaml
- include_tasks: services.yaml
- include_tasks: ../handlers/main.yaml  触发器 notify写tasks的yaml中
```

启动yaml

```powershell
vim nginx_role.yaml
- hosts: web
  remote_user: root
  vars:               完成循环变量任务
    nginx_vhosts:
      - vhost1:
        listen_port: 81
        name: "vhost1.sswang.com"
      - vhost2:
        listen_port: 82
      - vhost3:
        server_name: "vhost3.sswang.com"
  roles:
    - role: role_nginx     标准写法  导入roles目录下面的role_nginx目录
    - nginx       精简
     - { role: role_nginx, nginx_port: 8888, when: ansible_hostname == 'top-node', tags: ['nginx', 'web'] }   变量、条件
检查并执行
cd /data/ansible/role/nginx_pro
ansible-playbook nginx_role.yaml -C
ansible-playbook -t nginx nginx_role.yaml    -t指定标签
```

示例

```powershell
基于Role实现LNMP
部署kafka
```

## 1.4生产策略

**全容器化 + GitOps**（CI/CD 构建镜像 → Git 仓库保存 YAML → Argo CD/Flux 自动同步）→ **基本不需要 Ansible**。

百台规模

```powershell
Ansible 默认并发数较低，可通过修改 ansible.cfg 中的 forks 参数来提高并发数。初始可设置为 50 - 100
确保控制节点有足够的 CPU、内存和网络带宽。建议至少 4 核 CPU、16GB 内存以及高速稳定的网络连接。
```

千台规模

```powershell
forks 参数可设置为 100 - 200
使用 serial 参数对主机进行分批处理，减轻网络和系统压力
- name: 分批执行任务
  hosts: all
  serial: 50
  
事实收集优化：
 启用事实缓存，减少重复的事实收集操作。可以在 ansible.cfg 中配置缓存插件和有效期。
 [defaults]
    fact_caching = jsonfile
    fact_caching_connection = /tmp/ansible_facts_cache
    fact_caching_timeout = 3600
    
分布式控制
```

五千台规模

```powershell
除了调整 forks 和 serial 参数，还可以使用 Ansible Tower 或 AWX 等自动化平台来实现更精细的并发控制和任务调度。
最少8 核 CPU、32GB
异步执行
    - name: Asynchronous task
      command: long_running_command
      async: 3600            # 任务最大运行时间（秒）
      poll: 0                # 0 表示不轮询，直接放后台，不获取结果，10为每10秒轮询一次
```

备份恢复

```powershell
cp tar rsync
```

重试机制

```powershell
- name: 重试任务
  command: some_command
  retries: 3
  delay: 5             就像kubeasz项目，服务起来没起来
```

故障转移

```powershell
通过逻辑判断实现
```

日志管理

```powershell
[defaults]
    log_path = /var/log/ansible.log
    display_skipped_hosts = True
    display_ok_hosts = True
```

## 1.5与terraform的区别

| 维度     | Terraform（IaC）                          | Ansible                  |
| -------- | ----------------------------------------- | ------------------------ |
| 类型     | 基础设施编排工具                          | 配置管理工具             |
| 思路     | 声明式（期望状态）                        | 过程式（执行步骤）       |
| 幂等     | 高（有 state）                            | 中（依赖模块）           |
| 执行方式 | API 调用                                  | SSH/WinRM                |
| 典型用途 | 建服务器、配网络、挂存储、建集群          | 装软件、改配置、部署应用 |
| 最佳组合 | **先 Terraform 建机器 → 再 Ansible 部署** |                          |

# 2.jumpserver
